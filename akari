#!/usr/bin/env node
(e=>{const t={};!function s(r){return r in t||(t[r]={},e[r](t[r],s)),t[r]}(".")})({".":(e,t)=>{const s=t("config"),r=t("tools/admin"),n=t("targets/self"),o=t("targets/core"),a=t("targets/public"),i=t("targets/static"),c=t("targets/app-server"),l=t("targets/app-client");function p(e){if(s.config.apps.includes(e))return e;console.log("unknown app name"),process.exit(1)}function u(e){e.then((e=>process.exit(e?0:1)))}process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}));const d=[process.argv[2],process.argv[3]].filter((e=>e)).join(" ");"self"==d?(0,n.build)():"public"==d?(0,a.build)():"core"==d?(0,o.build)(!1):"watch core"==d?(0,o.build)(!0):"home"==d?(0,i.build)("home",!1):"watch home"==d?(0,i.build)("home",!0):"user"==d?(0,i.build)("user",!1):"watch user"==d?(0,i.build)("user",!0):/^\w+-client/.test(d)?(0,l.build)(p(d.slice(0,-7)),!1):/^\w+-server/.test(d)?(0,c.build)(p(d.slice(0,-7)),!1):/^\w+-both/.test(d)?((0,l.build)(p(d.slice(0,-5)),!1,"c"),(0,c.build)(p(d.slice(0,-5)),!1,"s")):/^watch \w+-client/.test(d)?(0,l.build)(p(d.slice(6,-7)),!0):/^watch \w+-server/.test(d)?(0,c.build)(p(d.slice(6,-7)),!0):/^watch \w+-both/.test(d)?((0,l.build)(p(d.slice(6,-5)),!0,"c"),(0,c.build)(p(d.slice(6,-5)),!0,"s")):"service start"==d?u(r.admin.service("start")):"service stop"==d?u(r.admin.service("stop")):"service status"==d?u(r.admin.service("status")):"service restart"==d?u(r.admin.service("restart")):"stop-self-host"==d?u(r.admin.selfhost("stop")):"signup enable"==d?u(r.admin.core({type:"auth",sub:{type:"enable-signup"}})):"signup disable"==d?u(r.admin.core({type:"auth",sub:{type:"disable-signup"}})):/^active-user \d+$/.test(d)?u(r.admin.core({type:"auth",sub:{type:"activate-user",userId:parseInt(d.slice(12))}})):/^inactive-user \d+$/.test(d)?u(r.admin.core({type:"auth",sub:{type:"inactivate-user",userId:parseInt(d.slice(14))}})):/^reload-static [\w\\\.]+$/.test(d)?u(r.admin.core({type:"content",sub:{type:"reload-static",key:d.slice(14)}})):/^disable-static [\w\\\.]+$/.test(d)?u(r.admin.core({type:"content",sub:{type:"disable-static",key:d.slice(15)}})):/^enable-static [\w\\\.]+$/.test(d)?u(r.admin.core({type:"content",sub:{type:"enable-static",key:d.slice(14)}})):"disable-source-map"==d?u(r.admin.core({type:"content",sub:{type:"disable-source-map"}})):"enable-source-map"==d?u(r.admin.core({type:"content",sub:{type:"enable-source-map"}})):(console.log("unknown command"),process.exit(1))},config:(e,t)=>{const s=require("fs");e.config=new class{values;items;apps;domain;webroot;codebook;ssh;constructor(){this.values=JSON.parse(s.readFileSync("akaric","utf-8")),this.values=Object.fromEntries(Object.entries(this.values).map((([e,t])=>[e,Array.isArray(t)||"object"==typeof t?JSON.stringify(t):t]))),this.items=Object.entries(this.values).map((([e,t])=>e==["APP","NAMES"].join("_")?{name:e,value:`[${t.split(",").map((e=>`'${e}'`)).join(", ")}]`}:{name:e,value:t})),this.apps=this.values[["APP","NAMES"].join("_")].split(","),this.domain=this.values[["domain","com"].join(".")],this.webroot=this.values[["WEB","ROOT"].join("")],this.codebook=this.values[["CODE","BOOK"].join("")],this.ssh={user:this.values[["SSH","USER"].join("-")],identity:this.values[["SSH","IDENTITY"].join("-")],passphrase:this.values[["SSH","PASSPHRASE"].join("-")]}}}},"tools/admin":(e,t)=>{const s=require("crypto"),r=require("fs"),n=require("https"),o=require("chalk"),a=t("common"),i=t("config"),c=t("tools/ssh");let l=null;async function p(){if(!l){const e=await(0,c.download)("akariv",!0);if(!e)return(0,a.logCritical)("adm","cannot connect akari (server) (1)");const t=e[0].data.toString();if(l=t.split(":").map((e=>parseInt(e))),3!=l.length||l.some((e=>!e)))return(0,a.logCritical)("adm","cannot connect akari (server) (2)")}return l}const u=r.readFileSync(i.config.codebook,"utf-8"),d=(e,t)=>new Promise((r=>{const c=`adm${t??""}`,l=JSON.stringify(e);p().then((t=>{const p=s.scryptSync(u.slice(t[1],32),u.slice(t[2],32),32),d=s.randomFillSync(new Uint8Array(16)),m=s.createCipheriv("aes-256-cbc",p,d),f=[];m.on("data",(e=>f.push(Buffer.from(e)))),m.write(l),m.end();const h=Buffer.concat(f).toString("hex"),y=Buffer.from(d).toString("hex")+h,g=n.request({host:i.config.domain,method:"POST",port:t[0]});g.on("error",(e=>{"ECONNREFUSED"==e.code?(0,a.logError)(c,"cannot connect akari (server)"):(0,a.logError)(c,`request error ${e.message}`,e),r(!1)})),g.on("socket",(e=>{e.on("error",(()=>{r(!1)})),g.write(y),g.end()})),g.on("response",(t=>{if(200!=t.statusCode)(0,a.logError)(c,`response ${t.statusCode}`),r(!1);else if("service"==e.target)t.pipe(process.stdout),t.on("end",(()=>r(!0)));else if("self-host"==e.target){if("stop"==e.data)t.on("data",(()=>{})),t.on("end",(()=>{(0,a.logInfo)(c,o`ack stop watch core`),r(!0)}));else if("start"==e.data){let e=!1,s=Buffer.alloc(0);t.on("data",(n=>{if(!e){if(s=Buffer.concat([s,Buffer.from(n)]),s.length<4)return;{e=!0;const n=s.slice(0,4).toString();"that"==n?((0,a.logInfo)(c,o`ack {yellow restart watch core}`),r(!0)):"this"==n?(process.stdout.write(s.slice(4)),t.pipe(process.stdout)):((0,a.logError)(c,`start watch core received unexpected header ${n}`),r(!1))}}})),t.on("end",(()=>r(!0)))}}else{let s="";t.on("data",(e=>{s+=e})),t.on("end",(()=>{s=="ACK "+l?((0,a.logInfo)(c,o`{cyan ACK} {yellow ${(0,a.formatAdminPayload)(e)}}`),r(!0)):((0,a.logError)(c,"unexpected response "+s),r(!1))}))}}))}))}));e.admin=new class{get port(){return p().then((e=>e[0]))}core(e,t){return d({target:"core",data:e},t)}devpage(e,t){return d({target:"dev-page",data:e},t)}selfhost(e,t){return d({target:"self-host",data:e},t)}service(e,t){return d({target:"service",data:e},t)}}},"targets/self":(e,t)=>{const s=require("fs"),r=require("chalk"),n=t("common"),o=t("tools/eslint"),a=t("tools/ssh"),i=t("tools/typescript"),c=t("tools/mypack"),l={base:"normal",entry:["script/index.ts","script/index-server.ts"],sourceMap:"no",watch:!1};e.build=async function(){(0,n.logInfo)("akr",r`{cyan self}`),await(0,o.eslint)("self","node","script/**/*.ts");const e=(0,i.typescript)(l).check();if(!e.success)return(0,n.logCritical)("akr",r`{cyan self} failed at transpile`);await Promise.all([(async()=>{const t=await(0,c.mypack)((o=e.files,{type:"app",entry:"/vbuild/index.js",files:o,output:"akari",minify:!0,shebang:!0,cleanupFiles:!1}),"(1)").run();var o;if(!t.success)return(0,n.logCritical)("akr",r`{cyan self} failed at pack (1)`);s.writeFileSync("akari",t.resultJs)})(),(async()=>{const t=await(0,c.mypack)((s=e.files,{type:"app",entry:"/vbuild/index-server.js",files:s,minify:!0,shebang:!0,cleanupFiles:!1}),"(2)").run();var s;if(!t.success)return(0,n.logCritical)("akr",r`{cyan self} failed at pack (2)`);const o=await(0,a.upload)((e=>[{data:e.resultJs,remote:"akari",mode:511}])(t));return o?void 0:(0,n.logCritical)("akr",r`{cyan self} failed at upload`)})()]),(0,n.logInfo)("akr",r`{cyan self} completed successfully`)}},"targets/core":(e,t)=>{const s=require("chalk"),r=t("common"),n=t("tools/admin"),o=t("tools/eslint"),a=t("tools/ssh"),i=t("tools/typescript"),c=t("tools/mypack"),l=e=>({base:"normal",entry:"src/core/index.ts",sourceMap:"hide",watch:e}),p=e=>({type:"app",files:e,entry:"/vbuild/core/index.js",sourceMap:!0,output:"index.js",printModules:!0,minify:!0}),u=e=>[{remote:"index.js",data:e.resultJs},{remote:"index.js.map",data:e.resultMap}];async function d(){(0,r.logInfo)("akr",s`{cyan core}`),await(0,o.eslint)("core","node",["src/shared/**/*.ts","src/core/**/*.ts"]);const e=(0,i.typescript)(l(!1)).check();if(!e.success)return(0,r.logCritical)("akr",s`{cyan core} failed at check`);const t=await(0,c.mypack)(p(e.files)).run();if(!t.success)return(0,r.logCritical)("akr",s`{cyan core} failed at pack`);if(!await(0,a.upload)(u(t)))return(0,r.logCritical)("akr",s`{cyan core} failed at upload`);(0,r.logInfo)("akr",s`{cyan core} completed successfully`)}function m(){(0,r.logInfo)("akr",s`watch {cyan core}`);const e=(0,c.mypack)(p([]));(0,i.typescript)(l(!0)).watch((async({files:t})=>{e.options.files=t;const s=await e.run();s.success&&s.hasChange&&(await(0,a.upload)(u(s)),n.admin.selfhost("start"))})),process.on("SIGINT",(()=>{n.admin.selfhost("stop").then((()=>process.exit()))}))}e.build=function(e){(e?m:d)()}},"targets/public":(e,t)=>{const s=require("fs"),r=require("path"),n=require("chalk"),o=t("common"),a=t("tools/ssh");async function i(e,t){return await Promise.all((await s.promises.readdir(t,{withFileTypes:!0})).map((async n=>{const o=r.join(t,n.name);n.isDirectory()?await i(e,o):e.push({remote:o.replace("src/",""),data:await s.promises.readFile(o)})}))),e}e.build=async function(){(0,o.logInfo)("akr",n`{cyan public}`),await(0,a.upload)(await i([],"src/public")),(0,o.logInfo)("akr",n`{cyan public} complete`)}},"targets/static":(e,t)=>{const s=require("fs"),r=require("chalk"),n=t("common"),o=t("config"),a=t("tools/admin"),i=t("tools/eslint"),c=t("tools/ssh"),l=t("tools/sass"),p=t("tools/typescript"),u=(e,t)=>"user"==e?{base:"jsx-page",entry:`src/static/${e}.tsx`,sourceMap:"no",watch:t}:{base:"normal",entry:`src/static/${e}.ts`,additionalLib:["dom"],sourceMap:"no",watch:t},d=e=>({entry:`src/static/${e}.sass`}),m=(e,t)=>"html"==t?{remote:`static/${e}.html`,data:Buffer.from(s.readFileSync(`src/static/${e}.html`,"utf-8").replaceAll(["domain","com"].join("."),o.config.domain))}:"files"in t?{remote:`static/${e}.js`,data:Buffer.from(t.files[0].content)}:{remote:`static/${e}.css`,data:t.resultCss};function f(e){const t=e.files[0].content,s=`const ${/import React, (?<pat>{[\w\s,]+}) from 'react';/.exec(t).groups.pat} = React;`;let r=t.slice(t.indexOf("\n",t.indexOf("\n",t.indexOf("\n")+1)+1)+1);r=r.replaceAll(/_jsxs?\(_Fragment, /g,"myjsxf(").replaceAll(/_jsxs?/g,"myjsx"),e.files[0].content=s+"function myjsx(type,rawprops,maybekey){const props={};for(const n in rawprops){if(!['key','ref','__self','__source'].includes(n)){props[n]=rawprops[n]}}return{$$typeof:Symbol.for('react.element'),type,key:rawprops.key!==void 0?''+rawprops.key:maybekey!==void 0?''+maybekey:null,ref:rawprops.ref!==void 0?rawprops.ref:null,props,_owner:React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner.current}}function myjsxf(p,k){return myjsx(Symbol.for('react.fragment'),p,k)}\n"+r}async function h(e){(0,n.logInfo)("akr",r`{cyan ${e}-page}`);const t=[m(e,"html")],o=(0,p.typescript)(u(e,!1));if(s.existsSync(o.options.entry)){await(0,i.eslint)(`${e}-page`,"browser",o.options.entry);const s=o.check();if(!s.success)return(0,n.logCritical)("akr",r`{cyan ${e}-page} failed at check`);o.options.entry.endsWith("tsx")&&f(s),t.push(m(e,s))}const h=(0,l.sass)(d(e));if(s.existsSync(h.options.entry)){const s=await h.transpile();if(!s.success)return(0,n.logCritical)("akr",r`{cyan ${e}-page} failed at transpile`);t.push(m(e,s))}if(!await(0,c.upload)(t))return(0,n.logCritical)("akr",r`{cyan ${e}-page} failed at upload`);if(!await a.admin.core({type:"content",sub:{type:"reload-static",key:e}}))return(0,n.logCritical)("akr",r`{cyan ${e}-page} failed at reload`);(0,n.logInfo)("akr",r`{cyan ${e}-page} completed succesfully`)}function y(e){(0,n.logInfo)("akr",r`watch {cyan ${e}-page}`);const t=(0,n.watchvar)((()=>{a.admin.core({type:"content",sub:{type:"reload-static",key:e}})}),{interval:2021}),o=(0,p.typescript)(u(e,!0));s.existsSync(o.options.entry)&&o.watch((async s=>{o.options.entry.endsWith("tsx")&&f(s),(0,n.logInfo)("tsc","completed with no diagnostics"),await(0,c.upload)(m(e,s))&&t()}));const i=(0,l.sass)(d(e));s.existsSync(i.options.entry)&&i.watch((async s=>{await(0,c.upload)(m(e,s))&&t()}));const h=(0,n.watchvar)((async()=>{(0,n.logInfo)("htm","reupload"),await(0,c.upload)(m(e,"html"))&&t()}),{interval:2021,initialCall:!0}),y=`src/static/${e}.html`;(0,n.logInfo)("htm",r`watch {yellow ${y}}`),s.watch(y,{persistent:!1},h)}e.build=function(e,t){(t?y:h)(e)}},"targets/app-server":(e,t)=>{const s=require("chalk"),r=t("common"),n=t("tools/admin"),o=t("tools/eslint"),a=t("tools/codegen"),i=t("tools/ssh"),c=t("tools/typescript"),l=t("tools/mypack"),p=(e,t)=>({base:"normal",entry:`src/${e}/server/index.ts`,sourceMap:"hide",watch:t}),u=(e,t)=>({type:"lib",entry:`/vbuild/${e}/server/index.js`,files:t,sourceMap:!0,output:`${e}/server.js`,printModules:!0,minify:!0}),d=(e,t)=>[{remote:`${e}/server.js`,data:t.resultJs},{remote:`${e}/server.js.map`,data:t.resultMap}];async function m(e){(0,r.logInfo)("akr",s`{cyan ${e}-server}`),await(0,o.eslint)(`${e}-server`,"node",["src/shared/**/*.ts",`src/${e}/server/**/*.ts`]);if(!(await(0,a.codegen)(e,"server").generate()).success)return(0,r.logCritical)("akr",s`{cyan ${e}-server} failed at code generation`);const t=(0,c.typescript)(p(e,!1)).check();if(!t.success)return(0,r.logCritical)("akr",s`{cyan ${e}-server} failed at check`);const m=await(0,l.mypack)(u(e,t.files)).run();if(!m.success)return(0,r.logCritical)("akr",s`{cyan ${e}-server} failed at pack`);if(!await(0,i.upload)(d(e,m)))return(0,r.logCritical)("akr",s`{cyan ${e}-server} failed at upload`);if(!await n.admin.core({type:"auth",sub:{type:"reload-server",app:e}}))return(0,r.logCritical)("akr",s`{cyan ${e}-server} failed at reload`);(0,r.logInfo)("akr",s`{cyan ${e}-server} complete successfully`)}function f(e,t){(0,r.logInfo)(`akr${t??""}`,s`watch {cyan ${e}-server}`),(0,a.codegen)(e,"server",t).watch();const o=(0,l.mypack)(u(e,[]),t);(0,c.typescript)(p(e,!0),t).watch((async({files:s})=>{o.updateFiles(s);const r=await o.run();r.success&&r.hasChange&&await(0,i.upload)(d(e,r),{additionalHeader:t})&&await n.admin.core({type:"auth",sub:{type:"reload-server",app:e}},t)}))}e.build=function(e,t,s){(t?f:m)(e,s)}},"targets/app-client":(e,t)=>{const s=require("fs"),r=require("path"),n=require("zlib"),o=require("chalk"),a=require("dayjs"),i=require("filesize"),c=require("memfs"),l=require("terser-webpack-plugin"),p=require("unionfs"),u=require("webpack"),d=t("common"),m=t("config"),f=t("tools/admin"),h=t("tools/eslint"),y=t("tools/codegen"),g=t("tools/ssh"),w=t("tools/sass"),$=t("tools/typescript"),b=(e,t)=>({base:"jsx-app",entry:`src/${e}/client/index.tsx`,sourceMap:"normal",watch:t}),v=e=>({entry:`src/${e}/client/index.sass`}),k=(e,t)=>Object.entries(t.assets).map((t=>({remote:`${e}/${t[0]}`,data:t[1].data}))),x="AKARIN_APP_CLIENT_OSIZE",S=x in process.env?"0"===process.env[x]?0:parseInt(process.env[x])||2:2;function j(e,t,a,i){(0,d.logInfo)(`wpk${i}`,o`${a?"watch":"once"} {yellow src/${e}/client/index.js}`);const m=u((e=>({mode:"development",entry:{client:r.resolve("src",e,"client","index.js")},module:{rules:[{test:/\.js$/,exclude:/node_modules/,enforce:"pre",use:["source-map-loader"]}]},output:{filename:"client.js",path:"/vbuild",pathinfo:!1},devtool:!1,cache:{type:"filesystem",name:`webpack-akari-${e}`,cacheDirectory:r.resolve(".cache")},performance:{hints:!1},optimization:{moduleIds:"deterministic",chunkIds:"deterministic",mangleExports:"deterministic",innerGraph:!0,usedExports:!0,emitOnErrors:!1,flagIncludedChunks:!0,concatenateModules:!0,nodeEnv:"production",splitChunks:{hidePathInfo:!0,cacheGroups:{1:{test:/node_modules\/react-dom/,priority:20,chunks:"all",filename:"client-vendor1.js"},2:{test:/node_modules\/(rc|@ant-design)/,priority:20,chunks:"all",filename:"client-vendor2.js"},3:{test:/node_modules\/(antd|lodash)/,priority:20,chunks:"all",filename:"client-vendor3.js"},4:{test:/node_modules/,priority:10,chunks:"all",filename:"client-vendor4.js"}}},minimize:0!=S,minimizer:[new l({terserOptions:{format:{comments:!1},compress:2==S},extractComments:!1})]},plugins:[new u.SourceMapDevToolPlugin({exclude:/vendor/,filename:"[name].js.map"})]}))(e)),f={assets:{}};return m.inputFileSystem=(new p.Union).use(s).use(t),m.outputFileSystem=c.createFsFromVolume(new c.Volume),m.hooks.emit.tap("CompressSizePlugin",(e=>{for(const t of e.getAssets())f.assets[t.name]={data:Buffer.from(t.source.buffer()),compressSize:n.brotliCompressSync(t.source.buffer()).length}})),[m,f]}function I(e,t,r){r=r??"";const n=`/tmp/akari-stats-${a().format("YYYYMMDD-HHmmss")}.txt`,c=e=>t.assets[e].compressSize,l=i(e.assets.reduce(((e,t)=>e+t.size),0)),p=i(e.assets.reduce(((e,t)=>e+c(t.name)),0)||0),u=e.assets.filter((e=>e.name.includes("vendor"))).reduce(((e,t)=>Math.max(e,c(t.name))),0);if(0==e.errorsCount){if((0,d.logInfo)(`wpk${r}`,o`completed with {yellow ${e.assets.length}} assets in ${e.time/1e3}s, `+o`{yellow ${p}} ({${u>3e5?"red":"white"} max ${i(u||0)}})`),e.warningsCount>0){(0,d.logInfo)(`wpk${r}`,o`{yellow ${e.warningsCount}} warnings`);for(const{message:t}of e.warnings)console.log("  "+t)}}else{(0,d.logError)(`wpk${r}`,o`completed with {red ${e.errorsCount}} errors, stat file {yellow ${n}}`);for(const{message:t}of e.errors)(0,d.logError)(`wpk${r}`,t)}let m="";const f=["entry","rendered","initial","recorded"],h=["built","codeGenerated","cached","cacheable","optional","prefetched"];if(m+=`hash ${e.hash} time ${e.time}ms total size ${l} (${p})\n`,e.warningsCount){m+=`${e.warningsCount} warnings:\n`;for(const t of e.warnings)m+=JSON.stringify(t,void 0,1)+"\n"}if(e.errorsCount){m+=`${e.errorsCount} errors:\n`;for(const t of e.errors)m+=JSON.stringify(t,void 0,1)+"\n"}for(const t of e.assets)m+=`asset ${t.name} size ${i(t.size)} compress ${i(c(t.name))} chunks [${t.chunks.join(",")}] chunkNames [${t.chunkNames.join(",")}]\n`;for(const t of e.chunks){m+=`chunk ${t.id} files [${t.files.join(",")}] size ${i(t.size)} flags [${f.filter((e=>t[e])).join(",")}] ${t.modules.length} chunks\n`;for(const e of t.modules)if(m+=`  module ${e.id} size ${i(e.size)} flags [${h.filter((t=>e[t])).join(",")}] name "${e.name}" identifier "${e.identifier}"\n`,/\+ \d+ modules/.test(e.name)&&e.modules)for(const t of e.modules)m+=`    submodule ${t.name} size ${i(t.size)}\n`}s.writeFileSync(n,m)}async function C(e,t,r,n){const a=`src/${e}/index.html`;r||(0,d.logInfo)(`htm${n??""}`,o`read {yellow ${a}}`);const i=t[0].map((e=>"/"+e)).concat(r?[`https://${e}.${m.config.domain}:${await f.admin.port}/client-dev.js`]:[]),c=(await s.promises.readFile(a,"utf-8")).replace("<script-placeholder />",i.map((e=>`<script type="text/javascript" src="${e}"><\/script>`)).join("\n  ")).replace("<stylesheet-placeholder />",t[1].map((e=>`<link rel="stylesheet" type="text/css" href="/${e}">`)).join("\n  "));return(0,d.logInfo)(`htm${n??""}`,"template rendered"),{remote:`${e}/index.html`,data:Buffer.from(c)}}async function E(e){(0,d.logInfo)("akr",o`{cyan ${e}-client}`),await(0,h.eslint)(`${e}-client`,"browser",[`src/${e}/client/**/*.ts`,`src/${e}/client/**/*.tsx`]);const t=(async()=>{const t=(0,y.codegen)(e,"client");if(s.existsSync(t.definitionFile)){if(!(await t.generate()).success)return(0,d.logCritical)("akr",o`{cyan ${e}-client} failed at codegen`)}const r=(0,$.typescript)(b(e,!1)).check();if(!r.success)return(0,d.logCritical)("akr",o`{cyan ${e}-client} failed at check`);const n=c.Volume.fromJSON(r.files.reduce(((e,t)=>(e[t.name]=t.content,e)),{})),[a,i]=j(e,n,!1,""),l=await new Promise((e=>a.run(((t,s)=>e({error:t,statsObject:s})))));if(l.error)return(0,d.logError)("wpk",JSON.stringify(l.error,void 0,1)),(0,d.logCritical)("akr",o`{yellow ${e}-client} failed at pack (1)`);const p=l.statsObject.toJson();return I(p,i,""),p.errorsCount>0?(0,d.logCritical)("akr",o`{cyan ${e}-client} failed at pack (2)`):(a.close((e=>{e&&(0,d.logError)("wpk","failed to close compiler",e)})),k(e,i))})(),n=(async()=>{const t=await(0,w.sass)(v(e)).transpile();return t.success?[{remote:`${e}/index.css`,data:t.resultCss}]:(0,d.logCritical)("akr",o`{cyan ${e}-client} failed at transpile`)})(),a=await Promise.all([t,n]),i=await C(e,[a[0].map((e=>r.basename(e.remote))).filter((e=>e.endsWith(".js"))),a[1].map((e=>r.basename(e.remote)))],!1);if(!await(0,g.upload)(a[0].concat(a[1]).concat([i]),{filenames:!1}))return(0,d.logCritical)("akr",o`{cyan ${e}-client} failed at upload`);if(!await f.admin.core({type:"content",sub:{type:"reload-static",key:e}}))return(0,d.logCritical)("akr",o`{cyan ${e}-client} failed at reload`);(0,d.logInfo)("akr",o`{cyan ${e}-client} complete successfully`)}function q(e,t){t=t??"",(0,d.logInfo)(`akr${t}`,o`watch {cyan ${e}-client}`);let[n,a]=[[],[]],i=!1;const l=(0,d.watchvar)((async()=>{const s=i;i=!1;const o=await C(e,[n.map((e=>r.basename(e.remote))).filter((e=>e.endsWith(".js"))),a.map((e=>r.basename(e.remote)))],!0,t);n.length>0&&await(0,g.upload)(n.concat(a).concat([o]),{filenames:!1,additionalHeader:t})&&(await f.admin.core({type:"content",sub:{type:"reload-static",key:e}},t),await f.admin.devpage(s?"reload-js":"reload-css",t))})),p=(0,y.codegen)(e,"client",t);s.existsSync(p.definitionFile)&&p.watch();const u=new c.Volume,[m,h]=j(e,u,!0,t);let x=[],S=null;(0,$.typescript)(b(e,!0),t).watch((async({files:s})=>{for(const{name:e,content:t}of s)u.existsSync(e)||e.endsWith(".map")||console.log(o`   + ${e}`),await u.promises.mkdir(r.dirname(e),{recursive:!0}),await u.promises.writeFile(e,t);x=s,m.running?(0,d.logError)(`wpk${t}`,"already repacking, discard"):((0,d.logInfo)(`wpk${t}`,"repack"),m.run(((s,a)=>{if(s)return void(0,d.logError)(`wpk${t}`,"webpack fatal error",s);const c=a.toJson();I(c,h,t),function(e,t,s){const n=[],a=r.resolve("src");for(const t of e.modules)if(/\+ \d+ modules/.test(t.name)&&t.modules)for(const e of t.modules){const t=r.resolve(e.name);t.startsWith(a)&&n.push(t)}else{const e=r.resolve(t.name);e.startsWith(a)&&n.push(e)}const i=t.filter((e=>!n.includes(e.name)&&!n.some((t=>t+".map"==e.name))));for(const e of i)t.splice(t.indexOf(e),1),s.unlinkSync(e.name),e.name.endsWith(".map")||console.log(o`   {gray - ${e.name}}`)}(c,x,u),0==c.errorsCount&&(c.hash!=S?(S=c.hash,n=k(e,h),i=!0,l()):(0,d.logInfo)(`wpk${t}`,o`completed with {gray no change}`),m.close((e=>{e&&(0,d.logError)("wpk","failed to close compiler",e)})))})))})),(0,w.sass)(v(e),t).watch((t=>{a=[{remote:`${e}/index.css`,data:t.resultCss}],l()}))}e.build=function(e,t,s){(t?q:E)(e,s)}},common:(e,t)=>{const s=require("chalk"),r=require("dayjs");function n(e){switch(e.type){case"ping":return"ping";case"shutdown":return"shutdown";case"content":switch(e.sub.type){case"reload-static":return`reload-static ${e.sub.key}`;case"enable-static":return`enable-static ${e.sub.key}`;case"disable-static":return`disable-static ${e.sub.key}`;case"enable-source-map":return"source-map enable";case"disable-source-map":return"source-map disable";default:return`unknown content command ${e}`}case"auth":switch(e.sub.type){case"reload-server":return`reload-server ${e.sub.app}`;case"enable-signup":return"enable-signup";case"disable-signup":return"disable-signup";case"activate-user":return`activate-user ${e.sub.userId}`;case"inactivate-user":return`inactivate-user ${e.sub.userId}`;case"remove-device":return`remove-device ${e.sub.deviceId}`;default:return`unknown auth command ${e}`}default:return`unknown core command ${JSON.stringify(e)}`}}e.logInfo=function(e,t,n){n?console.log(s`[{green ${r().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`,n):console.log(s`[{green ${r().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`)},e.logError=function(e,t,n){n?console.log(s`[{green ${r().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`,n):console.log(s`[{green ${r().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`)},e.logCritical=function(e,t){return console.log(s`[{green ${r().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`),process.exit(1)},e.watchvar=function(e,t){let s=!1;return setInterval((()=>{s&&(s=!1,e())}),t?.interval??3001),t?.initialCall&&e(),()=>s=!0},e.formatAdminCoreCommand=n,e.formatAdminPayload=function(e){switch(e.target){case"core":return n(e.data);case"dev-page":switch(e.data){case"reload-js":return"dev-page reload-js";case"reload-css":return"dev-page reload-css";default:return`unknown dev-page command ${e}`}case"service":switch(e.data){case"start":return"systemctl start";case"status":return"systemctl status";case"stop":return"systemctl stop";case"restart":return"systemctl restart";case"is-active":return"systemctl is-active";default:return`unknown service payload ${e}`}case"self-host":switch(e.data){case"start":return"self-host start core";case"stop":return"self-host stop core";default:return`unknown self-host command ${e}`}default:return`unknown command ${JSON.stringify(e)}`}}},"tools/ssh":(e,t)=>{const s=require("fs"),r=require("path"),n=require("stream"),o=require("chalk"),a=require("ssh2-sftp-client"),i=t("config"),c=t("common"),l={host:i.config.domain,username:i.config.ssh.user,privateKey:s.readFileSync(i.config.ssh.identity),passphrase:i.config.ssh.passphrase};e.upload=async function(e,t){e=Array.isArray(e)?e:[e];const s=new a;for(const t of e)if(!t.data||!Buffer.isBuffer(t.data))return(0,c.logError)("ssh",`${r.basename(t.remote)} invalid data`),!1;try{await s.connect(l);for(const t of e)await s.put(t.data,r.join(i.config.webroot,t.remote),{writeStreamOptions:{mode:t.mode||420}});return await s.end(),(0,c.logInfo)(`ssh${t?.additionalHeader??""}`,o`upload {yellow ${e.length}} files ${t?.filenames?"":e.map((e=>o.yellow(r.basename(e.remote))))}`),!0}catch(e){return(0,c.logError)(`ssh${t?.additionalHeader??""}`,"error "+e.message),!1}},e.download=async function(e,t){e=Array.isArray(e)?e:[e];const s=new a;try{await s.connect(l);const a=[];for(const t of e){const e=[];await s.get(r.join(i.config.webroot,t),new n.Writable({write(t,s,r){e.push(Buffer.from(t,s)),r()}})),a.push({remote:t,data:Buffer.concat(e)})}return await s.end(),t||(0,c.logInfo)("ssh",o`download {yellow ${a.length}} file`),a}catch(e){return(0,c.logError)("ssh","error "+e.message),null}}},"tools/eslint":(e,t)=>{const s=require("eslint"),r=t("common");e.eslint=async function(e,t,n){if(!("AKARIN_ESLINT"in process.env))return;const o=new s.ESLint({useEslintrc:!1,baseConfig:{parser:"@typescript-eslint/parser",parserOptions:{ecmaVersion:2020,sourceType:"module",ecmaFeatures:{jsx:"browser"==t}},plugins:"node"==t?["@typescript-eslint"]:["@typescript-eslint","react","react-hooks","jsx-a11y"],env:{node:"node"==t,browser:"browser"==t},extends:"node"==t?["eslint:recommended","plugin:@typescript-eslint/recommended"]:["eslint:recommended","plugin:@typescript-eslint/recommended","plugin:react/recommended","plugin:react-hooks/recommended","plugin:jsx-a11y/recommended"],settings:"node"==t?{}:{react:{version:"17.0"}},rules:"node"==t?{"array-callback-return":"warn","class-methods-use-this":"error","comma-dangle":"off","eol-last":"error","no-constant-condition":"off","no-multiple-empty-lines":"error","no-extra-parens":"off","no-lone-blocks":"warn","no-sequences":"error","no-template-curly-in-string":"warn","no-trailing-spaces":"error","no-unused-expressions":"off","prefer-named-capture-group":"off","require-await":"error",semi:"off","@typescript-eslint/comma-dangle":["warn","always-multiline"],"@typescript-eslint/consistent-type-imports":"off","@typescript-eslint/explicit-module-boundary-types":["warn",{allowArgumentsExplicitlyTypedAsAny:!0}],"@typescript-eslint/member-delimiter-style":["warn",{multiline:{delimiter:"comma",requireLast:!0},singleline:{delimiter:"comma",requireLast:!1}}],"@typescript-eslint/no-confusing-non-null-assertion":"warn","@typescript-eslint/no-explicit-any":"off","@typescript-eslint/no-non-null-assertion":"off","@typescript-eslint/no-unnecessary-condition":"off","@typescript-eslint/no-unused-expressions":"error","@typescript-eslint/no-var-requires":"off","@typescript-eslint/prefer-includes":"off","@typescript-eslint/prefer-readonly":"off","@typescript-eslint/semi":"error","@typescript-eslint/switch-exhaustiveness-check":"off","@typescript-eslint/triple-slash-reference":"off"}:{"array-callback-return":"warn","class-methods-use-this":"error","comma-dangle":"off","eol-last":"error","jsx-quotes":["error","prefer-single"],"no-constant-condition":"off","no-multiple-empty-lines":"error","no-extra-parens":"off","no-lone-blocks":"warn","no-sequences":"error","no-template-curly-in-string":"warn","no-trailing-spaces":"error","no-unused-expressions":"off","prefer-named-capture-group":"off","require-await":"error",semi:"off","react/display-name":"off","react/jsx-handler-names":"off","react/jsx-no-comment-textnodes":"error","react/jsx-tag-spacing":"warn","react/no-children-prop":"off","react/prop-types":"off","react/self-closing-comp":"error","jsx-a11y/click-events-have-key-events":"off","jsx-a11y/interactive-supports-focus":"off","@typescript-eslint/comma-dangle":["warn","always-multiline"],"@typescript-eslint/consistent-type-imports":"off","@typescript-eslint/explicit-module-boundary-types":["warn",{allowArgumentsExplicitlyTypedAsAny:!0}],"@typescript-eslint/member-delimiter-style":["warn",{multiline:{delimiter:"comma",requireLast:!0},singleline:{delimiter:"comma",requireLast:!1}}],"@typescript-eslint/no-confusing-non-null-assertion":"warn","@typescript-eslint/no-explicit-any":"off","@typescript-eslint/no-non-null-assertion":"off","@typescript-eslint/no-unnecessary-condition":"off","@typescript-eslint/no-unused-expressions":"error","@typescript-eslint/no-var-requires":"off","@typescript-eslint/prefer-includes":"off","@typescript-eslint/prefer-readonly":"off","@typescript-eslint/semi":"error","@typescript-eslint/switch-exhaustiveness-check":"off","@typescript-eslint/triple-slash-reference":"off"}},cache:!0,cacheLocation:`.cache/eslint-${e}`}),a=await o.lintFiles(n),i=(await o.loadFormatter("stylish")).format(a);i?console.log(i):(0,r.logInfo)("esl","clear")}},"tools/typescript":(e,t)=>{const s=require("path"),r=require("typescript"),n=require("chalk"),o=t("common"),a=t("config"),i={lib:["lib.esnext.d.ts"],target:r.ScriptTarget.ESNext,module:r.ModuleKind.CommonJS,moduleResolution:r.ModuleResolutionKind.NodeJs,skipLibCheck:!0,noEmitOnError:!0,strict:"AKARIN_TS_STRICT"in process.env,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictNullChecks:"AKARIN_TS_STRICT"in process.env,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function c({category:e,code:t,messageText:s,file:a,start:i},c){if(6031!=t)if(6032==t)(0,o.logInfo)(`tsc${c}`,"recheck");else{if(6194==t)return;{const o=(0,{[r.DiagnosticCategory.Warning]:n.red,[r.DiagnosticCategory.Error]:n.red,[r.DiagnosticCategory.Suggestion]:n.green,[r.DiagnosticCategory.Message]:n.cyan}[e])(`  TS${t} `);let c="";if(a&&i){const{line:e,character:t}=r.getLineAndCharacterOfPosition(a,i);c=n`{yellow ${a.fileName}:${e+1}:${t+1}} `}let l=r.flattenDiagnosticMessageText(s,"\n");l.includes("\n")&&(l="\n"+l),console.log(o+c+l)}}}function l(){const e=r.sys.readFile;r.sys.readFile=(t,s)=>{let r=e(t,s);if(!t.endsWith(".d.ts"))for(const{name:e,value:t}of a.config.items)r=r.replaceAll(e,t);return r}}function p(e,t){return(s,r)=>{if(s.endsWith(".js")){r.startsWith('"use strict"')&&(r=r.slice(r.indexOf("\n")+1)),r.startsWith("Object.defineProperty")&&(r=r.slice(r.indexOf("\n")+1)),r.startsWith("exports.")&&(r=r.slice(r.indexOf("\n")+1));const t=/\/\/#\s*sourceMappingURL/.exec(r);t&&"hide"==e.sourceMap?r=r.slice(0,t.index):r.endsWith("\n")||(r+="\n")}const n=t.findIndex((e=>e.name==s));n>=0?t.splice(n,1,{name:s,content:r}):t.push({name:s,content:r})}}class u{options;additionalHeader;compilerOptions;constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??"",this.compilerOptions=function(e){return"normal"==e.base?{...i,outDir:"/vbuild",sourceMap:"no"!=e.sourceMap,lib:"additionalLib"in e?[...i.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:i.lib}:"jsx-page"==e.base?{...i,outDir:"/vbuild",target:r.ScriptTarget.ES2018,sourceMap:!1,esModuleInterop:!0,module:r.ModuleKind.ESNext,jsx:r.JsxEmit.ReactJSX,lib:[...i.lib,"lib.dom.d.ts"]}:{...i,outDir:s.resolve("src"),target:r.ScriptTarget.ES2018,sourceMap:!0,esModuleInterop:!0,module:r.ModuleKind.ESNext,jsx:r.JsxEmit.ReactJSX,lib:[...i.lib,"lib.dom.d.ts"]}}(e)}check(){(0,o.logInfo)("tsc",n`once {yellow ${this.options.entry}}`),l();const e=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry],t=[],s=function(e){const t=e.diagnostics.filter((e=>e.category==r.DiagnosticCategory.Error||r.DiagnosticCategory.Warning)).length,s=e.diagnostics.length-t;let a;a=0==s&&0==t?"no diagnostic":0!=s&&0==t?n`{yellow ${s}} infos`:0==s?n`{yellow ${t}} errors`:n`{yellow ${t}} errors and {yellow ${s}} infos`,(e.emitSkipped?o.logError:o.logInfo)("tsc",`completed with ${a}`);for(const t of e.diagnostics)c(t);return!e.emitSkipped}(r.createProgram(e,this.compilerOptions,r.createCompilerHost(this.compilerOptions)).emit(void 0,p(this.options,t)));return{success:s,files:t}}watch(e){(0,o.logInfo)(`tsc${this.additionalHeader}`,n`watch {yellow ${this.options.entry}}`),l();const t=[],s=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry];setImmediate((()=>{r.createWatchProgram(r.createWatchCompilerHost(s,this.compilerOptions,r.sys,((...s)=>{const n=r.createEmitAndSemanticDiagnosticsBuilderProgram(...s),o=n.emit;return n.emit=(s,r,...n)=>{const a=o(s,p(this.options,t),...n);return a.emitSkipped||e({files:t}),a},n}),(e=>c(e,this.additionalHeader)),(e=>c(e,this.additionalHeader))))}))}}e.typescript=function(e,t){return new u(e,t)}},"tools/mypack":(e,t)=>{const s=require("path"),r=require("chalk"),n=require("crypto-js"),o=require("filesize"),a=require("source-map"),i=require("terser"),c=t("common");function l(e){const t=/\n/g,s=[];for(;;){const r=t.exec(e);if(!r)break;s.push(r.index)}return function(e){const t=s.findIndex((t=>t>e));return t<0?`${s.length+1}:${e-(s.length?s[s.length-1]:0)+1}`:0==t?`1:${e}`:`${t+1}:${e-s[t-1]+1}`}}class p{options;lastHash=null;lastModules=null;logHeader;constructor(e,t){this.options=e,this.logHeader=t?`mpk${t}`:"mpk"}updateFiles(e){this.options.files=e}getSources(){return this.options.files.filter((e=>e.name.endsWith(".js"))).map((({name:e,content:t})=>({filename:e,jsContent:t,mapContent:this.options.files.find((t=>t.name==e+".map"))?.content,mapIndex:l(t)})))}processModule(e,t){let r=s.relative(s.dirname(this.options.entry),e.filename);r.endsWith(".js")&&(r=r.slice(0,-3)),r.endsWith("index")&&(r=r.slice(0,-5)),0==r.length&&(r=".");const o=[],a=/require\("(?<request>\.[.\w\-/]*)"\);/g;for(;;){const r=a.exec(e.jsContent);if(!r)break;const n=r.groups.request,i=s.resolve(s.dirname(e.filename),n),l=t.some((e=>e.filename==i))?i:t.some((e=>e.filename==i+".js"))?i+".js":t.some((e=>e.filename==i+"/index.js"))?i+"/index.js":null;if(!l)return(0,c.logError)(this.logHeader,`${e.filename}: invalid module name ${n} at ${e.mapIndex(r.index)}`),null;let p=s.relative(s.dirname(this.options.entry),l);p=p.slice(0,-3),p.endsWith("index")&&(p=p.slice(0,-5)),0==p.length&&(p="."),o.push({index:r.index,raw:n,resolvedFileName:l,resolvedModuleName:p})}let i=0,l="";for(const{index:t,raw:s,resolvedModuleName:r}of o)l+=e.jsContent.slice(i,t),l+=`myimport("${r}");`,i=t+s.length+12;return l+=e.jsContent.slice(i),{name:r,source:e,requests:o,content:l,hash:(0,n.SHA256)(l).toString()}}checkCircularReference(e){const t=[{moduleName:e[0].name,parentFileName:"",parentRequirePosition:"",parentRequireRaw:""}],s=n=>{for(const o of n.requests){const a=e.find((e=>e.name==o.resolvedModuleName));if(t.some((e=>e.moduleName==a.name))){(0,c.logError)(this.logHeader,"circular reference encountered");for(const e of t.slice(1))console.log(r`   {${e.parentFileName==a.source.filename?"yellow":"white"} ${e.parentFileName}}`+r`:${e.parentRequirePosition}:{gray require("}${e.parentRequireRaw}{gray ")}`);throw console.log(r`   ${n.source.filename}:${n.source.mapIndex(o.index)}:{gray require("}{yellow ${o.raw}}{gray ")}`),new Error("circular reference")}t.push({parentFileName:n.source.filename,parentRequirePosition:n.source.mapIndex(o.index),parentRequireRaw:o.raw,moduleName:a.name}),s(a),t.pop()}};try{return s(e[0]),!1}catch(e){if("circular reference"==e.message)return!0;throw e}}emitRuntimePrefix(e,t){this.options.shebang&&(e.sb+="#!/usr/bin/env node\n",e.lineOffset+=1),e.sb+="app"==this.options.type?`((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`:`module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`,e.lineOffset+=2}async emitModule(e,t){if(e.sb+=`'${t.name}': (exports, myimport) => {\n${t.content}}, `,e.lineOffset+=1,e.generator&&!t.source.mapContent){let r=null;(await new a.SourceMapConsumer(JSON.parse(t.source.mapContent))).eachMapping((t=>{null===r&&(r=t.generatedLine),e.generator.addMapping({source:s.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-r+e.lineOffset+1,column:t.generatedColumn}})})),e.lineOffset+=t.content.split("\n").length-1}}emitRuntimePostfix(e){e.sb+="})\n"}printResult(e,t){if((0,c.logInfo)(this.logHeader,r`completed with {yellow 1} asset {yellow ${o(e)}}`),this.options.printModules){const e=this.lastModules;if(e){for(const s of t.filter((t=>!e.some((e=>e.source==t.source.filename)))))console.log(r`  {gray +} ${s.name} ({gray ${s.source.filename}}) ${o(s.content.length)}`);for(const[s]of t.map((t=>[t,e.find((e=>e.source==t.source.filename))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(r`  {gray *} ${s.name} ({gray ${s.source.filename}}) ${o(s.content.length)}`);for(const s of e.filter((e=>!t.some((t=>t.source.filename==e.source)))))console.log(r`  {gray - removed} ${s.name} ({gray ${s.source}})`)}else for(const{name:e,source:s,content:n}of t){const t=s.filename.startsWith("/vbuild/")?s.filename.slice(8):s.filename;console.log(r`   {gray +} ({gray ${t}}) {greenBright ${e}} ${o(n.length)}`)}}}async run(){const e=this.options.entry;(0,c.logInfo)(this.logHeader,this.lastHash?"repack":r`pack {yellow ${e.startsWith("/vbuild/")?e.slice(8):e}}`);const t=this.getSources();if(!t.some((t=>t.filename==e)))return(0,c.logError)(this.logHeader,"invalid entry"),{success:!1};const s=[],o=[e];for(let e=0;e<o.length;++e){const r=this.processModule(t.find((t=>t.filename==o[e])),t);if(!r)return{success:!1};o.push(...r.requests.map((e=>e.resolvedFileName)).filter((e=>!o.includes(e)))),s.push(r)}if(this.checkCircularReference(s))return{success:!1};const l={sb:"",lineOffset:0,generator:this.options.sourceMap?new a.SourceMapGenerator({file:this.options.output}):null};this.emitRuntimePrefix(l,s[0].name);for(const e of s)await this.emitModule(l,e);this.emitRuntimePostfix(l);let p=l.sb,u=l.generator?.toString();if(this.options.minify){const e=await(0,i.minify)(p,{sourceMap:!!this.options.sourceMap&&{content:u,filename:this.options.output,url:this.options.output+".map"},format:{max_line_len:"AKARIN_SELF_MULTILINE"in process.env?120:void 0}});p=e.code,u="object"==typeof e.map?JSON.stringify(e.map):e.map}const d=(0,n.SHA256)(p).toString(),m=d!=this.lastHash;return m?this.printResult(p.length,s):(0,c.logInfo)(this.logHeader,r`completed with {gray no change}`),"cleanupFiles"in this.options&&!this.options.cleanupFiles||function(e,t){const s=t.filter((t=>!e.some((e=>e.source.filename==t.name))&&!e.some((e=>e.source.filename+".map"==t.name))));for(const e of s)t.splice(t.indexOf(e),1),e.name.endsWith(".map")||console.log(r`   {gray - ${e.name}}`)}(s,this.options.files),this.lastHash=d,this.lastModules=s.map((e=>({name:e.name,source:e.source.filename,hash:e.hash}))),{success:!0,hasChange:m,resultJs:Buffer.from(p),resultMap:u?Buffer.from(u):void 0}}}e.mypack=function(e,t){return new p(e,t)}},"tools/sass":(e,t)=>{const s=require("fs"),r=require("chalk"),n=require("sass"),o=t("common");class a{options;additionalHeader;constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??""}transpile=()=>new Promise((e=>{(0,o.logInfo)("css",r`once {yellow ${this.options.entry}}`);const t=process.hrtime.bigint();try{const s=(0,n.compile)(this.options.entry,{style:"compressed"}),r=process.hrtime.bigint();(0,o.logInfo)("css",`completed in ${(r-t)/1000000n}ms`),e({success:!0,resultCss:Buffer.from(s.css,"utf-8")})}catch(t){t instanceof n.Exception?(0,o.logError)("css",`error at ${t.span.url}:${t.span.start.line}:${t.span.start.column}: ${t.message}`):(0,o.logError)("css",`error ${t}`),e({success:!1})}}));watch(e){const t=this.options.entry,a=`css${this.additionalHeader}`;(0,o.logInfo)(a,r`watch {yellow ${t}}`);const i=[];let c="none",l=[t];!function r(){c="running";for(const e of i)e.close();i.splice(0,i.length);let p=[t];const u=process.hrtime.bigint();try{const s=(0,n.compile)(t,{style:"compressed",importers:[{findFileUrl:e=>(p.push(e),new URL(e))}]}),r=process.hrtime.bigint();(0,o.logInfo)(a,`completed in ${(u-r)/1000000n}ms`),e({success:!0,resultCss:Buffer.from(s.css)})}catch(e){e instanceof n.Exception?(0,o.logError)("css",`error at ${e.span.url}:${e.span.start.line}:${e.span.start.column}: ${e.message}`):(0,o.logError)("css",`error ${e}`),p=l}for(const e of p)i.push(s.watch(e,{persistent:!1},(()=>{"running"==c?((0,o.logInfo)(a,"retranspile waiting"),c="pending"):"none"==c&&((0,o.logInfo)(a,"retranspile (1)"),r())})));l=p,"pending"==c?((0,o.logInfo)(a,"retranspile (2)"),r()):"running"==c&&(c="none")}()}}e.sass=function(e,t){return new a(e,t)}},"tools/codegen":(e,t)=>{const s=require("fs"),r=require("chalk"),n=require("xml2json"),o=t("common"),a=["GET","POST","PUT","PATCH","DELETE"],i={GET:"get",POST:"post",PUT:"put",PATCH:"patch",DELETE:"del"},c=["id","number","string","boolean","date","time"],l={id:{pattern:"\\d+",validator:"validateId",tsType:"number"},number:{pattern:"\\d+",validator:"validateNumber",tsType:"number"},string:{pattern:".+",validator:"validateString",tsType:"string"},boolean:{pattern:"(true|false)",validator:"validateBoolean",tsType:"boolean"},date:{pattern:"\\d{6}",validator:"validateDate",tsType:"Dayjs"},time:{pattern:"\\d{12}",validator:"validateTime",tsType:"Dayjs"}},p="//------------------------------------------------------------------------------------\n// This code was generated by a tool.\n//\n// Changes to this file may cause incorrect behavior\n//     and will be lost if the code is regenerated.\n//------------------------------------------------------------------------------------\n\n";const u=e=>`src/${e}/api.xml`;async function d(e){const t=await s.promises.readFile(u(e),"utf-8"),{version:r,api:o}=(0,n.toJson)(t,{object:!0})[`${e}-api`];return{version:r,definitions:o.map(((e,t)=>{const s=e.name;if(!s)throw new Error(`index ${t} api name is required`);const r=e.method;if(!a.includes(r))throw new Error(`api ${s} invalid method`);const n=e.path;if(!n)throw new Error(`api ${s} path is required`);if(!n.startsWith("/"))throw new Error(`api ${s} path should be absolute`);const o=function(e,t){const s=[];for(;;){const r=/\{(?<parameterName>[\w_]+):(?<parameterType>\w+)\}/.exec(t);if(!r)break;if(10==s.filter((e=>"parameter"==e.type)).length)throw new Error(`api ${e} too many parameters`);const[n,o]=[r.groups.parameterName,r.groups.parameterType];if(!c.includes(o))throw new Error(`api ${e} parameter ${n} invalid type ${o}`);0!=r.index&&s.push({type:"normal",value:t.slice(0,r.index)}),s.push({type:"parameter",parameterName:n,parameterType:o}),t=t.slice(r.index+n.length+o.length+3)}return t.length&&s.push({type:"normal",value:t}),s}(s,n),[i,l]=[e["body-type"],e["body-name"]];if(["POST","PUT","PATCH"].includes(r)&&(!i||!l))throw new Error(`api ${s} body is required for ${r}`);return{namespace:e.namespace||"default",apiName:s,method:r,apiPath:o,bodyType:i,bodyName:l,returnType:e["return-type"]||"void"}}))}}class m{app;target;additionalHeader;definitionFile;constructor(e,t,s){this.app=e,this.target=t,this.additionalHeader=s,this.additionalHeader=this.additionalHeader??"",this.definitionFile=u(this.app)}generate(){return"server"==this.target?async function(e,t){const n=`src/${e}/server/index.ts`;let a;(0,o.logInfo)(`fcg${t}`,r`generate {yellow ${n}}`);try{a=await d(e)}catch(e){return(0,o.logError)(`fcg${t}`,e.message),{success:!1}}const{version:i,definitions:u}=a;let m=p;if(0==u.length)return m+="// empty\n",await s.promises.writeFile(n,m),(0,o.logInfo)(`fcg${t}`,"generate completed with empty"),{success:!0};m+=`import { WebContext, ${c.filter((e=>u.some((t=>t.apiPath.some((t=>"parameter"==t.type&&t.parameterType==e)))))).map((e=>l[e].validator)).concat(u.some((e=>["PUT","POST","PATCH"].includes(e.method)))?["validateBody"]:[]).join(", ")} } from '../../shared/api-server';\n`,m+="import { MyError } from '../../shared/error';\n";for(const e of u.map((e=>e.namespace)).filter(((e,t,s)=>s.indexOf(e)==t)))m+=`import { ${u.filter((t=>t.namespace==e)).map((e=>e.apiName)).join(", ")} } from './${e}';\n`;m+="\n",m+="export async function dispatch(ctx: WebContext): Promise<void> {\n",m+="    let match: RegExpExecArray;\n",m+=`    if (!ctx.path.startsWith('/${e}/v${i}')) { throw new MyError('not-found', 'invalid invocation version'); }\n`,m+=`    const methodPath = \`\${ctx.method} \${ctx.path.slice(${e.length+i.length+3})}\`;\n`,m+="\n";for(const e of u){const{apiName:t,method:s,apiPath:r,bodyType:n,returnType:o}=e;m+=`    match = /^${s} `;for(const e of r)"normal"==e.type?m+=e.value.replaceAll("/","\\/"):m+=`(?<${e.parameterName}>${l[e.parameterType].pattern})`;m+="$/.exec(methodPath); if (match) {\n",m+="        ",o&&"void"!=o&&(m+="ctx.body = "),m+=`await ${t}(ctx.state`;for(const{parameterName:e,parameterType:t}of r.filter((e=>"parameter"==e.type)))m+=`, ${l[t].validator}('${e}', match.groups['${e}'])`;n&&(m+=", validateBody(ctx.request.body)"),m+=");\n","POST"==s?m+="        ctx.status = 201;\n":"DELETE"==s&&(m+="        ctx.status = 204;\n"),m+="        return;\n",m+="    }\n"}return m+="\n",m+="    throw new MyError('not-found', 'invalid invocation');\n",m+="}\n",await s.promises.writeFile(n,m),(0,o.logInfo)(`fcg${t}`,"generate completed"),{success:!0}}(this.app,this.additionalHeader):async function(e,t){const n=`src/${e}/client/api.ts`;let c;(0,o.logInfo)(`fcg${t}`,r`generate {yellow ${n}}`);try{c=await d(e)}catch(e){return(0,o.logError)(`fcg${t}`,e.message),{success:!1}}const{version:u,definitions:m}=c;let f=p;if(0==m.length)return f+="// empty\n",await s.promises.writeFile(n,f),(0,o.logInfo)(`fcg${t}`,"generate completed with empty"),{success:!0};m.some((e=>e.apiPath.some((e=>"parameter"==e.type&&["date","time"].includes(e.parameterType)))))&&(f+="import type { Dayjs } from 'dayjs';\n"),f+=`import { ${a.filter((e=>m.some((t=>t.method==e)))).map((e=>i[e])).join(", ")} } from '../../shared/api-client';\n`;const h=m.filter((e=>!!e.bodyType)).map((e=>e.bodyType)),y=m.filter((e=>"void"!=e.returnType)).map((e=>e.returnType.endsWith("[]")?e.returnType.slice(0,-2):e.returnType));f+=`import type { ${h.concat(y).filter(((e,t,s)=>s.indexOf(e)==t)).join(", ")} } from '../api';\n`,f+="\n";for(const t of m){const{apiName:s,method:r,apiPath:n,bodyType:o,bodyName:a,returnType:c}=t;f+=`export const ${s} = (`;for(const{parameterName:e,parameterType:t}of n.filter((e=>"parameter"==e.type)))f.endsWith("(")||(f+=", "),f+=`${e}: ${l[t].tsType}`;o&&(f.endsWith("(")||(f+=", "),f+=`${a}: ${o}`),f+=`): Promise<${c}> => ${i[r]}(\`/${e}/v${u}`;for(const e of n)"normal"==e.type?f+=e.value:"date"==e.parameterType?f+=`\${${e.parameterName}.format('YYYYMMDD')}`:"time"==e.parameterType?f+=`\${${e.parameterName}.format('YYYYMMDDHHmmdd')}`:f+=`\${${e.parameterName}}`;f+="`",o&&(f+=`, ${a}`),f+=");\n"}return await s.promises.writeFile(n,f),(0,o.logInfo)(`fcg${t}`,"generate completed"),{success:!0}}(this.app,this.additionalHeader)}watch(){(0,o.logInfo)(`fcg${this.additionalHeader}`,r`watch {yellow ${this.definitionFile}}`);let e=!0;s.watch(this.definitionFile,{persistent:!1},(()=>{e=!0})),setInterval((()=>{e&&(e=!1,this.generate())}),3007)}}e.codegen=function(e,t,s){return new m(e,t,s)}}});