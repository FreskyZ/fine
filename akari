#!/usr/bin/env node
(e=>{const t={};!function s(n){return n in t||(t[n]={},e[n](t[n],s)),t[n]}(".")})({".":(e,t)=>{const s=require("readline"),n=t("tools/admin"),o=t("targets/self"),r=t("targets/server"),i=t("targets/core"),a=t("targets/public"),c=t("targets/static");function l(e){e.then((e=>process.exit(e?0:1)))}function u(e){"self"==e?(0,o.build)():"self server"==e?(0,r.build)():"public"==e?(0,a.build)():"core"==e?(0,i.build)(!1):"watch core"==e?(0,i.build)(!0):"home-page"==e?(0,c.build)("home",!1):"watch home-page"==e?(0,c.build)("home",!0):"user-page"==e?(0,c.build)("user",!1):"watch user-page"==e?(0,c.build)("user",!0):"service start"==e?l(n.admin.service("start")):"service stop"==e?l(n.admin.service("stop")):"service status"==e?l(n.admin.service("status")):"service restart"==e?l(n.admin.service("restart")):"stop-self-host"==e?l(n.admin.selfhost("stop")):"signup enable"==e?l(n.admin.core({type:"auth",sub:{type:"enable-signup"}})):"signup disable"==e?l(n.admin.core({type:"auth",sub:{type:"disable-signup"}})):/^active-user \d+$/.test(e)?l(n.admin.core({type:"auth",sub:{type:"activate-user",userId:parseInt(e.slice(12))}})):/^inactive-user \d+$/.test(e)?l(n.admin.core({type:"auth",sub:{type:"inactivate-user",userId:parseInt(e.slice(14))}})):/^reload-static [\w\\\.]+$/.test(e)?l(n.admin.core({type:"content",sub:{type:"reload-static",key:e.slice(14)}})):"disable-source-map"==e?l(n.admin.core({type:"content",sub:{type:"disable-source-map"}})):"enable-source-map"==e?l(n.admin.core({type:"content",sub:{type:"enable-source-map"}})):"config"==e?(0,i.uploadConfig)().then((()=>l(n.admin.core({type:"content",sub:{type:"reload-config"}})))):(console.log("unknown command"),process.exit(1))}process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}));const p=[process.argv[2],process.argv[3]].filter((e=>e)).join(" ");(0,o.hashself)().then((e=>{if("self"!=p&&"3d2282009fe78a779a9c4316fdd93ebc"!=e){s.createInterface({input:process.stdin,output:process.stdout}).question("script source code may be changed after last bootstrap, continue? (y|n): ",(e=>{"y"!=e&&"Y"!=e?process.exit(2):u(p)}))}else if("self"==p&&"3d2282009fe78a779a9c4316fdd93ebc"==e){s.createInterface({input:process.stdin,output:process.stdout}).question("script source code may not be changed after last bootstrap, F to force rebuild: ",(e=>{"f"==e||"F"==e?u(p):process.exit(0)}))}else u(p)}))},"tools/admin":(e,t)=>{const s=require("crypto"),n=require("fs"),o=require("https"),r=require("chalk"),i=t("common"),a=t("config"),c=t("tools/ssh");let l=null;async function u(){if(!l){const e=await(0,c.download)("akariv",!0);if(!e)return(0,i.logCritical)("adm","cannot connect akari (server) (1)");const t=e[0].data.toString();if(l=t.split(":").map((e=>parseInt(e))),3!=l.length||l.some((e=>!e)))return(0,i.logCritical)("adm","cannot connect akari (server) (2)")}return l}const p=n.readFileSync(a.config.codebook,"utf-8"),d=(e,t)=>new Promise((n=>{const c=`adm${t??""}`,l=JSON.stringify(e);u().then((t=>{const u=s.scryptSync(p.slice(t[1],32),p.slice(t[2],32),32),d=s.randomFillSync(new Uint8Array(16)),m=s.createCipheriv("aes-256-cbc",u,d),f=[];m.on("data",(e=>f.push(Buffer.from(e)))),m.write(l),m.end();const h=Buffer.concat(f).toString("hex"),g=Buffer.from(d).toString("hex")+h,y=o.request({host:a.config.domain,method:"POST",port:t[0]});y.on("error",(e=>{"ECONNREFUSED"==e.code?(0,i.logError)(c,"cannot connect akari (server)"):(0,i.logError)(c,`request error ${e.message}`,e),n(!1)})),y.on("socket",(e=>{e.on("error",(()=>{n(!1)})),y.write(g),y.end()})),y.on("response",(t=>{if(200!=t.statusCode)(0,i.logError)(c,`response ${t.statusCode}`),n(!1);else if("service"==e.target)t.pipe(process.stdout),t.on("end",(()=>n(!0)));else if("self-host"==e.target){if("stop"==e.data)t.on("data",(()=>{})),t.on("end",(()=>{(0,i.logInfo)(c,r`ack stop watch core`),n(!0)}));else if("start"==e.data){let e=!1,s=Buffer.alloc(0);t.on("data",(o=>{if(!e){if(s=Buffer.concat([s,Buffer.from(o)]),s.length<4)return;{e=!0;const o=s.slice(0,4).toString();"that"==o?((0,i.logInfo)(c,r`ack {yellow restart watch core}`),n(!0)):"this"==o?(process.stdout.write(s.slice(4)),t.pipe(process.stdout)):((0,i.logError)(c,`start watch core received unexpected header ${o}`),n(!1))}}})),t.on("end",(()=>n(!0)))}}else{let s="";t.on("data",(e=>{s+=e})),t.on("end",(()=>{s=="ACK "+l?((0,i.logInfo)(c,r`{cyan ACK} {yellow ${(0,i.formatAdminPayload)(e)}}`),n(!0)):((0,i.logError)(c,"unexpected response "+s),n(!1))}))}}))}))}));e.admin=new class{get port(){return u().then((e=>e[0]))}core(e,t){return d({target:"core",data:e},t)}devpage(e,t){return d({target:"dev-page",data:e},t)}selfhost(e,t){return d({target:"self-host",data:e},t)}service(e,t){return d({target:"service",data:e},t)}}},"targets/self":(e,t)=>{const s=require("crypto"),n=require("fs"),o=require("path"),r=require("chalk"),i=t("common"),a=t("tools/eslint"),c=t("tools/typescript"),l=t("tools/mypack"),u={base:"normal",entry:"script/index.ts",sourceMap:"no",watch:!1,configSubstitution:!1};async function p(e,t){for(const s of await n.promises.readdir(t,{withFileTypes:!0})){const r=o.join(t,s.name);if(s.isDirectory())await p(e,r);else if(s.isFile())e.push(r);else if(s.isSymbolicLink()){const t=await n.promises.readlink(r),s=await n.promises.lstat(t);s.isDirectory()?await p(e,t):s.isFile()&&e.push(t)}}}async function d(){const e=[];await p(e,"script"),e.sort();const t=s.createHash("md5");for(const o of e)await new Promise((e=>{const r=s.createHash("md5"),i=n.createReadStream(o);i.on("data",(e=>r.update(e))),i.on("end",(()=>{t.update(r.digest()),e()}))}));return t.digest("hex")}e.hashself=d,e.build=async function(){(0,i.logInfo)("akr",r`{cyan self}`),await(0,a.eslint)("self","node","script/**/*.ts");const e=(0,c.typescript)(u).check();if(!e.success)return(0,i.logCritical)("akr",r`{cyan self} failed at transpile`);const t=await(0,l.mypack)((s=e.files,{type:"app",entry:"/vbuild/index.js",files:s,minify:!0,shebang:!0,cleanupFiles:!1})).run();var s;if(!t.success)return(0,i.logCritical)("akr",r`{cyan self} failed at pack`);const o=t.resultJs.toString("utf-8").replaceAll("3d2282009fe78a779a9c4316fdd93ebc",await d());await n.promises.writeFile("akari",o),(0,i.logInfo)("akr",r`{cyan self} completed successfully`)}},"targets/server":(e,t)=>{const s=require("chalk"),n=t("common"),o=t("tools/eslint"),r=t("tools/ssh"),i=t("tools/typescript"),a=t("tools/mypack"),c={base:"normal",entry:"script/server/index.ts",sourceMap:"no",watch:!1};e.build=async function(){(0,n.logInfo)("akr",s`{cyan self}`),await(0,o.eslint)("self","node","script/**/*.ts");const e=(0,i.typescript)(c).check();if(!e.success)return(0,n.logCritical)("akr",s`{cyan self} failed at transpile`);const t=await(0,a.mypack)((l=e.files,{type:"app",entry:"/vbuild/server/index.js",files:l,minify:!0,shebang:!0,cleanupFiles:!1})).run();var l;if(!t.success)return(0,n.logCritical)("akr",s`{cyan self} failed at pack`);const u=await(0,r.upload)((e=>[{data:e.resultJs,remote:"akari",mode:511}])(t));if(!u)return(0,n.logCritical)("akr",s`{cyan self} failed at upload`);(0,n.logInfo)("akr",s`{cyan self} completed successfully`)}},"targets/core":(e,t)=>{const s=require("fs/promises"),n=require("chalk"),o=t("common"),r=t("tools/admin"),i=t("tools/eslint"),a=t("tools/ssh"),c=t("tools/typescript"),l=t("tools/mypack"),u=e=>({base:"normal",entry:"src/core/index.ts",module:"es",sourceMap:"hide",watch:e});async function p(){(0,o.logInfo)("akr",n`{cyan core}`),await(0,i.eslint)("core","node",["src/shared/**/*.ts","src/core/**/*.ts"]);if(!(0,c.typescript)(u(!1)).check().success)return(0,o.logCritical)("akr",n`{cyan core} failed at check`);(0,o.logInfo)("akr",n`{cyan core} completed successfully`)}function d(){(0,o.logInfo)("akr",n`watch {cyan core}`);const e=(0,l.mypack)({type:"app",files:[],entry:"/vbuild/core/index.js",sourceMap:!0,output:"index.js",printModules:!0,minify:!0});(0,c.typescript)(u(!0)).watch((async({files:t})=>{e.options.files=t;const s=await e.run();s.success&&s.hasChange&&(await(0,a.upload)((e=>[{remote:"index.js",data:e.resultJs},{remote:"index.js.map",data:e.resultMap}])(s)),r.admin.selfhost("start"))})),process.on("SIGINT",(()=>{r.admin.selfhost("stop").then((()=>process.exit()))}))}e.uploadConfig=async function(){await(0,a.upload)({remote:"config",data:await s.readFile("src/shared/config.json")})},e.build=function(e){(e?d:p)()}},"targets/public":(e,t)=>{const s=require("fs"),n=require("path"),o=require("chalk"),r=t("common"),i=t("tools/ssh");async function a(e,t){return await Promise.all((await s.promises.readdir(t,{withFileTypes:!0})).map((async o=>{const r=n.join(t,o.name);o.isDirectory()?await a(e,r):e.push({remote:r.replace("src/",""),data:await s.promises.readFile(r)})}))),e}e.build=async function(){(0,r.logInfo)("akr",o`{cyan public}`),await(0,i.upload)(await a([],"src/public")),(0,r.logInfo)("akr",o`{cyan public} complete`)}},"targets/static":(e,t)=>{const s=require("fs"),n=require("chalk"),o=t("common"),r=t("tools/admin"),i=t("tools/eslint"),a=t("tools/ssh"),c=t("tools/sass"),l=t("tools/typescript"),u=(e,t)=>"user"==e?{base:"jsx-page",entry:`src/static/${e}.tsx`,sourceMap:"no",watch:t}:{base:"normal",entry:`src/static/${e}.ts`,additionalLib:["dom"],sourceMap:"no",watch:t},p=e=>({entry:`src/static/${e}.sass`}),d=(e,t)=>"html"==t?{remote:`static/${e}.html`,data:Buffer.from(s.readFileSync(`src/static/${e}.html`))}:"files"in t?{remote:`static/${e}.js`,data:Buffer.from(t.files[0].content)}:{remote:`static/${e}.css`,data:t.resultCss};function m(e){const t=e.files[0].content,s=`const ${/import (?<pat>{[\w\s,]+}) from 'react';/.exec(t).groups.pat} = React;`;let n=t.slice(t.indexOf("\n",t.indexOf("\n",t.indexOf("\n")+1)+1)+1);n=n.replaceAll(/_jsxs?\(_Fragment, /g,"myjsxf(").replaceAll(/_jsxs?/g,"myjsx"),e.files[0].content=s+l.MyJSXRuntime+"\n"+n}async function f(e){(0,o.logInfo)("akr",n`{cyan ${e}-page}`);const t=[d(e,"html")],f=(0,l.typescript)(u(e,!1));if(s.existsSync(f.options.entry)){await(0,i.eslint)(`${e}-page`,"browser",f.options.entry);const s=f.check();if(!s.success)return(0,o.logCritical)("akr",n`{cyan ${e}-page} failed at check`);f.options.entry.endsWith("tsx")&&m(s),t.push(d(e,s))}const h=(0,c.sass)(p(e));if(s.existsSync(h.options.entry)){const s=await h.transpile();if(!s.success)return(0,o.logCritical)("akr",n`{cyan ${e}-page} failed at transpile`);t.push(d(e,s))}if(!await(0,a.upload)(t))return(0,o.logCritical)("akr",n`{cyan ${e}-page} failed at upload`);if(!await r.admin.core({type:"content",sub:{type:"reload-static",key:e}}))return(0,o.logCritical)("akr",n`{cyan ${e}-page} failed at reload`);(0,o.logInfo)("akr",n`{cyan ${e}-page} completed succesfully`)}function h(e){(0,o.logInfo)("akr",n`watch {cyan ${e}-page}`);const t=(0,o.watchvar)((()=>{r.admin.core({type:"content",sub:{type:"reload-static",key:e}})}),{interval:2021}),i=(0,l.typescript)(u(e,!0));s.existsSync(i.options.entry)&&i.watch((async s=>{i.options.entry.endsWith("tsx")&&m(s),(0,o.logInfo)("tsc","completed with no diagnostics"),await(0,a.upload)(d(e,s))&&t()}));const f=(0,c.sass)(p(e));s.existsSync(f.options.entry)&&f.watch((async s=>{await(0,a.upload)(d(e,s))&&t()}));const h=(0,o.watchvar)((async()=>{(0,o.logInfo)("htm","reupload"),await(0,a.upload)(d(e,"html"))&&t()}),{interval:2021,initialCall:!0}),g=`src/static/${e}.html`;(0,o.logInfo)("htm",n`watch {yellow ${g}}`),s.watch(g,{persistent:!1},h)}e.build=function(e,t){(t?h:f)(e)}},common:(e,t)=>{const s=require("chalk"),n=require("dayjs");function o(e){switch(e.type){case"ping":return"ping";case"shutdown":return"shutdown";case"content":switch(e.sub.type){case"reload-static":return`reload-static ${e.sub.key}`;case"reload-config":return"reload-config";case"enable-source-map":return"source-map enable";case"disable-source-map":return"source-map disable";default:return`unknown content command ${e}`}case"auth":switch(e.sub.type){case"enable-signup":return"enable-signup";case"disable-signup":return"disable-signup";case"activate-user":return`activate-user ${e.sub.userId}`;case"inactivate-user":return`inactivate-user ${e.sub.userId}`;case"remove-device":return`remove-device ${e.sub.deviceId}`;default:return`unknown auth command ${e}`}default:return`unknown core command ${JSON.stringify(e)}`}}e.logInfo=function(e,t,o){o?console.log(s`[{green ${n().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`,o):console.log(s`[{green ${n().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`)},e.logError=function(e,t,o){o?console.log(s`[{green ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`,o):console.log(s`[{green ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`)},e.logCritical=function(e,t){return console.log(s`[{green ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`),process.exit(1)},e.watchvar=function(e,t){let s=!1;return setInterval((()=>{s&&(s=!1,e())}),t?.interval??3001),t?.initialCall&&e(),()=>s=!0},e.formatAdminCoreCommand=o,e.formatAdminPayload=function(e){switch(e.target){case"core":return o(e.data);case"dev-page":switch(e.data){case"reload-all":return"dev-page reload-all";case"reload-css":return"dev-page reload-css";default:return`unknown dev-page command ${e}`}case"service":switch(e.data){case"start":return"systemctl start";case"status":return"systemctl status";case"stop":return"systemctl stop";case"restart":return"systemctl restart";case"is-active":return"systemctl is-active";default:return`unknown service payload ${e}`}case"self-host":switch(e.data){case"start":return"self-host start core";case"stop":return"self-host stop core";default:return`unknown self-host command ${e}`}default:return`unknown command ${JSON.stringify(e)}`}}},config:(e,t)=>{const s=require("fs");e.config=JSON.parse(s.readFileSync("akaric","utf-8"))},"tools/ssh":(e,t)=>{const s=require("fs"),n=require("path"),o=require("stream"),r=require("chalk"),i=require("ssh2-sftp-client"),a=t("config"),c=t("common"),l={host:a.config.domain,username:a.config.ssh.user,privateKey:s.readFileSync(a.config.ssh.identity),passphrase:a.config.ssh.passphrase};e.upload=async function(e,t){e=Array.isArray(e)?e:[e];const s=new i;for(const t of e)if(!t.data||!Buffer.isBuffer(t.data))return(0,c.logError)("ssh",`${n.basename(t.remote)} invalid data`),!1;try{await s.connect(l);for(const o of e)await s.put(o.data,n.join(t?.basedir??a.config.webroot,o.remote),{writeStreamOptions:{mode:o.mode||420}});return await s.end(),(0,c.logInfo)(`ssh${t?.additionalHeader??""}`,r`upload {yellow ${e.length}} files ${t?.filenames?"":e.map((e=>r.yellow(n.basename(e.remote))))}`),!0}catch(e){return(0,c.logError)(`ssh${t?.additionalHeader??""}`,"error "+e.message),!1}},e.download=async function(e,t){e=Array.isArray(e)?e:[e];const s=new i;try{await s.connect(l);const i=[];for(const t of e){const e=[];await s.get(n.join(a.config.webroot,t),new o.Writable({write(t,s,n){e.push(Buffer.from(t,s)),n()}})),i.push({remote:t,data:Buffer.concat(e)})}return await s.end(),t||(0,c.logInfo)("ssh",r`download {yellow ${i.length}} file`),i}catch(e){return(0,c.logError)("ssh","error "+e.message),null}}},"tools/eslint":(e,t)=>{const s=require("eslint"),n=t("common");e.eslint=async function(e,t,o){if(!("AKARIN_ESLINT"in process.env))return;const r=new s.ESLint({useEslintrc:!1,baseConfig:{parser:"@typescript-eslint/parser",parserOptions:{ecmaVersion:2020,sourceType:"module",ecmaFeatures:{jsx:"browser"==t}},plugins:"node"==t?["@typescript-eslint"]:["@typescript-eslint","react","react-hooks","jsx-a11y"],env:{node:"node"==t,browser:"browser"==t},extends:"node"==t?["eslint:recommended","plugin:@typescript-eslint/recommended"]:["eslint:recommended","plugin:@typescript-eslint/recommended","plugin:react/recommended","plugin:react-hooks/recommended","plugin:jsx-a11y/recommended"],settings:"node"==t?{}:{react:{version:"17.0"}},rules:"node"==t?{"array-callback-return":"warn","class-methods-use-this":"error","comma-dangle":"off","eol-last":"error","no-constant-condition":"off","no-multiple-empty-lines":"error","no-extra-parens":"off","no-lone-blocks":"warn","no-sequences":"error","no-template-curly-in-string":"warn","no-trailing-spaces":"error","no-unused-expressions":"off","prefer-named-capture-group":"off","require-await":"error",semi:"off","@typescript-eslint/comma-dangle":["warn","always-multiline"],"@typescript-eslint/consistent-type-imports":"off","@typescript-eslint/explicit-module-boundary-types":["warn",{allowArgumentsExplicitlyTypedAsAny:!0}],"@typescript-eslint/member-delimiter-style":["warn",{multiline:{delimiter:"comma",requireLast:!0},singleline:{delimiter:"comma",requireLast:!1}}],"@typescript-eslint/no-confusing-non-null-assertion":"warn","@typescript-eslint/no-explicit-any":"off","@typescript-eslint/no-non-null-assertion":"off","@typescript-eslint/no-unnecessary-condition":"off","@typescript-eslint/no-unused-expressions":"error","@typescript-eslint/no-var-requires":"off","@typescript-eslint/prefer-includes":"off","@typescript-eslint/prefer-readonly":"off","@typescript-eslint/semi":"error","@typescript-eslint/switch-exhaustiveness-check":"off","@typescript-eslint/triple-slash-reference":"off"}:{"array-callback-return":"warn","class-methods-use-this":"error","comma-dangle":"off","eol-last":"error","jsx-quotes":["error","prefer-single"],"no-constant-condition":"off","no-multiple-empty-lines":"error","no-extra-parens":"off","no-lone-blocks":"warn","no-sequences":"error","no-template-curly-in-string":"warn","no-trailing-spaces":"error","no-unused-expressions":"off","prefer-named-capture-group":"off","require-await":"error",semi:"off","react/display-name":"off","react/jsx-handler-names":"off","react/jsx-no-comment-textnodes":"error","react/jsx-tag-spacing":"warn","react/no-children-prop":"off","react/prop-types":"off","react/self-closing-comp":"error","jsx-a11y/click-events-have-key-events":"off","jsx-a11y/interactive-supports-focus":"off","@typescript-eslint/comma-dangle":["warn","always-multiline"],"@typescript-eslint/consistent-type-imports":"off","@typescript-eslint/explicit-module-boundary-types":["warn",{allowArgumentsExplicitlyTypedAsAny:!0}],"@typescript-eslint/member-delimiter-style":["warn",{multiline:{delimiter:"comma",requireLast:!0},singleline:{delimiter:"comma",requireLast:!1}}],"@typescript-eslint/no-confusing-non-null-assertion":"warn","@typescript-eslint/no-explicit-any":"off","@typescript-eslint/no-non-null-assertion":"off","@typescript-eslint/no-unnecessary-condition":"off","@typescript-eslint/no-unused-expressions":"error","@typescript-eslint/no-var-requires":"off","@typescript-eslint/prefer-includes":"off","@typescript-eslint/prefer-readonly":"off","@typescript-eslint/semi":"error","@typescript-eslint/switch-exhaustiveness-check":"off","@typescript-eslint/triple-slash-reference":"off"}},cache:!0,cacheLocation:`.cache/eslint-${e}`}),i=await r.lintFiles(o),a=(await r.loadFormatter("stylish")).format(i);a?console.log(a):(0,n.logInfo)("esl","clear")}},"tools/typescript":(e,t)=>{const s=require("path"),n=require("typescript"),o=require("chalk"),r=t("common"),i=t("config");e.MyJSXRuntime="function myjsx(type,rawprops,maybekey){const props={};for(const n in rawprops){if(!['key','ref','__self','__source'].includes(n)){props[n]=rawprops[n]}}return{$$typeof:Symbol.for('react.element'),type,key:rawprops.key!==void 0?''+rawprops.key:maybekey!==void 0?''+maybekey:null,ref:rawprops.ref!==void 0?rawprops.ref:null,props,_owner:React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner.current}}function myjsxf(p,k){return myjsx(Symbol.for('react.fragment'),p,k)}";const a={lib:["lib.esnext.d.ts"],target:n.ScriptTarget.ESNext,module:n.ModuleKind.ESNext,moduleResolution:n.ModuleResolutionKind.NodeJs,skipLibCheck:!0,noEmitOnError:!0,strict:"AKARIN_STRICT"in process.env,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictNullChecks:"AKARIN_STRICT"in process.env,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function c({category:e,code:t,messageText:s,file:i,start:a},c){if(6031!=t)if(6032==t)(0,r.logInfo)(`tsc${c}`,"recheck");else{if(6194==t)return;{const r=(0,{[n.DiagnosticCategory.Warning]:o.red,[n.DiagnosticCategory.Error]:o.red,[n.DiagnosticCategory.Suggestion]:o.green,[n.DiagnosticCategory.Message]:o.cyan}[e])(`  TS${t} `);let c="";if(i&&a){const{line:e,character:t}=n.getLineAndCharacterOfPosition(i,a);c=o`{yellow ${i.fileName}:${e+1}:${t+1}} `}let l=n.flattenDiagnosticMessageText(s,"\n");l.includes("\n")&&(l="\n"+l),console.log(r+c+l)}}}function l(){const e=n.sys.readFile;n.sys.readFile=(t,s)=>{let n=e(t,s);return n&&!t.endsWith(".d.ts")&&(n=n.replaceAll("domain.com",i.config.domain),n=n.replaceAll("webroot",i.config.webroot),i.config.apps&&(n=n.replaceAll("APPSETTING",JSON.stringify(i.config.apps.map((e=>({name:e.name,origin:e.origin,socket:e.socket}))))))),n}}function u(e,t){return(s,n)=>{if(s.endsWith(".js")){n.startsWith('"use strict"')&&(n=n.slice(n.indexOf("\n")+1)),n.startsWith("Object.defineProperty")&&(n=n.slice(n.indexOf("\n")+1)),n.startsWith("exports.")&&(n=n.slice(n.indexOf("\n")+1));const t=/\/\/#\s*sourceMappingURL/.exec(n);if(t&&0==n.substring(0,t.index).trim().length)return;t&&"hide"==e.sourceMap?n=n.slice(0,t.index):n.endsWith("\n")||(n+="\n")}const o=t.findIndex((e=>e.name==s));o>=0?t.splice(o,1,{name:s,content:n}):t.push({name:s,content:n})}}const p=function(e){const t=new Map;for(const s in e){const n=e[s];"number"!=typeof n||t.has(n)||t.set(n,s)}return e=>t.get(e)}(n.SyntaxKind),d=function(e){const t=new Map;for(const s in e){const n=e[s];"number"!=typeof n||t.has(n)||1!=n.toString(2).split("1").length||t.set(n,s)}return e=>{const s=[];let n=e,o=1;for(;n;)n&o&&s.push(t.get(o)),n&=~o,o<<=1;return s}}(n.NodeFlags);function m(e){return e=>(console.log(e.fileName),n.forEachChild(e,(t=>{const s=t.pos<=0?{line:0,character:0}:n.getLineAndCharacterOfPosition(e,t.pos),o=t.end<=0?{line:0,character:0}:n.getLineAndCharacterOfPosition(e,t.end),r=`${s.line+1}:${s.character}-${o.line+1}:${o.character} ${p(t.kind)} ${d(t.flags)}`;if(n.isFunctionDeclaration(t)){const e=t.modifiers&&t.modifiers.some((e=>e.kind==n.SyntaxKind.ExportKeyword));console.log(`${r} ${e?"export ":""} ${t.name.text}`)}else if(n.isVariableStatement(t)){const e=t.modifiers&&t.modifiers.some((e=>e.kind==n.SyntaxKind.ExportKeyword)),s=t.declarationList.declarations.map((e=>e.name.kind==n.SyntaxKind.Identifier?e.name.text:"[binding]"));console.log(`${r} ${e?"export ":""}${s}`)}else if(n.isImportDeclaration(t)){const e=t.moduleSpecifier.text;if(t.importClause){const s=[];if(t.importClause.name&&s.push({name:"default",alias:t.importClause.name.text}),t.importClause.namedBindings.kind==n.SyntaxKind.NamespaceImport)s.push({name:"__all__",alias:t.importClause.namedBindings.name.text});else for(const e of t.importClause.namedBindings.elements)s.push({alias:e.name.text,name:e.propertyName?e.propertyName.text:e.name.text});console.log(`${r} from ${e} import ${s.map((e=>`${e.name} as ${e.alias}`)).join(",")}`)}else console.log(`${r} importclause is empty`)}else console.log(r)})),e)}class f{options;additionalHeader;compilerOptions;constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??"",this.compilerOptions=function(e){return"normal"==e.base?{...a,module:"es"==e.module?n.ModuleKind.ESNext:n.ModuleKind.CommonJS,outDir:"/vbuild",sourceMap:"no"!=e.sourceMap,lib:"additionalLib"in e?[...a.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:a.lib}:"jsx-page"==e.base?{...a,outDir:"/vbuild",target:n.ScriptTarget.ES2018,sourceMap:!1,esModuleInterop:!0,jsx:n.JsxEmit.ReactJSX,lib:[...a.lib,"lib.dom.d.ts"]}:{...a,outDir:s.resolve("src"),target:n.ScriptTarget.ES2018,sourceMap:!0,esModuleInterop:!0,jsx:n.JsxEmit.ReactJSX,lib:[...a.lib,"lib.dom.d.ts"]}}(e)}check(){(0,r.logInfo)("tsc",o`once {yellow ${this.options.entry}}`),("normal"!=this.options.base||void 0===this.options.configSubstitution||this.options.configSubstitution)&&l();const e=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry],t=n.createProgram(e,this.compilerOptions,n.createCompilerHost(this.compilerOptions)),s=[],i="normal"!=this.options.base||void 0===this.options.configSubstitution?[m]:[],a=function(e){const t=e.diagnostics.filter((e=>e.category==n.DiagnosticCategory.Error||n.DiagnosticCategory.Warning)).length,s=e.diagnostics.length-t;let i;i=0==s&&0==t?"no diagnostic":0!=s&&0==t?o`{yellow ${s}} infos`:0==s?o`{yellow ${t}} errors`:o`{yellow ${t}} errors and {yellow ${s}} infos`,(e.emitSkipped?r.logError:r.logInfo)("tsc",`completed with ${i}`);for(const t of e.diagnostics)c(t);return!e.emitSkipped}(t.emit(void 0,u(this.options,s),void 0,void 0,{after:i}));return{success:a,files:s}}watch(e){(0,r.logInfo)(`tsc${this.additionalHeader}`,o`watch {yellow ${this.options.entry}}`),("normal"!=this.options.base||void 0===this.options.configSubstitution||this.options.configSubstitution)&&l();const t=[],s=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry];setImmediate((()=>{n.createWatchProgram(n.createWatchCompilerHost(s,this.compilerOptions,n.sys,((...s)=>{const o=n.createEmitAndSemanticDiagnosticsBuilderProgram(...s),r=o.emit;return o.emit=(s,n,...o)=>{const i=r(s,u(this.options,t),...o);return i.emitSkipped||e({files:t}),i},o}),(e=>c(e,this.additionalHeader)),(e=>c(e,this.additionalHeader))))}))}}e.typescript=function(e,t){return new f(e,t)}},"tools/mypack":(e,t)=>{const s=require("path"),n=require("chalk"),o=require("crypto-js"),r=require("filesize"),i=require("source-map"),a=require("terser"),c=t("common");function l(e){const t=/\n/g,s=[];for(;;){const n=t.exec(e);if(!n)break;s.push(n.index)}return function(e){const t=s.findIndex((t=>t>e));return t<0?`${s.length+1}:${e-(s.length?s[s.length-1]:0)+1}`:0==t?`1:${e}`:`${t+1}:${e-s[t-1]+1}`}}class u{options;lastHash=null;lastModules=null;logHeader;constructor(e,t){this.options=e,this.logHeader=t?`mpk${t}`:"mpk"}updateFiles(e){this.options.files=e}getSources(){return this.options.files.filter((e=>e.name.endsWith(".js"))).map((({name:e,content:t})=>({filename:e,jsContent:t,mapContent:this.options.files.find((t=>t.name==e+".map"))?.content,mapIndex:l(t)})))}processModule(e,t){let n=s.relative(s.dirname(this.options.entry),e.filename);n.endsWith(".js")&&(n=n.slice(0,-3)),n.endsWith("index")&&(n=n.slice(0,-5)),0==n.length&&(n=".");const r=[],i=/require\("(?<request>\.[.\w\-/]*)"\);/g;for(;;){const n=i.exec(e.jsContent);if(!n)break;const o=n.groups.request,a=s.resolve(s.dirname(e.filename),o),l=t.some((e=>e.filename==a))?a:t.some((e=>e.filename==a+".js"))?a+".js":t.some((e=>e.filename==a+"/index.js"))?a+"/index.js":null;if(!l)return(0,c.logError)(this.logHeader,`${e.filename}: invalid module name ${o} at ${e.mapIndex(n.index)}`),null;let u=s.relative(s.dirname(this.options.entry),l);u=u.slice(0,-3),u.endsWith("index")&&(u=u.slice(0,-5)),0==u.length&&(u="."),r.push({index:n.index,raw:o,resolvedFileName:l,resolvedModuleName:u})}let a=0,l="";for(const{index:t,raw:s,resolvedModuleName:n}of r)l+=e.jsContent.slice(a,t),l+=`myimport("${n}");`,a=t+s.length+12;if(l+=e.jsContent.slice(a),this.options.externals)for(const[e,t]of Object.entries(this.options.externals))l=l.replaceAll(`require("${e}")`,t);return{name:n,source:e,requests:r,content:l,hash:(0,o.SHA256)(l).toString()}}checkCircularReference(e){const t=[{moduleName:e[0].name,parentFileName:"",parentRequirePosition:"",parentRequireRaw:""}],s=o=>{for(const r of o.requests){const i=e.find((e=>e.name==r.resolvedModuleName));if(t.some((e=>e.moduleName==i.name))){(0,c.logError)(this.logHeader,"circular reference encountered");for(const e of t.slice(1))console.log(n`   {${e.parentFileName==i.source.filename?"yellow":"white"} ${e.parentFileName}}`+n`:${e.parentRequirePosition}:{gray require("}${e.parentRequireRaw}{gray ")}`);throw console.log(n`   ${o.source.filename}:${o.source.mapIndex(r.index)}:{gray require("}{yellow ${r.raw}}{gray ")}`),new Error("circular reference")}t.push({parentFileName:o.source.filename,parentRequirePosition:o.source.mapIndex(r.index),parentRequireRaw:r.raw,moduleName:i.name}),s(i),t.pop()}};try{return s(e[0]),!1}catch(e){if("circular reference"==e.message)return!0;throw e}}emitRuntimePrefix(e,t){this.options.shebang&&(e.sb+="#!/usr/bin/env node\n",e.lineOffset+=1),e.sb+="app"==this.options.type?`((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`:`module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`,e.lineOffset+=2}async emitModule(e,t){if(e.sb+=`'${t.name}': (exports, myimport) => {\n${t.content}}, `,e.lineOffset+=1,e.generator&&!t.source.mapContent){let n=null;(await new i.SourceMapConsumer(JSON.parse(t.source.mapContent))).eachMapping((t=>{null===n&&(n=t.generatedLine),e.generator.addMapping({source:s.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-n+e.lineOffset+1,column:t.generatedColumn}})})),e.lineOffset+=t.content.split("\n").length-1}}emitRuntimePostfix(e){e.sb+="})\n"}printResult(e,t){if((0,c.logInfo)(this.logHeader,n`completed with {yellow 1} asset {yellow ${r(e)}}`),this.options.printModules){const e=this.lastModules;if(e){for(const s of t.filter((t=>!e.some((e=>e.source==t.source.filename)))))console.log(n`  {gray +} ${s.name} ({gray ${s.source.filename}}) ${r(s.content.length)}`);for(const[s]of t.map((t=>[t,e.find((e=>e.source==t.source.filename))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(n`  {gray *} ${s.name} ({gray ${s.source.filename}}) ${r(s.content.length)}`);for(const s of e.filter((e=>!t.some((t=>t.source.filename==e.source)))))console.log(n`  {gray - removed} ${s.name} ({gray ${s.source}})`)}else for(const{name:e,source:s,content:o}of t){const t=s.filename.startsWith("/vbuild/")?s.filename.slice(8):s.filename;console.log(n`   {gray +} ({gray ${t}}) {greenBright ${e}} ${r(o.length)}`)}}}async run(){const e=this.options.entry;(0,c.logInfo)(this.logHeader,this.lastHash?"repack":n`pack {yellow ${e.startsWith("/vbuild/")?e.slice(8):e}}`);const t=this.getSources();if(!t.some((t=>t.filename==e)))return(0,c.logError)(this.logHeader,"invalid entry"),{success:!1};const s=[],r=[e];for(let e=0;e<r.length;++e){const n=this.processModule(t.find((t=>t.filename==r[e])),t);if(!n)return{success:!1};r.push(...n.requests.map((e=>e.resolvedFileName)).filter((e=>!r.includes(e)))),s.push(n)}if(this.checkCircularReference(s))return{success:!1};const l={sb:"",lineOffset:0,generator:this.options.sourceMap?new i.SourceMapGenerator({file:this.options.output}):null};this.emitRuntimePrefix(l,s[0].name);for(const e of s)await this.emitModule(l,e);this.emitRuntimePostfix(l);let u=l.sb,p=l.generator?.toString();if(this.options.minify){const e=await(0,a.minify)(u,{sourceMap:!!this.options.sourceMap&&{content:p,filename:this.options.output,url:this.options.output+".map"},format:{max_line_len:"AKARIN_SELF_MULTILINE"in process.env?120:void 0}});u=e.code,p="object"==typeof e.map?JSON.stringify(e.map):e.map}const d=(0,o.SHA256)(u).toString(),m=d!=this.lastHash;return m?this.printResult(u.length,s):(0,c.logInfo)(this.logHeader,n`completed with {gray no change}`),"cleanupFiles"in this.options&&!this.options.cleanupFiles||function(e,t){const s=t.filter((t=>!e.some((e=>e.source.filename==t.name))&&!e.some((e=>e.source.filename+".map"==t.name))));for(const e of s)t.splice(t.indexOf(e),1),e.name.endsWith(".map")||console.log(n`   {gray - ${e.name}}`)}(s,this.options.files),this.lastHash=d,this.lastModules=s.map((e=>({name:e.name,source:e.source.filename,hash:e.hash}))),{success:!0,hasChange:m,resultJs:Buffer.from(u),resultMap:p?Buffer.from(p):void 0}}}e.mypack=function(e,t){return new u(e,t)}},"tools/sass":(e,t)=>{const s=require("fs"),n=require("chalk"),o=require("sass"),r=t("common");class i{options;additionalHeader;constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??""}transpile=()=>new Promise((e=>{(0,r.logInfo)("css",n`once {yellow ${this.options.entry}}`);const t=process.hrtime.bigint();try{const s=(0,o.compile)(this.options.entry,{style:"compressed"}),n=process.hrtime.bigint();(0,r.logInfo)("css",`completed in ${(n-t)/1000000n}ms`),e({success:!0,resultCss:Buffer.from(s.css,"utf-8")})}catch(t){t instanceof o.Exception?(0,r.logError)("css",`error at ${t.span.url}:${t.span.start.line}:${t.span.start.column}: ${t.message}`):(0,r.logError)("css",`error ${t}`),e({success:!1})}}));watch(e){const t=this.options.entry,i=`css${this.additionalHeader}`;(0,r.logInfo)(i,n`watch {yellow ${t}}`);const a=[];let c="none",l=[t];!function n(){c="running";for(const e of a)e.close();a.splice(0,a.length);let u=[t];const p=process.hrtime.bigint();try{const s=(0,o.compile)(t,{style:"compressed",importers:[{findFileUrl:e=>(u.push(e),new URL(e))}]}),n=process.hrtime.bigint();(0,r.logInfo)(i,`completed in ${(p-n)/1000000n}ms`),e({success:!0,resultCss:Buffer.from(s.css)})}catch(e){e instanceof o.Exception?(0,r.logError)("css",`error at ${e.span.url}:${e.span.start.line}:${e.span.start.column}: ${e.message}`):(0,r.logError)("css",`error ${e}`),u=l}for(const e of u)a.push(s.watch(e,{persistent:!1},(()=>{"running"==c?((0,r.logInfo)(i,"retranspile waiting"),c="pending"):"none"==c&&((0,r.logInfo)(i,"retranspile (1)"),n())})));l=u,"pending"==c?((0,r.logInfo)(i,"retranspile (2)"),n()):"running"==c&&(c="none")}()}}e.sass=function(e,t){return new i(e,t)}}});