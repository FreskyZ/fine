#!/usr/bin/env node
(e=>{const t={};!function s(r){return r in t||(t[r]={},e[r](t[r],s)),t[r]}("local")})({local:(e,t)=>{const s=t("targets/self"),r=t("targets/public"),a=t("targets/server-core"),n=t("targets/web-page"),o=t("targets/app-server"),i=t("targets/app-client"),c=t("tools/admin");function l(e){if(["home","user","404","418"].includes(e))return e;console.log("unknown page name"),process.exit(1)}function d(e){if(["cost","collect","ak"].includes(e))return e;console.log("unknown app name"),process.exit(1)}const[p,u]=[process.argv[2]||"",process.argv[3]||""];"self"==p?s.build():"public"==p?r.build():"server-core"==p?a.build(!1):"watch"==p&&"server-core"==u?a.build(!0):p.endsWith("-page")?n.build(l(p.slice(0,-5)),!1):"watch"==p&&u.endsWith("-page")?n.build(l(u.slice(0,-5)),!0):p.endsWith("-client")?i.build(d(p.slice(0,-7)),!1):"watch"==p&&u.endsWith("-client")?i.build(d(u.slice(0,-7)),!0):p.endsWith("-server")?o.build(d(p.slice(0,-7)),!1):"watch"==p&&u.endsWith("-server")?o.build(d(u.slice(0,-7)),!0):"watch"==p&&u.endsWith("-both")?(i.build(d(u.slice(0,-5)),!0,"(c)"),o.build(d(u.slice(0,-5)),!0,"(s)")):"all"==p?(r.build(),a.build(!1),n.build("home",!1),n.build("user",!1),n.build("404",!1),n.build("418",!1),o.build("cost",!1),i.build("cost",!1),i.build("ak",!1)):"service"==p&&"start"==u?c.admin({type:"service",data:"start"}).then((e=>process.exit(e?1:0))):"service"==p&&"status"==u?c.admin({type:"service",data:"status"}).then((e=>process.exit(e?1:0))):"service"==p&&"stop"==u?c.admin({type:"service",data:"stop"}).then((e=>process.exit(e?1:0))):"service"==p&&"restart"==u?c.admin({type:"service",data:"restart"}).then((e=>process.exit(e?1:0))):"service"==p&&"is-active"==u?c.admin({type:"service",data:"is-active"}).then((e=>process.exit(e?1:0))):"watchscstop"==p?c.admin({type:"watchsc",data:"stop"}).then((e=>process.exit(e?1:0))):(console.log("unknown command"),process.exit(1)),process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},"targets/self":(e,t)=>{const s=require("fs"),r=require("chalk"),a=t("common"),n=t("tools/typescript"),o=t("tools/mypack"),i=t("tools/ssh"),c={base:"normal",entry:["script/local.ts","script/server.ts"],sourceMap:"no",watch:!1};e.build=async function(){a.logInfo("akr",r`{cyan self}`);const e=n.typescript(c).check();if(!e.success)return a.logCritical("akr",r`{cyan self} failed at transpile`);await Promise.all([(async()=>{const t=await o.mypack((n=e.files,{type:"app",entry:"/vbuild/local.js",files:n,output:"akari",minify:!0,shebang:!0,cleanupFiles:!1}),"(1)").run();var n;if(!t.success)return a.logCritical("akr",r`{cyan self} failed at pack (1)`);s.writeFileSync("akari",t.resultJs)})(),(async()=>{const t=await o.mypack((s=e.files,{type:"app",entry:"/vbuild/server.js",files:s,minify:!0,shebang:!0,cleanupFiles:!1}),"(2)").run();var s;if(!t.success)return a.logCritical("akr",r`{cyan self} failed at pack (2)`);return await i.upload((e=>[{data:e.resultJs,remote:"/site/fps/dist/akari",mode:511}])(t))?void 0:a.logCritical("akr",r`{cyan self} failed at upload`)})()]),a.logInfo("akr",r`{cyan self} completed successfully`)}},"targets/public":(e,t)=>{const s=require("fs"),r=require("path"),a=require("chalk"),n=t("common"),o=t("tools/ssh");async function i(e,t){return await Promise.all((await s.promises.readdir(t,{withFileTypes:!0})).map((async a=>{const n=r.join(t,a.name);a.isDirectory()?await i(e,n):e.push({remote:n.replace("src","/site/fps/dist"),data:await s.promises.readFile(n)})}))),e}e.build=async function(){n.logInfo("akr",a`{cyan public}`),await o.upload(await i([],"src/public")),n.logInfo("akr",a`{cyan public} complete`)}},"targets/server-core":(e,t)=>{const s=require("chalk"),r=t("common"),a=t("tools/admin"),n=t("tools/ssh"),o=t("tools/typescript"),i=t("tools/mypack"),c=e=>({base:"normal",entry:"src/server-core/index.ts",sourceMap:"hide",watch:e}),l=e=>({type:"app",files:e,entry:"/vbuild/server-core/index.js",sourceMap:!0,output:"dist/main/server.js",printModules:!0,minify:!0}),d=e=>[{remote:"/site/fps/dist/main/server.js",data:e.resultJs},{remote:"/site/fps/dist/main/server.js.map",data:e.resultMap}];async function p(){r.logInfo("akr",s`{cyan server-core}`);const e=o.typescript(c(!1)).check();if(!e.success)return r.logCritical("akr",s`{cyan server-core} failed at check`);const t=await i.mypack(l(e.files)).run();if(!t.success)return r.logCritical("akr",s`{cyan server-core} failed at pack`);if(!await n.upload(d(t)))return r.logCritical("akr",s`{cyan server-core} failed at upload`);r.logInfo("akr",s`{cyan server-core} completed successfully`)}async function u(){r.logInfo("akr",s`watch {cyan server-core}`);const e=i.mypack(l([]));o.typescript(c(!0)).watch((async({files:t})=>{e.options.files=t;const s=await e.run();s.success&&s.hasChange&&(await n.upload(d(s)),a.admin({type:"watchsc",data:"start"}))})),process.on("SIGINT",(()=>{a.admin({type:"watchsc",data:"stop"}).then((()=>process.exit()))}))}e.build=function(e){(e?u:p)()}},"targets/web-page":(e,t)=>{const s=require("fs"),r=require("chalk"),a=t("common"),n=t("tools/admin"),o=t("tools/ssh"),i=t("tools/sass"),c=t("tools/typescript"),l=(e,t)=>({base:"normal",entry:`src/pages/${e}.ts`,additionalLib:["dom"],sourceMap:"no",watch:t}),d=e=>({entry:`src/pages/${e}.sass`}),p=(e,t)=>"html"==t?{remote:`/site/fps/dist/main/${e}.html`,data:s.readFileSync(`src/pages/${e}.html`)}:"files"in t?{remote:`/site/fps/dist/main/${e}.js`,data:Buffer.from(t.files[0].content)}:{remote:`/site/fps/dist/main/${e}.css`,data:t.resultCss};async function u(e){a.logInfo("akr",r`{cyan ${e}-page}`);const t=[p(e,"html")],u=c.typescript(l(e,!1));if(s.existsSync(u.options.entry)){const s=u.check();if(!s.success)return a.logCritical("akr",r`{cyan ${e}-page} failed at check`);t.push(p(e,s))}const m=i.sass(d(e));if(s.existsSync(m.options.entry)){const s=await m.transpile();if(!s.success)return a.logCritical("akr",r`{cyan ${e}-page} failed at transpile`);t.push(p(e,s))}if(!await o.upload(t))return a.logCritical("akr",r`{cyan ${e}-page} failed at upload`);if(!await n.admin({type:"content",data:{type:"reload-page",pagename:e}}))return a.logCritical("akr",r`{cyan ${e}-page} failed at reload`);a.logInfo("akr",r`{cyan ${e}-page} completed succesfully`)}async function m(e){a.logInfo("akr",r`watch {cyan ${e}-page}`);const t=a.watchvar((()=>{n.admin({type:"content",data:{type:"reload-page",pagename:e}})})),u=c.typescript(l(e,!0));s.existsSync(u.options.entry)&&u.watch((async s=>{a.logInfo("tsc","completed with no diagnostics"),await o.upload(p(e,s))&&t()}));const m=i.sass(d(e));s.existsSync(m.options.entry)&&m.watch((async s=>{await o.upload(p(e,s))&&t()}));const f=a.watchvar((async()=>{a.logInfo("htm","reupload"),await o.upload(p(e,"html"))&&t()}),{initialCall:!0}),h=`src/pages/${e}.html`;a.logInfo("htm",r`watch {yellow ${h}}`),s.watch(h,{persistent:!1},f)}e.build=function(e,t){return(t?m:u)(e)}},"targets/app-server":(e,t)=>{const s=require("chalk"),r=t("common"),a=t("tools/admin"),n=t("tools/codegen"),o=t("tools/ssh"),i=t("tools/typescript"),c=t("tools/mypack"),l=(e,t)=>({base:"normal",entry:`src/${e}/server/index.ts`,sourceMap:"hide",watch:t}),d=(e,t)=>({type:"lib",entry:`/vbuild/${e}/server/index.js`,files:t,sourceMap:!0,output:`dist/${e}/server.js`,printModules:!0,minify:!0}),p=(e,t)=>[{remote:`/site/fps/dist/${e}/server.js`,data:t.resultJs},{remote:`/site/fps/dist/${e}/server.js.map`,data:t.resultMap}];async function u(e){r.logInfo("akr",s`{cyan ${e}-server}`);if(!(await n.codegen(e,"server").generate()).success)return r.logCritical("akr",s`{cyan ${e}-server} failed at code generation`);const t=i.typescript(l(e,!1)).check();if(!t.success)return r.logCritical("akr",s`{cyan ${e}-server} failed at check`);const u=await c.mypack(d(e,t.files)).run();if(!u.success)return r.logCritical("akr",s`{cyan ${e}-server} failed at pack`);if(!await o.upload(p(e,u)))return r.logCritical("akr",s`{cyan ${e}-server} failed at upload`);if(!await a.admin({type:"auth",data:{type:"reload-server",app:e}}))return r.logCritical("akr",s`{cyan ${e}-server} failed at reload`);r.logInfo("akr",s`{cyan ${e}-server} complete successfully`)}function m(e,t){r.logInfo(`akr${t??""}`,s`watch {cyan ${e}-server}`),n.codegen(e,"server",t).watch();const u=c.mypack(d(e,[]),t);i.typescript(l(e,!0),t).watch((async({files:s})=>{u.updateFiles(s);const r=await u.run();r.success&&r.hasChange&&await o.upload(p(e,r),{additionalHeader:t})&&await a.admin({type:"auth",data:{type:"reload-server",app:e}},t)}))}e.build=async function(e,t,s){(t?m:u)(e,s)}},"targets/app-client":(e,t)=>{const s=require("fs"),r=require("path"),a=require("zlib"),n=require("antd-dayjs-webpack-plugin"),o=require("chalk"),i=require("dayjs"),c=require("filesize"),l=require("memfs"),d=require("terser-webpack-plugin"),p=require("unionfs"),u=require("webpack"),m=t("common"),f=t("tools/admin"),h=t("tools/codegen"),y=t("tools/ssh"),g=t("tools/sass"),w=t("tools/typescript"),$=(e,t)=>({base:"jsx",entry:`src/${e}/client/index.tsx`,sourceMap:"normal",watch:t}),v=e=>({entry:`src/${e}/client/index.sass`}),k=(e,t)=>Object.entries(t.assets).map((t=>({remote:`/site/fps/dist/${e}/${t[0]}`,data:t[1].data}))),b="AKARIN_APP_CLIENT_OSIZE",x=b in process.env?"0"===process.env[b]?0:parseInt(process.env[b])||2:2;function C(e,t,i,c){m.logInfo(`wpk${c}`,o`${i?"watch":"once"} {yellow src/${e}/client/index.js}`);const f=u((e=>({mode:"development",entry:{client:r.resolve("src",e,"client/index.js")},module:{rules:[{test:/\.js$/,exclude:/node_modules/,enforce:"pre",use:["source-map-loader"]}]},output:{filename:"client.js",path:"/vbuild",pathinfo:!1},devtool:!1,cache:{type:"filesystem",name:`webpack-akari-${e}`,cacheDirectory:r.resolve(".cache")},performance:{hints:!1},optimization:{moduleIds:"deterministic",chunkIds:"deterministic",mangleExports:"deterministic",innerGraph:!0,usedExports:!0,emitOnErrors:!1,flagIncludedChunks:!0,concatenateModules:!0,nodeEnv:"production",splitChunks:{hidePathInfo:!0,cacheGroups:{1:{test:/node_modules\/react\-dom/,priority:20,chunks:"all",filename:"client-vendor1.js"},2:{test:/node_modules\/(rc|\@ant-design)/,priority:20,chunks:"all",filename:"client-vendor2.js"},3:{test:/node_modules\/(antd|lodash)/,priority:20,chunks:"all",filename:"client-vendor3.js"},4:{test:/node_modules/,priority:10,chunks:"all",filename:"client-vendor4.js"}}},minimize:0!=x,minimizer:[new d({terserOptions:{format:{comments:!1},compress:2==x},extractComments:!1})]},plugins:[new n,new u.SourceMapDevToolPlugin({exclude:/vendor/,filename:"[name].js.map"})]}))(e)),h={assets:{}};return f.inputFileSystem=(new p.Union).use(s).use(t),f.outputFileSystem=l.createFsFromVolume(new l.Volume),f.hooks.emit.tap("CompressSizePlugin",(e=>{for(const t of e.getAssets())h.assets[t.name]={data:Buffer.from(t.source.buffer()),compressSize:a.brotliCompressSync(t.source.buffer()).length}})),[f,h]}function S(e,t,r){r=r??"";const a=`/tmp/akari-stats-${i().format("YYYYMMDD-HHmmss")}.txt`,n=e=>t.assets[e].compressSize,l=c(e.assets.reduce(((e,t)=>e+t.size),0)),d=c(e.assets.reduce(((e,t)=>e+n(t.name)),0)||0),p=e.assets.filter((e=>e.name.includes("vendor"))).reduce(((e,t)=>Math.max(e,n(t.name))),0);if(0==e.errorsCount){if(m.logInfo(`wpk${r}`,o`completed with {yellow ${e.assets.length}} assets in ${e.time/1e3}s, `+o`{yellow ${d}} ({${p>3e5?"red":"white"} max ${c(p||0)}})`),e.warningsCount>0){m.logInfo(`wpk${r}`,o`{yellow ${e.warningsCount}} warnings`);for(const{message:t}of e.warnings)console.log("  "+t)}}else{m.logError(`wpk${r}`,o`completed with {red ${e.errorsCount}} errors, stat file {yellow ${a}}`);for(const{message:t}of e.errors)m.logError(`wpk${r}`,t)}let u="";const f=["entry","rendered","initial","recorded"],h=["built","codeGenerated","cached","cacheable","optional","prefetched"];if(u+=`hash ${e.hash} time ${e.time}ms total size ${l} (${d})\n`,e.warningsCount){u+=`${e.warningsCount} warnings:\n`;for(const t of e.warnings)u+=JSON.stringify(t,void 0,1)+"\n"}if(e.errorsCount){u+=`${e.errorsCount} errors:\n`;for(const t of e.errors)u+=JSON.stringify(t,void 0,1)+"\n"}for(const t of e.assets)u+=`asset ${t.name} size ${c(t.size)} compress ${c(n(t.name))} chunks [${t.chunks.join(",")}] chunkNames [${t.chunkNames.join(",")}]\n`;for(const t of e.chunks){u+=`chunk ${t.id} files [${t.files.join(",")}] size ${c(t.size)} flags [${f.filter((e=>t[e])).join(",")}] ${t.modules.length} chunks\n`;for(const e of t.modules)if(u+=`  module ${e.id} size ${c(e.size)} flags [${h.filter((t=>e[t])).join(",")}] name "${e.name}" identifier "${e.identifier}"\n`,/\+ \d+ modules/.test(e.name)&&e.modules)for(const t of e.modules)u+=`    submodule ${t.name} size ${c(t.size)}\n`}s.writeFileSync(a,u)}async function I(e,t,r,a){const n=`src/${e}/index.html`;r||m.logInfo(`htm${a??""}`,o`read {yellow ${n}}`);const i=t[0].map((e=>"/"+e)).concat(r?[`https://${e}.freskyz.com:${await f.getServerPort()}/client-dev.js`]:[]),c=(await s.promises.readFile(n,"utf-8")).replace("<script-placeholder />",i.map((e=>`<script type="text/javascript" src="${e}"><\/script>`)).join("\n  ")).replace("<stylesheet-placeholder />",t[1].map((e=>`<link rel="stylesheet" type="text/css" href="/${e}">`)).join("\n  "));return m.logInfo(`htm${a??""}`,"template rendered"),{remote:`/site/fps/dist/${e}/index.html`,data:Buffer.from(c)}}async function T(e){m.logInfo("akr",o`{cyan ${e}-client}`);const t=(async()=>{const t=h.codegen(e,"client");if(s.existsSync(t.definitionFile)){if(!(await t.generate()).success)return m.logCritical("akr",o`{cyan ${e}-client} failed at codegen`)}const r=w.typescript($(e,!1)).check();if(!r.success)return m.logCritical("akr",o`{cyan ${e}-client} failed at check`);const a=l.Volume.fromJSON(r.files.reduce(((e,t)=>(e[t.name]=t.content,e)),{})),[n,i]=C(e,a,!1),c=await new Promise((e=>n.run(((t,s)=>e({error:t,statsObject:s})))));if(c.error)return m.logError("wpk",JSON.stringify(c.error,void 0,1)),m.logCritical("akr",o`{yellow ${e}-client} failed at pack (1)`);const d=c.statsObject.toJson();return S(d,i),d.errorsCount>0?m.logCritical("akr",o`{cyan ${e}-client} failed at pack (2)`):(n.close((e=>{e&&m.logError("wpk","failed to close compiler",e)})),k(e,i))})(),a=(async()=>{const t=await g.sass(v(e)).transpile();return t.success?[{remote:`/site/fps/dist/${e}/index.css`,data:t.resultCss}]:m.logCritical("akr",o`{cyan ${e}-client} failed at transpile`)})(),n=await Promise.all([t,a]),i=await I(e,[n[0].map((e=>r.basename(e.remote))).filter((e=>e.endsWith(".js"))),n[1].map((e=>r.basename(e.remote)))],!1);if(!await y.upload(n[0].concat(n[1]).concat([i]),{filenames:!1}))return m.logCritical("akr",o`{cyan ${e}-client} failed at upload`);if(!await f.admin({type:"content",data:{type:"reload-client",app:e}}))return m.logCritical("akr",o`{cyan ${e}-client} failed at reload`);m.logInfo("akr",o`{cyan ${e}-client} complete successfully`)}function q(e,t){t=t??"",m.logInfo(`akr${t}`,o`watch {cyan ${e}-client}`);let[a,n]=[[],[]],i=!1;const c=m.watchvar((async()=>{const s=i?{type:"webpage",data:"reload-js"}:{type:"webpage",data:"reload-css"};i=!1;const o=await I(e,[a.map((e=>r.basename(e.remote))).filter((e=>e.endsWith(".js"))),n.map((e=>r.basename(e.remote)))],!0,t);a.length>0&&await y.upload(a.concat(n).concat([o]),{filenames:!1,additionalHeader:t})&&(await f.admin({type:"content",data:{type:"reload-client",app:e}},t),await f.admin(s,t))})),d=h.codegen(e,"client",t);s.existsSync(d.definitionFile)&&d.watch();const p=new l.Volume,[u,b]=C(e,p,!0,t);let x=[],T=null;w.typescript($(e,!0),t).watch((async({files:s})=>{for(const{name:e,content:t}of s)p.existsSync(e)||e.endsWith(".map")||console.log(o`   + ${e}`),await p.promises.mkdir(r.dirname(e),{recursive:!0}),await p.promises.writeFile(e,t);x=s,u.running?m.logError(`wpk${t}`,"already repacking, discard"):(m.logInfo(`wpk${t}`,"repack"),u.run(((s,n)=>{if(s)return void m.logError(`wpk${t}`,"webpack fatal error",s);const l=n.toJson();S(l,b,t),function(e,t,s){const a=[],n=r.resolve("src");for(const t of e.modules)if(/\+ \d+ modules/.test(t.name)&&t.modules)for(const e of t.modules){const t=r.resolve(e.name);t.startsWith(n)&&a.push(t)}else{const e=r.resolve(t.name);e.startsWith(n)&&a.push(e)}const i=t.filter((e=>!a.includes(e.name)&&!a.some((t=>t+".map"==e.name))));for(const e of i)t.splice(t.indexOf(e),1),s.unlinkSync(e.name),e.name.endsWith(".map")||console.log(o`   {gray - ${e.name}}`)}(l,x,p),0==l.errorsCount&&(l.hash!=T?(T=l.hash,a=k(e,b),i=!0,c()):m.logInfo(`wpk${t}`,o`completed with {gray no change}`),u.close((e=>{e&&m.logError("wpk","failed to close compiler",e)})))})))})),g.sass(v(e),t).watch((t=>{n=[{remote:`/site/fps/dist/${e}/index.css`,data:t.resultCss}],c()}))}e.build=function(e,t,s){(t?q:T)(e,s)}},"tools/admin":(e,t)=>{const s=require("crypto"),r=require("fs"),a=require("https"),n=require("chalk"),o=t("common"),i=t("tools/ssh"),c=r.readFileSync("/etc/pi.txt","utf-8");let l=null;async function d(){if(!l){const e=await i.download("/site/fps/dist/akariv",!0);if(!e)return o.logCritical("adm","fail to getv (1)");const t=e[0].data.toString();if(l=t.split(":").map((e=>parseInt(e))),3!=l.length||l.some((e=>!e)))return o.logCritical("adm","fail to getv (2)")}return l}e.getServerPort=async()=>(await d())[0];e.admin=(e,t)=>new Promise((r=>{const i=`adm${t??""}`,l=JSON.stringify(e);d().then((t=>{const d=s.scryptSync(c.slice(t[1],32),c.slice(t[2],32),32),p=s.randomFillSync(new Uint8Array(16)),u=s.createCipheriv("aes-256-cbc",d,p),m=[];u.on("data",(e=>m.push(Buffer.from(e)))),u.write(l),u.end();const f=Buffer.concat(m).toString("hex"),h=Buffer.from(p).toString("hex")+f,y=a.request({host:"freskyz.com",method:"POST",port:t[0]});y.on("error",(e=>{"ECONNREFUSED"==e.code?o.logError(i,"cannot connect akari (server)"):o.logError(i,`request error ${e.message}`,e),r(!1)})),y.on("socket",(e=>{e.on("error",(e=>{r(!1)})),y.write(h),y.end()})),y.on("response",(t=>{if(200!=t.statusCode)o.logError(i,`response ${t.statusCode}`),r(!1);else if("service"==e.type)t.pipe(process.stdout),t.on("end",(()=>r(!0)));else if("watchsc"==e.type){if("stop"==e.data)t.on("data",(()=>{})),t.on("end",(()=>{o.logInfo(i,n`ack stop watch server-core`),r(!0)}));else if("start"==e.data){let e=!1,s=Buffer.alloc(0);t.on("data",(a=>{if(!e){if(s=Buffer.concat([s,Buffer.from(a)]),s.length<4)return;{e=!0;const a=s.slice(0,4).toString();"that"==a?(o.logInfo(i,n`ack {yellow restart watch server-core}`),r(!0)):"this"==a?(process.stdout.write(s.slice(4)),t.pipe(process.stdout)):(o.logError(i,`start watch server-core received unexpected header ${a}`),r(!1))}}})),t.on("end",(()=>r(!0)))}}else{let s="";t.on("data",(e=>{s+=e})),t.on("end",(()=>{s=="ACK "+l?(o.logInfo(i,n`{cyan ACK} {yellow ${o.formatAdminPayload(e)}}`),r(!0)):(o.logError(i,"unexpected response "+s),r(!1))}))}}))}))}))},common:(e,t)=>{const s=require("fs"),r=require("chalk"),a=require("dayjs");e.getCompileTimeConfig=()=>JSON.parse(s.readFileSync("akari.config","utf-8")),e.logInfo=function(e,t,s){s?console.log(r`[{green ${a().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`,s):console.log(r`[{green ${a().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`)},e.logError=function(e,t,s){s?console.log(r`[{green ${a().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`,s):console.log(r`[{green ${a().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`)},e.logCritical=function(e,t){return console.log(r`[{green ${a().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`),process.exit(1)},e.watchvar=function(e,t){let s=!1;return setInterval((()=>{s&&(s=!1,e())}),t?.interval??3001),t?.initialCall&&e(),()=>s=!0},e.formatAdminPayload=function(e){switch(e.type){case"ping":return"ping";case"shutdown":return"shutdown";case"webpage":switch(e.data){case"reload-js":return"reload-js";case"reload-css":return"reload-css"}case"content":switch(e.data.type){case"reload-client":return`reload-client ${e.data.app}`;case"reload-page":return`reload-page ${e.data.pagename}`;case"enable-source-map":return"source-map enable";case"disable-source-map":return"source-map disable"}case"auth":switch(e.data.type){case"reload-server":return`reload-server ${e.data.app}`;case"enable-signup":return"enable-signup";case"disable-signup":return"disable-signup";default:return JSON.stringify(e.data)}case"service":switch(e.data){case"start":return"systemctl start";case"status":return"systemctl status";case"stop":return"systemctl stop";case"restart":return"systemctl restart";case"is-active":return"systemctl is-active"}case"watchsc":switch(e.data){case"start":return"start watch server-core";case"stop":return"stop watch server-core"}default:return JSON.stringify(e)}}},"tools/typescript":(e,t)=>{const s=require("path"),r=require("typescript"),a=require("chalk"),n=t("common"),o={lib:["lib.esnext.d.ts"],target:r.ScriptTarget.ESNext,module:r.ModuleKind.CommonJS,moduleResolution:r.ModuleResolutionKind.NodeJs,skipLibCheck:!0,noEmitOnError:!0,strict:"AKARIN_TS_STRICT"in process.env,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictNullChecks:"AKARIN_TS_STRICT"in process.env,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function i({category:e,code:t,messageText:s,file:o,start:i},c){if(6031!=t)if(6032==t)n.logInfo(`tsc${c}`,"recheck");else{if(6194==t)return;{const n=(0,{[r.DiagnosticCategory.Warning]:a.red,[r.DiagnosticCategory.Error]:a.red,[r.DiagnosticCategory.Suggestion]:a.green,[r.DiagnosticCategory.Message]:a.cyan}[e])(`  TS${t} `);let c="";if(o&&i){const{line:e,character:t}=r.getLineAndCharacterOfPosition(o,i);c=a`{yellow ${o.fileName}:${e+1}:${t+1}} `}let l=r.flattenDiagnosticMessageText(s,"\n");l.includes("\n")&&(l="\n"+l),console.log(n+c+l)}}}const c=n.getCompileTimeConfig();function l(){const e=r.sys.readFile;r.sys.readFile=(t,s)=>{let r=e(t,s);if(!t.endsWith(".d.ts"))for(const e in c)r=r.replaceAll(e,c[e]);return r}}function d(e,t){return(s,r)=>{if(s.endsWith(".js")){r.startsWith('"use strict"')&&(r=r.slice(r.indexOf("\n")+1)),r.startsWith("Object.defineProperty")&&(r=r.slice(r.indexOf("\n")+1)),r.startsWith("exports.")&&(r=r.slice(r.indexOf("\n")+1));const t=/\/\/#\s*sourceMappingURL/.exec(r);t&&"hide"==e.sourceMap?r=r.slice(0,t.index):r.endsWith("\n")||(r+="\n")}const a=t.findIndex((e=>e.name==s));a>=0?t.splice(a,1,{name:s,content:r}):t.push({name:s,content:r})}}class p{constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??"",this.compilerOptions=function(e){return"normal"==e.base?{...o,outDir:"/vbuild",sourceMap:"no"!=e.sourceMap,lib:"additionalLib"in e?[...o.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:o.lib}:{...o,outDir:s.resolve("src"),target:r.ScriptTarget.ES2018,sourceMap:!0,esModuleInterop:!0,module:r.ModuleKind.ESNext,jsx:r.JsxEmit.ReactJSX,lib:[...o.lib,"lib.dom.d.ts"]}}(e)}check(){n.logInfo("tsc",a`once {yellow ${this.options.entry}}`),l();const e=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry],t=[];return{success:function(e){const t=e.diagnostics.filter((e=>e.category==r.DiagnosticCategory.Error||r.DiagnosticCategory.Warning)).length,s=e.diagnostics.length-t;let o;o=0==s&&0==t?"no diagnostic":0!=s&&0==t?a`{yellow ${s}} infos`:0==s?a`{yellow ${t}} errors`:a`{yellow ${t}} errors and {yellow ${s}} infos`,(e.emitSkipped?n.logError:n.logInfo)("tsc",`completed with ${o}`);for(const t of e.diagnostics)i(t);return!e.emitSkipped}(r.createProgram(e,this.compilerOptions,r.createCompilerHost(this.compilerOptions)).emit(void 0,d(this.options,t))),files:t}}watch(e){n.logInfo(`tsc${this.additionalHeader}`,a`watch {yellow ${this.options.entry}}`),l();const t=[],s=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry];setImmediate((()=>{r.createWatchProgram(r.createWatchCompilerHost(s,this.compilerOptions,r.sys,((...s)=>{const a=r.createEmitAndSemanticDiagnosticsBuilderProgram(...s),n=a.emit;return a.emit=(s,r,...a)=>{const o=n(s,d(this.options,t),...a);return o.emitSkipped||e({files:t}),o},a}),(e=>i(e,this.additionalHeader)),(e=>i(e,this.additionalHeader))))}))}}e.typescript=function(e,t){return new p(e,t)}},"tools/mypack":(e,t)=>{const s=require("path"),r=require("chalk"),a=require("crypto-js"),n=require("filesize"),o=require("source-map"),i=require("terser"),c=t("common");function l(e){const t=/\n/g,s=[];for(;;){const r=t.exec(e);if(!r)break;s.push(r.index)}return function(e){let t=s.findIndex((t=>t>e));return t<0?`${s.length+1}:${e-(s.length?s[s.length-1]:0)+1}`:0==t?`1:${e}`:`${t+1}:${e-s[t-1]+1}`}}class d{constructor(e,t){this.options=e,this.lastHash=null,this.lastModules=null,this.logHeader=t?`mpk${t}`:"mpk"}updateFiles(e){this.options.files=e}getSources(){return this.options.files.filter((e=>e.name.endsWith(".js"))).map((({name:e,content:t})=>({filename:e,jsContent:t,mapContent:this.options.files.find((t=>t.name==e+".map"))?.content,mapIndex:l(t)})))}processModule(e,t){let r=s.relative(s.dirname(this.options.entry),e.filename);r.endsWith(".js")&&(r=r.slice(0,-3)),r.endsWith("index")&&(r=r.slice(0,-5)),0==r.length&&(r=".");const n=[],o=/require\("(?<request>\.[\.\w\-\/]*)"\);/g;for(;;){const r=o.exec(e.jsContent);if(!r)break;const a=r.groups.request,i=s.resolve(s.dirname(e.filename),a),l=t.some((e=>e.filename==i))?i:t.some((e=>e.filename==i+".js"))?i+".js":t.some((e=>e.filename==i+"/index.js"))?i+"/index.js":null;if(!l)return c.logError(this.logHeader,`${e.filename}: invalid module name ${a} at ${e.mapIndex(r.index)}`),null;let d=s.relative(s.dirname(this.options.entry),l);d=d.slice(0,-3),d.endsWith("index")&&(d=d.slice(0,-5)),0==d.length&&(d="."),n.push({index:r.index,raw:a,resolvedFileName:l,resolvedModuleName:d})}let i=0,l="";for(const{index:t,raw:s,resolvedModuleName:r}of n)l+=e.jsContent.slice(i,t),l+=`myimport("${r}");`,i=t+s.length+12;return l+=e.jsContent.slice(i),{name:r,source:e,requests:n,content:l,hash:a.SHA256(l).toString()}}checkCircularReference(e){const t=this,s=[{moduleName:e[0].name,parentFileName:"",parentRequirePosition:"",parentRequireRaw:""}];try{return function a(n){for(const o of n.requests){const i=e.find((e=>e.name==o.resolvedModuleName));if(s.some((e=>e.moduleName==i.name))){c.logError(t.logHeader,"circular reference encountered");for(const e of s.slice(1))console.log(r`   {${e.parentFileName==i.source.filename?"yellow":"white"} ${e.parentFileName}}`+r`:${e.parentRequirePosition}:{gray require("}${e.parentRequireRaw}{gray ")}`);throw console.log(r`   ${n.source.filename}:${n.source.mapIndex(o.index)}:{gray require("}{yellow ${o.raw}}{gray ")}`),new Error("circular reference")}s.push({parentFileName:n.source.filename,parentRequirePosition:n.source.mapIndex(o.index),parentRequireRaw:o.raw,moduleName:i.name}),a(i),s.pop()}}(e[0]),!1}catch(e){if("circular reference"==e.message)return!0;throw e}}emitRuntimePrefix(e,t){this.options.shebang&&(e.sb+="#!/usr/bin/env node\n",e.lineOffset+=1),e.sb+="app"==this.options.type?`((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`:`module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`,e.lineOffset+=2}async emitModule(e,t){if(e.sb+=`'${t.name}': (exports, myimport) => {\n${t.content}}, `,e.lineOffset+=1,e.generator&&!t.source.mapContent){let r=null;(await new o.SourceMapConsumer(JSON.parse(t.source.mapContent))).eachMapping((t=>{null===r&&(r=t.generatedLine),e.generator.addMapping({source:s.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-r+e.lineOffset+1,column:t.generatedColumn}})})),e.lineOffset+=t.content.split("\n").length-1}}emitRuntimePostfix(e){e.sb+="})\n"}cleanupMemoryFile(e,t){const s=t.filter((t=>!e.some((e=>e.source.filename==t.name))&&!e.some((e=>e.source.filename+".map"==t.name))));for(const e of s)t.splice(t.indexOf(e),1),e.name.endsWith(".map")||console.log(r`   {gray - ${e.name}}`)}printResult(e,t){if(c.logInfo(this.logHeader,r`completed with {yellow 1} asset {yellow ${n(e)}}`),this.options.printModules){const e=this.lastModules;if(e){for(const s of t.filter((t=>!e.some((e=>e.source==t.source.filename)))))console.log(r`  {gray +} ${s.name} ({gray ${s.source.filename}}) ${n(s.content.length)}`);for(const[s]of t.map((t=>[t,e.find((e=>e.source==t.source.filename))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(r`  {gray *} ${s.name} ({gray ${s.source.filename}}) ${n(s.content.length)}`);for(const s of e.filter((e=>!t.some((t=>t.source.filename==e.source)))))console.log(r`  {gray - removed} ${s.name} ({gray ${s.source}})`)}else for(const{name:e,source:s,content:a}of t){const t=s.filename.startsWith("/vbuild/")?s.filename.slice(8):s.filename;console.log(r`   {gray +} ({gray ${t}}) {greenBright ${e}} ${n(a.length)}`)}}}async run(){const e=this.options.entry;c.logInfo(this.logHeader,this.lastHash?"repack":r`pack {yellow ${e.startsWith("/vbuild/")?e.slice(8):e}}`);const t=this.getSources();if(!t.some((t=>t.filename==e)))return c.logError(this.logHeader,"invalid entry"),{success:!1};const s=[],n=[e];for(let e=0;e<n.length;++e){const r=this.processModule(t.find((t=>t.filename==n[e])),t);if(!r)return{success:!1};n.push(...r.requests.map((e=>e.resolvedFileName)).filter((e=>!n.includes(e)))),s.push(r)}if(this.checkCircularReference(s))return{success:!1};const l={sb:"",lineOffset:0,generator:this.options.sourceMap?new o.SourceMapGenerator({file:this.options.output}):null};this.emitRuntimePrefix(l,s[0].name);for(const e of s)await this.emitModule(l,e);this.emitRuntimePostfix(l);let d=l.sb,p=l.generator?.toString();if(this.options.minify){const e=await i.minify(d,{sourceMap:!!this.options.sourceMap&&{content:p,filename:this.options.output,url:this.options.output+".map"},format:{max_line_len:"AKARIN_SELF_MULTILINE"in process.env?120:void 0}});d=e.code,p="object"==typeof e.map?JSON.stringify(e.map):e.map}const u=a.SHA256(d).toString(),m=u!=this.lastHash;return m?this.printResult(d.length,s):c.logInfo(this.logHeader,r`completed with {gray no change}`),"cleanupFiles"in this.options&&!this.options.cleanupFiles||this.cleanupMemoryFile(s,this.options.files),this.lastHash=u,this.lastModules=s.map((e=>({name:e.name,source:e.source.filename,hash:e.hash}))),{success:!0,hasChange:m,resultJs:Buffer.from(d),resultMap:p?Buffer.from(p):void 0}}}e.mypack=function(e,t){return new d(e,t)}},"tools/ssh":(e,t)=>{const s=require("fs"),r=require("path"),a=require("stream"),n=require("chalk"),o=require("ssh2-sftp-client"),i=t("common");e.upload=async function(e,t){e=Array.isArray(e)?e:[e];const a=new o;for(const t of e)if(!t.data||!Buffer.isBuffer(t.data))return i.logError("ssh",`${r.basename(t.remote)} invalid data`),!1;try{await a.connect({host:"freskyz.com",username:"root",privateKey:await s.promises.readFile("/home/fresky/.ssh/id_freskyz_com_rsa"),passphrase:"123456"});for(const t of e)await a.put(t.data,t.remote,{mode:t.mode||420});return await a.end(),i.logInfo(`ssh${t?.additionalHeader??""}`,n`upload {yellow ${e.length}} files ${t?.filenames?e.map((e=>n.yellow(r.basename(e.remote)))):""}`),!0}catch(e){return i.logError(`ssh${t?.additionalHeader??""}`,"error "+e.message),!1}},e.download=async function(e,t){e=Array.isArray(e)?e:[e];const r=new o;try{await r.connect({host:"freskyz.com",username:"root",privateKey:await s.promises.readFile("/home/fresky/.ssh/id_freskyz_com_rsa"),passphrase:"123456"});const o=[];for(const t of e){const e=[];await r.get(t,new a.Writable({write(t,s,r){e.push(Buffer.from(t,s)),r()}})),o.push({remote:t,data:Buffer.concat(e)})}return await r.end(),t||i.logInfo("ssh",n`download {yellow ${o.length}} file`),o}catch(e){return i.logError("ssh","error "+e.message),null}}},"tools/sass":(e,t)=>{const s=require("fs"),r=require("chalk"),a=require("sass"),n=t("common");class o{constructor(e,t){this.options=e,this.additionalHeader=t,this.transpile=()=>new Promise((e=>{n.logInfo("css",r`once {yellow ${this.options.entry}}`),a.render({file:this.options.entry,outputStyle:"compressed"},((t,s)=>{t?(n.logError("css",`error at ${t.file}:${t.line}:${t.column}: ${t.message}`),e({success:!1})):(n.logInfo("css",`completed in ${s.stats.duration}ms`),e({success:!0,resultCss:s.css}))}))})),this.additionalHeader=this.additionalHeader??""}watch(e){const t=`css${this.additionalHeader}`;n.logInfo(t,r`watch {yellow ${this.options.entry}}`);const o=[],i={file:this.options.entry,outputStyle:"compressed"};let c="none",l=[this.options.entry];!function r(){c="running";for(const e of o)e.close();o.splice(0,o.length),a.render(i,((a,i)=>{a?n.logError(t,`error at ${a.file}:${a.line}:${a.column}: ${a.message}`):(n.logInfo(t,`completed in ${i.stats.duration}ms`),e({success:!0,resultCss:i.css}),l=i.stats.includedFiles);for(const e of l)o.push(s.watch(e,{persistent:!1},(()=>{"running"==c?(n.logInfo(t,"retranspile waiting"),c="pending"):"none"==c&&(n.logInfo(t,"retranspile (1)"),r())})));"pending"==c?(n.logInfo(t,"retranspile (2)"),r()):"running"==c&&(c="none")}))}()}}e.sass=function(e,t){return new o(e,t)}},"tools/codegen":(e,t)=>{const s=require("fs"),r=require("chalk"),a=require("xml2json"),n=t("common"),o=["GET","POST","PUT","PATCH","DELETE"],i={GET:"get",POST:"post",PUT:"put",PATCH:"patch",DELETE:"del"},c=["id","number","string","boolean","date","time"],l={id:{pattern:"\\d+",validator:"validateId",tsType:"number"},number:{pattern:"\\d+",validator:"validateNumber",tsType:"number"},string:{pattern:".+",validator:"validateString",tsType:"string"},boolean:{pattern:"(true|false)",validator:"validateBoolean",tsType:"boolean"},date:{pattern:"\\d{6}",validator:"validateDate",tsType:"Dayjs"},time:{pattern:"\\d{12}",validator:"validateTime",tsType:"Dayjs"}};const d=e=>`src/${e}/api.xml`;async function p(e){const t=await s.promises.readFile(d(e),"utf-8"),{version:r,api:n}=a.toJson(t,{object:!0})[`${e}-api`];return{version:r,definitions:n.map(((e,t)=>{const s=e.name;if(!s)throw new Error(`index ${t} api name is required`);const r=e.method;if(!o.includes(r))throw new Error(`api ${s} invalid method`);const a=e.path;if(!a)throw new Error(`api ${s} path is required`);if(!a.startsWith("/"))throw new Error(`api ${s} path should be absolute`);const n=function(e,t){const s=[];for(;;){const r=/\{(?<parameterName>[\w\_]+):(?<parameterType>\w+)\}/.exec(t);if(!r)break;if(10==s.filter((e=>"parameter"==e.type)).length)throw new Error(`api ${e} too many parameters`);const[a,n]=[r.groups.parameterName,r.groups.parameterType];if(!c.includes(n))throw new Error(`api ${e} parameter ${a} invalid type ${n}`);0!=r.index&&s.push({type:"normal",value:t.slice(0,r.index)}),s.push({type:"parameter",parameterName:a,parameterType:n}),t=t.slice(r.index+a.length+n.length+3)}return t.length&&s.push({type:"normal",value:t}),s}(s,a),[i,l]=[e["body-type"],e["body-name"]];if(["POST","PUT","PATCH"].includes(r)&&(!i||!l))throw new Error(`api ${s} body is required for ${r}`);return{namespace:e.namespace||"default",apiName:s,method:r,apiPath:n,bodyType:i,bodyName:l,returnType:e["return-type"]||"void"}}))}}class u{constructor(e,t,s){this.app=e,this.target=t,this.additionalHeader=s,this.additionalHeader=this.additionalHeader??"",this.definitionFile=d(this.app)}generate(){return"server"==this.target?async function(e,t){const a=`src/${e}/server/index.ts`;let o;n.logInfo(`fcg${t}`,r`generate {yellow ${a}}`);try{o=await p(e)}catch(e){return n.logError(`fcg${t}`,e.message),{success:!1}}const{version:i,definitions:d}=o;let u="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==d.length)return u+="// empty\n",await s.promises.writeFile(a,u),n.logInfo(`fcg${t}`,"generate completed with empty"),{success:!0};u+=`import { WebContext, ${c.filter((e=>d.some((t=>t.apiPath.some((t=>"parameter"==t.type&&t.parameterType==e)))))).map((e=>l[e].validator)).concat(d.some((e=>["PUT","POST","PATCH"].includes(e.method)))?["validateBody"]:[]).join(", ")} } from '../../shared/api-server';\n`,u+="import { MyError } from '../../shared/error';\n";for(const e of d.map((e=>e.namespace)).filter(((e,t,s)=>s.indexOf(e)==t)))u+=`import { ${d.filter((t=>t.namespace==e)).map((e=>e.apiName)).join(", ")} } from './${e}';\n`;u+="\n",u+="export async function dispatch(ctx: WebContext) {\n",u+="    let match: RegExpExecArray;\n",u+=`    if (!ctx.path.startsWith('/${e}/v${i}')) { throw new MyError('not-found', 'invalid invocation version'); }\n`,u+=`    const methodPath = \`\${ctx.method} \${ctx.path.slice(${e.length+i.length+3})}\`;\n`,u+="\n";for(const e of d){const{apiName:t,method:s,apiPath:r,bodyType:a,returnType:n}=e;u+=`    match = /^${s} `;for(const e of r)"normal"==e.type?u+=e.value.replaceAll("/","\\/"):u+=`(?<${e.parameterName}>${l[e.parameterType].pattern})`;u+="$/.exec(methodPath); if (match) {\n",u+="        ",n&&"void"!=n&&(u+="ctx.body = "),u+=`await ${t}(ctx.state`;for(const{parameterName:e,parameterType:t}of r.filter((e=>"parameter"==e.type)))u+=`, ${l[t].validator}('${e}', match.groups['${e}'])`;a&&(u+=", validateBody(ctx.request.body)"),u+=");\n","POST"==s?u+="        ctx.status = 201;\n":"DELETE"==s&&(u+="        ctx.status = 204;\n"),u+="        return;\n",u+="    }\n"}return u+="\n",u+="    throw new MyError('not-found', 'invalid invocation');\n",u+="}\n",await s.promises.writeFile(a,u),n.logInfo(`fcg${t}`,"generate completed"),{success:!0}}(this.app,this.additionalHeader):async function(e,t){const a=`src/${e}/client/api.ts`;let c;n.logInfo(`fcg${t}`,r`generate {yellow ${a}}`);try{c=await p(e)}catch(e){return n.logError(`fcg${t}`,e.message),{success:!1}}const{version:d,definitions:u}=c;let m="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==u.length)return m+="// empty\n",await s.promises.writeFile(a,m),n.logInfo(`fcg${t}`,"generate completed with empty"),{success:!0};u.some((e=>e.apiPath.some((e=>"parameter"==e.type&&["date","time"].includes(e.parameterType)))))&&(m+="import type { Dayjs } from 'dayjs';\n"),m+=`import { ${o.filter((e=>u.some((t=>t.method==e)))).map((e=>i[e])).join(", ")} } from '../../shared/api-client';\n`;const f=u.filter((e=>!!e.bodyType)).map((e=>e.bodyType)),h=u.filter((e=>"void"!=e.returnType)).map((e=>e.returnType.endsWith("[]")?e.returnType.slice(0,-2):e.returnType));m+=`import type { ${f.concat(h).filter(((e,t,s)=>s.indexOf(e)==t)).join(", ")} } from '../api';\n`,m+="\n";for(const t of u){const{apiName:s,method:r,apiPath:a,bodyType:n,bodyName:o,returnType:c}=t;m+=`export const ${s} = (`;for(const{parameterName:e,parameterType:t}of a.filter((e=>"parameter"==e.type)))m.endsWith("(")||(m+=", "),m+=`${e}: ${l[t].tsType}`;n&&(m.endsWith("(")||(m+=", "),m+=`${o}: ${n}`),m+=`): Promise<${c}> => ${i[r]}(\`/${e}/v${d}`;for(const e of a)"normal"==e.type?m+=e.value:"date"==e.parameterType?m+=`\${${e.parameterName}.format('YYYYMMDD')}`:"time"==e.parameterType?m+=`\${${e.parameterName}.format('YYYYMMDDHHmmdd')}`:m+=`\${${e.parameterName}}`;m+="`",n&&(m+=`, ${o}`),m+=");\n"}return await s.promises.writeFile(a,m),n.logInfo(`fcg${t}`,"generate completed"),{success:!0}}(this.app,this.additionalHeader)}watch(){n.logInfo(`fcg${this.additionalHeader}`,r`watch {yellow ${this.definitionFile}}`);let e=!0;s.watch(this.definitionFile,{persistent:!1},(()=>{e=!0})),setInterval((()=>{e&&(e=!1,this.generate())}),3007)}}e.codegen=function(e,t,s){return new u(e,t,s)}}});