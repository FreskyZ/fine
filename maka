#!/usr/bin/env node
(e=>{const o={};!function n(s){return s in o||(o[s]={},e[s](o[s],n)),o[s]}("index")})({"admin-base":(e,o)=>{const n=require("net");const s=new(require("async-mutex").Mutex);e.send=async function(e){await s.runExclusive((async()=>await async function(e){const o=n.createConnection("/tmp/fps.socket").ref();return new Promise(((n,s)=>{const t=JSON.stringify(e);o.on("error",(e=>{"code"in e&&"ENOENT"==e.code?(console.log(`[adm] admin socket not open, command ${t} discarded`),n()):(console.log(`[adm] socket error: ${e.message}`),s())})),o.on("timeout",(()=>{console.log("[adm] socket timeout"),o.destroy(),s()})),o.once("data",(e=>{"ACK"==e.toString("utf-8")&&(console.log(`[adm] command ${t} acknowledged`),setTimeout((()=>{o.destroy(),n()}),0))})),o.write(t)}))}(e)))}},"run-typescript":(e,o)=>{const n=require("typescript"),s=require("chalk");e.ModuleKind=n.ModuleKind,e.ModuleResolutionKind=n.ModuleResolutionKind;const t={lib:["lib.es2020.d.ts"],target:n.ScriptTarget.ES2020,module:n.ModuleKind.CommonJS,moduleResolution:n.ModuleResolutionKind.NodeJs,noEmitOnError:!0,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0},i={[n.DiagnosticCategory.Warning]:s.red,[n.DiagnosticCategory.Error]:s.red,[n.DiagnosticCategory.Suggestion]:s.green,[n.DiagnosticCategory.Message]:s.cyan};function r({category:e,code:o,messageText:t,file:r,start:c}){const l=6031==o||6032==o?s`[{cyan tsc}] `:(0,i[e])(`  TS${o} `);let a="";if(r){const{line:e,character:o}=n.getLineAndCharacterOfPosition(r,c);a=s`{yellow ${r.fileName}:${e+1}:${o+1}} `}let d=n.flattenDiagnosticMessageText(t,"\n");d.includes("\n")&&(d="\n"+d),console.log(l+a+d)}e.compile=function(e,o){console.log(`[tsc] transpiling ${e}`);const i={...t,...o,lib:"lib"in o?[...t.lib,...o.lib]:t.lib},c=function(e){const o=n.createCompilerHost(e);if(e.readFileHook){const n=o.readFile;o.readFile=o=>e.readFileHook(o,n)}if(e.writeFileHook){const n=o.writeFile;o.writeFile=(o,s,t,i,r)=>e.writeFileHook(o,s,t,i,r,n)}return o}(i),l=n.createProgram(Array.isArray(e)?e:[e],i,c),{diagnostics:a}=l.emit(),{success:d,message:u}=function(e){const o=e.filter((e=>e.category==n.DiagnosticCategory.Error||n.DiagnosticCategory.Warning)).length,t=e.length-o;let i;return i=0==t&&0==o?"no diagnostic":0!=t&&0==o?s`{yellow ${t}} infos`:0==t?s`{yellow ${o}} errors`:s`{yellow ${o}} errors and {yellow ${t}} infos`,{success:0==o,message:i}}(a);return console.log(s`[tsc] transpile completed with ${u}`),a.map(r),a.length>0&&console.log("[tsc] end of transpile diagnostics"),d},e.watch=function(e,o){if(console.log(`[tsc] transpiling watching ${e}`),o.watchReadFileHook){const e=n.sys.readFile;n.sys.readFile=(n,s)=>o.watchReadFileHook(n,s,e)}if(o.watchWriteFileHook){const e=n.sys.writeFile;n.sys.writeFile=(n,s,t)=>o.watchWriteFileHook(n,s,t,e)}n.createWatchProgram(n.createWatchCompilerHost([e],{...t,...o},n.sys,n.createEmitAndSemanticDiagnosticsBuilderProgram,r,r))}},"build-self":(e,o)=>{const n=require("fs"),s=require("path"),t=require("terser"),i=o("run-typescript"),r=["script/index.ts"],c={types:["node"],outDir:"script/bin"};function l(e){return(o,n)=>{o=s.basename(o).slice(0,-3),(n=n.slice(n.indexOf("\n",n.indexOf("\n")+1)+1)).startsWith("exports.")&&(n=n.slice(n.indexOf("\n")+1)),n=(n=n.split(/}\s*else/).join("} else")).split('require("./').join('myrequire("'),e.push({name:o,content:n})}}e.build=async function(){console.log("[bud] building self");const e=[];i.compile(r,{...c,writeFileHook:l(e)})||(console.log("[bud] build self failed at transpiling"),process.exit(1));const o=`#!/usr/bin/env node\n((modules) => { const mycache = {};\n(function myrequire(name) { if (!(name in mycache)) { mycache[name] = {}; modules[name](mycache[name], myrequire); } return mycache[name]; })('index'); })({\n${e.map((({name:e,content:o})=>`'${e}': (exports, myrequire) => {\n${o}}`))}\n})\n`,{code:s}=await t.minify(o,{});n.writeFileSync("maka",s),console.log("[bud] build self completed successfully")}},common:(e,o)=>{const n=require("fs");e.projectDirectory="<PROJECTDIR>",e.nodePackage=JSON.parse(n.readFileSync("package.json","utf-8")),process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},"run-webpack":(e,o)=>{const n=require("chalk"),s=require("filesize"),t=require("webpack");function i(e,o){console.log(n`[{cyan wpb}] bundled {yellow ${e.assets.length}} asset in {yellow ${e.time}ms}, hash {yellow ${e.hash}}`);for(const o of e.errors)console.error(`error: ${o.message}`);for(const o of e.warnings)console.error(`warning: ${o}`);const t=e.chunks.reduce(((e,o)=>(e.push(...o.modules),e)),[]);if(null==o){for(let o=0;o<e.assets.length;++o){const t=e.assets[o];console.log(n`  {gray asset#}${o} {yellow ${t.name}}`+n` {gray size} {yellow ${s(t.size)}} {gray chunks} [${t.chunks.join(", ")}]`)}for(const o of e.chunks){console.log(n`  {gray chunk#}${o.id} {yellow ${o.names.join(",")}} {gray size} {yellow ${s(o.size)}}`);const e=[];for(let t=0;t<o.modules.length;++t){const i=o.modules[t];i.name.startsWith("external")?e.push(i.name.slice(10,-1)):console.log(n`    {gray #${t}} ${i.name} {gray size ${s(i.size)}}`)}for(let o=0;o<Math.ceil(e.length/5);++o)0==o?console.log(n`    {gray +} ${e.length} {gray external modules} ${e.filter(((e,o)=>0==Math.floor(o/5))).join(", ")}`):console.log(n`                        + ${e.filter(((e,n)=>Math.floor(n/5)==o)).join(", ")}`)}}else{const i=t.filter((e=>!o.some((o=>o.name===e.name)))),r=o.filter((e=>!t.some((o=>o.name===e.name))));for(let o=0;o<e.assets.length;++o){const t=e.assets[o];console.log(n`  {gray asset#}${o} {yellow ${t.name}}`+n` {gray size} {yellow ${s(t.size)}} {gray chunks} [${t.chunks.join(", ")}]`+(o==e.assets.length-1&&0==i.length&&0==r.length?n`{gray [no module list change]}`:""))}for(const e of i)console.log(n`  + ${e.name} {gray size ${s(e.size)}}`);for(const e of r)console.log(n`  - {gray removed ${e.name}}`)}return t}e.run=async function(e,o,n){console.log(`[wpb] bundling ${e.entry}`);const s=!("printStat"in e)||e.printStat;delete e.printStat,t(e).run(((e,t)=>{if(e)return console.log("[wpb] critical error: "+e.message),void o(null);const r=t?.toJson();s?i(r,null):console.log("[wpb] bundled completed successfully"),n(r)}))},e.watch=async function(e,o){console.log(`[wpb] bundling watching ${e.entry}`);let n=null,s=null;t({...e,watch:!0},((e,t)=>{if(e)return void console.log("[wpb] critical error: "+e.message);const r=t?.toJson();if(r.hash==n)return n=r.hash,void console.log("[wpb] rebundle no change");n=r.hash,s=i(r,s),o(r)}))}},"run-sourcemap":(e,o)=>{const n=require("fs"),s=require("path"),t=require("source-map"),i=o("common");e.merge=async function(e,o){const r=new t.SourceMapGenerator({file:"server.js",sourceRoot:""}),c={},l=JSON.parse(n.readFileSync(e,"utf-8")),a=await new t.SourceMapConsumer(l);for(const e of a.sources){if(!e.startsWith("webpack://fps/build/"))continue;const o=e.slice(14),l=s.join(i.projectDirectory,o+".map");if(!n.existsSync(l))continue;l in c||(c[l]=await new t.SourceMapConsumer(JSON.parse(n.readFileSync(l,"utf-8"))));c[l].eachMapping((({originalLine:n,originalColumn:s,generatedLine:t,generatedColumn:i})=>{const c=a.generatedPositionFor({line:t,column:i,source:e});null!=c.line&&null!=c.column&&r.addMapping({source:"src"+o.slice(5,-3)+".ts",original:{line:n,column:s},generated:{line:c.line,column:c.column}})}))}n.writeFileSync(e,r.toString()),o||console.log("[smm] source map merged")}},"build-server-core":(e,o)=>{const n=require("child_process"),s=require("path"),t=o("common"),i=o("admin-base"),r=o("run-typescript"),c=o("run-webpack"),l=o("run-sourcemap"),a="src/server-core/index.ts",d={sourceMap:!0,outDir:"build"},u={mode:"development",entry:s.join(t.projectDirectory,"build/server-core/index.js"),output:{filename:"server.js",path:s.join(t.projectDirectory,"dist/home")},target:"node",externals:Object.keys(t.nodePackage.dependencies).concat(["dayjs/plugin/utc"]).reduce(((e,o)=>({...e,[o]:`commonjs ${o}`})),{}),devtool:"hidden-nosources-source-map"},m="dist/home/server.js.map";let p=null;function g(){console.log("[bud] building watching server-core"),process.on("exit",(()=>p.kill())),r.watch(a,d),c.watch(u,(()=>{l.merge(m,!0).then((()=>{!function(){function e(){console.log("[mds] starting server process"),p=n.spawn("node",["dist/home/server.js"]),p.stdout.pipe(process.stdout),p.stderr.pipe(process.stderr),p.on("error",(e=>console.log(`[mds] server process error ${e.message}`))),p.on("exit",(e=>{console.log(`[mds] server process exited with code ${e}`),p=null}))}null!=p?(console.log(`[mds] shutdown previous server process ${p.pid}`),p.once("exit",e),i.send({type:"shutdown"})):e()}()}))}))}e.build=async function(e){e?g():(console.log("[bud] building server-core"),r.compile(a,d)?c.run(u,(()=>{console.log("[bud] build server-core failed at bundling")}),(()=>{l.merge(m,!1).then((()=>{console.log("[bud] build server-core completed successfully")}))})):console.log("[bud] build server-core failed at transpiling"))}},"build-home-page":(e,o)=>{const n=require("fs"),s=o("run-typescript"),t=require("node-sass"),i=o("admin-base"),r="src/home-page/index.ts",c={types:["node"],outDir:"build/home-page",lib:["lib.dom.d.ts"],writeFileHook:(e,o,n,s,t,i)=>{if("build/home-page/index.js"!=e)return i(e,o,n,s,t);a(o)},watchWriteFileHook:(e,o,n,s)=>{if("build/home-page/index.js"!=e)return s(e,o,n);a(o),console.log("[bud] reload index.js"),i.send({type:"content-update",parameter:{app:"www",name:"index.js"}}).catch((()=>{}))}},l={file:"src/home-page/index.sass",outputStyle:"compressed"};function a(e){const o=e.indexOf("\n"),s=e.indexOf("\n",o+1);n.writeFileSync("dist/home/client.js",e.slice(s+1))}async function d(){return console.log(`[css] transpiling ${l.file}`),new Promise(((e,o)=>{t.render(l,((s,t)=>{if(s)return console.log(`[css] error at ${l.file}:${s.line}:${s.column}: ${s.message}`),void o();n.writeFileSync("dist/home/index.css",t.css),console.log(`[css] transpiled completed successfully in ${t.stats.duration}ms`),e()}))}))}e.build=async function(e){e?function(){console.log("[bud] building watching home-page"),s.watch(r,c);let e=0;n.watchFile("src/home-page/index.html",{persistent:!1},((o,s)=>{o.mtime!=s.mtime&&(e+=1,console.log(`[cpy] copy and reload index.html #${e}`),n.copyFileSync("src/home-page/index.html","dist/home/index.html"),i.send({type:"content-update",parameter:{app:"www",name:"index.html"}}).catch((()=>{})))})),console.log("[bud] index.html fs watcher setup");let o=0;n.watchFile("src/home-page/index.sass",{persistent:!1},((e,n)=>{e.mtime!=n.mtime&&d().then((()=>{o+=1,console.log(`[bud] reload index.css #${o}`),i.send({type:"content-update",parameter:{app:"www",name:"index.css"}}).catch((()=>{}))})).catch((()=>{}))})),console.log("[bud] index.sass fs watcher setup"),process.on("SIGINT",(()=>{n.unwatchFile("build/home-page/index.js"),n.unwatchFile("src/home-page/index.html"),n.unwatchFile("src/home-page/index.sass"),process.exit(0)}))}():async function(){if(console.log("[bud] building home-page"),s.compile(r,c)){await i.send({type:"content-update",parameter:{app:"www",name:"index.js"}});try{await d(),await i.send({type:"content-update",parameter:{app:"www",name:"index.css"}})}catch{return void console.log("[bud] build home-page failed at transpiling stylesheet")}console.log("[cpy] copy index.html"),n.copyFileSync("src/home-page/index.html","dist/home/index.html"),await i.send({type:"content-update",parameter:{app:"www",name:"index.html"}}),console.log("[bud] build home-page completed succesfully")}else console.log("[bud] build home-page failed at transpiling script")}()}},index:(e,o)=>{const n=o("admin-base"),s=o("build-self"),t=o("build-server-core"),i=o("build-home-page");function r(e){if(["ak","collect","cost"].includes(e))return e;console.log("unknown app name"),process.exit(1)}const c=process.argv.slice(2);"self"==c[0]?s.build():"server-core"==c[0]?t.build(!1):"watch"==c[0]&&"server-core"==c[1]?t.build(!0):"home-page"==c[0]?i.build(!1):"watch"==c[0]&&"home-page"==c[1]?i.build(!0):c[0].endsWith("-client")||c[0].endsWith("-server")?r(c[0].slice(0,-7)):"watch"==c[0]&&c[1].endsWith("-client")||"watch"==c[0]&&c[1].endsWith("-server")?r(c[1].slice(0,-7)):"watch"==c[0]&&c[1]?(r(c[1]),r(c[1])):"update-content"==c[0]&&3==c.length?n.send({type:"content-update",parameter:{app:c[1],name:c[2]}}).then((()=>process.exit(1))):"expire-device"==c[0]&&2==c.length||("shutdown"==c[0]?n.send({type:"shutdown"}).then((()=>process.exit(1))):(console.log("unknown command"),process.exit(1)))}});