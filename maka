#!/usr/bin/env node
(e=>{const t={};!function s(o){return o in t||(t[o]={},e[o](t[o],s)),t[o]}(".")})({common:(e,t)=>{const s=require("fs"),o=require("chalk"),n=require("dayjs");e.compileTimeConfig=JSON.parse(s.readFileSync("maka.config","utf-8")),e.logInfo=function(e,t){console.log(o`[{blueBright ${n().format("HH:mm:ss.SSS")}} ${e}] ${t}`)},e.logError=function(e,t){console.log(o`[{blueBright ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`)},e.logCritical=function(e,t){return console.log(o`[{blueBright ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`),process.exit(1)},process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},"tools/admin":(e,t)=>{const s=require("net"),o=require("async-mutex"),n=require("chalk"),r=t("common");const i=new o.Mutex;e.admin=async function(e){await i.runExclusive((async()=>await async function(e){const t=s.createConnection("/tmp/fps.socket").ref();return new Promise(((s,o)=>{const i=JSON.stringify(e);t.on("error",(e=>{"code"in e&&"ENOENT"==e.code?(r.logError("adm",`admin socket not open, command ${i} discarded`),s()):(r.logError("adm",`socket error: ${e.message}`),o())})),t.on("timeout",(()=>{r.logError("adm","socket timeout"),t.destroy(),o()})),t.once("data",(o=>{"ACK"==o.toString("utf-8")&&(r.logInfo("adm",n`ACK {blue ${function(e){switch(e.type){case"shutdown":return"shutdown";case"reload-static":return`reload-static ${e.key}`;case"reload-server":return`reload-server ${e.app}`;case"expire-device":return`expire-device ${e.deviceId}`;case"config-devmod":return`config-devmod ${e.sourceMap} ${e.websocketPort}`}}(e)}}`),setImmediate((()=>{t.destroy(),s()})))})),t.write(i)}))}(e)))}},"tools/typescript":(e,t)=>{const s=require("path"),o=require("typescript"),n=require("chalk"),r=t("common"),i={lib:["lib.esnext.d.ts"],target:o.ScriptTarget.ESNext,module:o.ModuleKind.CommonJS,moduleResolution:o.ModuleResolutionKind.NodeJs,skipLibCheck:!0,noEmitOnError:!0,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function a({category:e,code:t,messageText:s,file:i,start:a}){if(6031!=t)if(6032==t)r.logInfo("tsc","recheck");else{if(6194==t)return;{const r=(0,{[o.DiagnosticCategory.Warning]:n.red,[o.DiagnosticCategory.Error]:n.red,[o.DiagnosticCategory.Suggestion]:n.green,[o.DiagnosticCategory.Message]:n.cyan}[e])(`  TS${t} `);let c="";if(i){const{line:e,character:t}=o.getLineAndCharacterOfPosition(i,a);c=n`{yellow ${i.fileName}:${e+1}:${t+1}} `}let l=o.flattenDiagnosticMessageText(s,"\n");l.includes("\n")&&(l="\n"+l),console.log(r+c+l)}}}function c(){const e=o.sys.readFile;o.sys.readFile=(t,s)=>{let o=e(t,s);if(!t.endsWith(".d.ts"))for(const e in r.compileTimeConfig)o=o.replaceAll(e,r.compileTimeConfig[e]);return o}}function l(e,t){return(s,o)=>{if(s.endsWith(".js")){o.startsWith('"use strict"')&&(o=o.slice(o.indexOf("\n")+1)),o.startsWith("Object.defineProperty")&&(o=o.slice(o.indexOf("\n")+1)),o.startsWith("exports.")&&(o=o.slice(o.indexOf("\n")+1));const t=/\/\/#\s*sourceMappingURL/.exec(o);t&&"hide"==e.sourceMap?o=o.slice(0,t.index):o.endsWith("\n")||(o+="\n")}const n=t.findIndex((e=>e.name==s));n>=0?t.splice(n,1,{name:s,content:o}):t.push({name:s,content:o})}}class m{constructor(e){this.options=e,this.compilerOptions=function(e){return"normal"==e.base?{...i,outDir:"/vbuild",sourceMap:"no"!=e.sourceMap,lib:"additionalLib"in e?[...i.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:i.lib}:{...i,outDir:s.resolve("src"),target:o.ScriptTarget.ES2018,sourceMap:!0,esModuleInterop:!0,module:o.ModuleKind.ESNext,jsx:o.JsxEmit.ReactJSX,lib:[...i.lib,"lib.dom.d.ts"]}}(e)}check(){r.logInfo("tsc",n`once {yellow ${this.options.entry}}`),c();const e=[];return{success:function(e){const t=e.diagnostics.filter((e=>e.category==o.DiagnosticCategory.Error||o.DiagnosticCategory.Warning)).length,s=e.diagnostics.length-t;let i;i=0==s&&0==t?"no diagnostic":0!=s&&0==t?n`{yellow ${s}} infos`:0==s?n`{yellow ${t}} errors`:n`{yellow ${t}} errors and {yellow ${s}} infos`,(e.emitSkipped?r.logError:r.logInfo)("tsc",`completed with ${i}`);for(const t of e.diagnostics)a(t);return!e.emitSkipped}(o.createProgram([this.options.entry],this.compilerOptions,o.createCompilerHost(this.compilerOptions)).emit(void 0,l(this.options,e))),files:e}}watch(e){r.logInfo("tsc",n`watch {yellow ${this.options.entry}}`),c();const t=[];setImmediate((()=>{o.createWatchProgram(o.createWatchCompilerHost([this.options.entry],this.compilerOptions,o.sys,((...s)=>{const n=o.createEmitAndSemanticDiagnosticsBuilderProgram(...s),r=n.emit;return n.emit=(s,o,...n)=>{const i=r(s,l(this.options,t),...n);return i.emitSkipped||e({files:t}),i},n}),a,a))}))}}e.typescript=function(e){return new m(e)}},"tools/mypack":(e,t)=>{const s=require("fs"),o=require("path"),n=require("chalk"),r=require("crypto-js"),i=require("filesize"),a=require("source-map"),c=require("terser"),l=t("common");e.mypack=async function(e){if(e.lastResult?l.logInfo("mpk","repack"):l.logInfo("mpk",n`pack {yellow ${e.entry}}`),!e.files.some((t=>t.name==e.entry)))return l.logError("mpk","invalid entry"),{success:!1};const t=o.dirname(e.entry),m=e.sourceMap?e.files.filter((e=>e.name.endsWith(".js"))).map((({name:t,content:s})=>({name:t,jsContent:s,mapContent:e.files.find((e=>e.name==t+".map")).content}))):e.files.map((({name:e,content:t})=>({name:e,jsContent:t,mapContent:null})));let p=null;e.sourceMap&&(p=new a.SourceMapGenerator({file:e.output}));const d=[];let u="",f=3;e.shebang&&(u+="#!/usr/bin/env node\n",f+=1),u+="app"==e.type?"((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n":"module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n";for(let{name:s,jsContent:n,mapContent:i}of m){let c=o.relative(t,s);c.endsWith(".js")&&(c=c.slice(0,-3)),c.endsWith("index")&&(c=c.slice(0,-5)),0==c.length&&(c=".");let y=n;for(;;){const e=/require\("(?<moduleName>\.[\.\w\-\/]*)"\);/,n=e.exec(y);if(!n)break;const r=o.join(o.dirname(s),n.groups.moduleName);let i=m.some((e=>e.name==r))?r:m.some((e=>e.name==r+".js"))?r+".js":m.some((e=>e.name==r+"/index.js"))?r+"/index.js":null;if(null===i)return l.logError("mpk",`${s}: invalid module name ${n.groups.moduleName} at ${n.index}`),{success:!1};i=o.relative(t,i),i=i.slice(0,-3),i.endsWith("index")&&(i=i.slice(0,-5)),0==i.length&&(i="."),y=y.replace(e,`__myrequire__("${i}");`)}if(u+=`'${c}': (exports, __myrequire__) => {\n${y}}, `,d.push({fileName:s,moduleName:c,contentLength:y.length,hash:r.SHA256(y).toString()}),e.sourceMap){let e=null;(await new a.SourceMapConsumer(JSON.parse(i))).eachMapping((t=>{null===e&&(e=t.generatedLine),p.addMapping({source:o.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-e+f+1,column:t.generatedColumn}})}))}f+=y.split("\n").length}u+="})\n";let y=p?.toString();if(e.minify){const t=await c.minify(u,{sourceMap:!!e.sourceMap&&{content:y,filename:e.output,url:e.output+".map"},format:{max_line_len:"MAKA_SELF_MULTILINE"in process.env?120:void 0}});u=t.code,y="object"==typeof t.map?JSON.stringify(t.map):t.map}const h=r.SHA256(u).toString();if(h===e.lastResult?.hash)l.logInfo("mpk",n`completed with {blue no change}`);else if(e.lastResult||e.output&&l.logInfo("mpk",n`asset {yellow ${e.output}}`),l.logInfo("mpk",n`asset size {gray ${i(u.length)}} compression rate {gray ${(u.length/m.reduce(((e,t)=>e+t.jsContent.length),0)*100).toFixed(2)}%}`),e.printModules)if(e.lastResult){for(const t of d.filter((t=>!e.lastResult.modules.some((e=>e.fileName==t.fileName)))))console.log(n`  {gray +} ${t.fileName} {cyan ${t.moduleName}} {gray size ${i(t.contentLength)}}`);for(const[t]of d.map((t=>[t,e.lastResult.modules.find((e=>e.fileName==t.fileName))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(n`  {gray *} ${t.fileName} {cyan ${t.moduleName}} {gray size ${i(t.contentLength)}}`);for(const t of e.lastResult.modules.filter((e=>!d.some((t=>t.fileName==e.fileName)))))console.log(n`  {gray - removed ${t.fileName}} {cyan ${t.moduleName}}`)}else for(const{fileName:e,moduleName:t,contentLength:s}of d)console.log(n`   {gray +} ${e} {cyan ${t}} {gray size ${i(s)}}`);return await s.promises.writeFile(e.output,u),e.sourceMap&&await s.promises.writeFile(e.output+".map",y),{success:!0,hash:h,modules:d}}},"targets/self":(e,t)=>{const s=require("chalk"),o=t("common"),n=t("tools/typescript"),r=t("tools/mypack"),i={base:"normal",entry:"script/index.ts",sourceMap:"no",watch:!1};e.build=async function(){o.logInfo("mka",s`{cyan self}`);const e=n.typescript(i).check();if(!e.success)return o.logCritical("mka",s`{cyan self} failed at transpile`);var t;if(!(await r.mypack((t=e.files,{type:"app",entry:"/vbuild/index.js",files:t,output:"maka",minify:!0,shebang:!0}))).success)return o.logCritical("mka",s`{cyan self} failed at pack`);o.logInfo("mka",s`{cyan self} completed successfully`)}},"targets/public":(e,t)=>{const s=require("fs-extra"),o=require("rimraf"),n=t("common");e.build=function(){n.logInfo("mka","copy public"),s.copySync("src/public","dist/public",{overwrite:!0}),n.logInfo("mka","copy public completed")},e.cleanAll=function(){n.logInfo("mka","clean all"),o("dist",(e=>{e?n.logError("mka","clean failed: "+e.message):n.logInfo("mka","clean all completed")}))}},"targets/server-core":(e,t)=>{const s=require("child_process"),o=require("fs"),n=require("chalk"),r=t("common"),i=t("tools/admin"),a=t("tools/typescript"),c=t("tools/mypack"),l=e=>({base:"normal",entry:"src/server-core/index.ts",sourceMap:"hide",watch:e}),m=(e,t)=>({type:"app",files:e,entry:"/vbuild/server-core/index.js",sourceMap:!0,output:"dist/main/server.js",printModules:!0,minify:!0,lastResult:t});async function p(){r.logInfo("mka",n`{cyan server-core}`),await o.promises.mkdir("dist/main",{recursive:!0});const e=a.typescript(l(!1)).check();if(!e.success)return r.logCritical("mka",n`{cyan server-core} failed at check`);if(!(await c.mypack(m(e.files))).success)return r.logCritical("mka",n`{cyan server-core} failed at pack`);r.logInfo("mka",n`{cyan server-core} completed successfully`)}let d=null;function u(){r.logInfo("mka",n`watch {cyan server-core}`),process.on("exit",(()=>d?.kill())),o.mkdirSync("dist/main",{recursive:!0});let e=null;a.typescript(l(!0)).watch((async({files:t})=>{const o=await c.mypack(m(t,e));o.success&&(o.hash!=e?.hash&&function(){function e(){r.logInfo("mds","start server"),d=s.spawn("node",["dist/main/server.js"]),d.stdout.pipe(process.stdout),d.stderr.pipe(process.stderr),d.on("error",(e=>{r.logError("mds",`server process error ${e.message}`)})),d.on("exit",(e=>{(0==e?r.logInfo:r.logError)("mds",`server process exited with code ${e}`),d=null}))}null!=d?(d.once("exit",e),i.admin({type:"shutdown"})):e()}(),e=o)}))}e.build=function(e){(e?u:p)()}},"tools/sass":(e,t)=>{const s=require("fs"),o=require("chalk"),n=require("sass"),r=t("common");class i{constructor(e){this.options=e,this.transpile=()=>new Promise((e=>{r.logInfo("css",o`once {yellow ${this.options.entry}}`),n.render({file:this.options.entry,outputStyle:"compressed"},((t,o)=>{t?(r.logError("css",`error at ${t.file}:${t.line}:${t.column}: ${t.message}`),e({success:!1})):(s.writeFileSync(this.options.output,o.css),r.logInfo("css",`completed in ${o.stats.duration}ms`),e({success:!0}))}))}))}watch(e){const t=this;r.logInfo("css",o`watch {yellow ${this.options.entry}}`);const i=[],a={file:this.options.entry,outputStyle:"compressed"};let c="none",l=[this.options.entry];!function o(){c="running";for(const e of i)e.close();i.splice(0,i.length),n.render(a,((n,a)=>{n?r.logError("css",`error at ${n.file}:${n.line}:${n.column}: ${n.message}`):(s.writeFileSync(t.options.output,a.css),r.logInfo("css",`completed in ${a.stats.duration}ms`),e(),l=a.stats.includedFiles);for(const e of l)i.push(s.watch(e,{persistent:!1},(()=>{"running"==c?(r.logInfo("css","retranspile waiting"),c="pending"):"none"==c&&(r.logInfo("css","retranspile (1)"),o())})));"pending"==c?(r.logInfo("css","retranspile (2)"),o()):"running"==c&&(c="none")}))}()}}e.sass=function(e){return new i(e)}},"targets/web-page":(e,t)=>{const s=require("fs"),o=require("chalk"),n=t("common"),r=t("tools/admin"),i=t("tools/typescript"),a=t("tools/sass"),c=(e,t)=>({base:"normal",entry:`src/pages/${e}.ts`,additionalLib:["dom"],sourceMap:"no",watch:t}),l=e=>({entry:`src/pages/${e}.sass`,output:`dist/main/${e}.css`});async function m(e){n.logInfo("mka",o`{cyan ${e}-page}`),await s.promises.mkdir("dist/main",{recursive:!0});const t=i.typescript(c(e,!1));if(s.existsSync(t.options.entry)){const r=t.check();if(!r.success)return n.logCritical("mka",o`{yellow ${e}-page} failed at check`);await s.promises.writeFile(`dist/main/${e}.js`,r.files[0].content)}const m=a.sass(l(e));if(s.existsSync(m.options.entry)){if(!(await m.transpile()).success)return n.logCritical("mka",o`{yellow ${e}-page} failed at transpile`)}n.logInfo("htm",o`copy {yellow ${e}.html}`),await s.promises.copyFile(`src/pages/${e}.html`,`dist/main/${e}.html`),n.logInfo("htm","copy completed"),await r.admin({type:"reload-static",key:e}),n.logInfo("mka",o`{cyan ${e}-page} completed succesfully`)}async function p(e){n.logInfo("mka",o`watch {cyan ${e}-page}`),await s.promises.mkdir("dist/main",{recursive:!0});let t=!1;const m=i.typescript(c(e,!0));s.existsSync(m.options.entry)&&m.watch((o=>{n.logInfo("tsc","completed with no diagnostics"),s.writeFileSync(`dist/main/${e}.js`,o.files[0].content),t=!0}));const p=a.sass(l(e));s.existsSync(p.options.entry)&&p.watch((()=>{t=!0})),function(e,t){const r=`src/pages/${e}.html`;n.logInfo("htm",o`watch {yellow ${r}}`);let i=!1;s.watch(r,{persistent:!1},(()=>{i=!0}));const a=()=>{s.copyFileSync(`src/pages/${e}.html`,`dist/main/${e}.html`),n.logInfo("htm","copy completed"),t()};setInterval((()=>{i&&(i=!1,n.logInfo("htm","recopy"),a())}),3001),a()}(e,(()=>t=!0)),setInterval((()=>{t&&(t=!1,r.admin({type:"reload-static",key:e}).catch((()=>{})))}),3002).unref()}e.build=function(e,t){return(t?p:m)(e)}},"tools/codegen":(e,t)=>{const s=require("fs"),o=require("chalk"),n=require("xml2json"),r=t("common"),i=["GET","POST","PUT","PATCH","DELETE"],a={GET:"get",POST:"post",PUT:"put",PATCH:"patch",DELETE:"del"},c=["id","number","string","boolean","date","time"],l={id:{pattern:"\\d+",validator:"validateId",tsType:"number"},number:{pattern:"\\d+",validator:"validateNumber",tsType:"number"},string:{pattern:".+",validator:"validateString",tsType:"string"},boolean:{pattern:"(true|false)",validator:"validateBoolean",tsType:"boolean"},date:{pattern:"\\d{6}",validator:"validateDate",tsType:"Dayjs"},time:{pattern:"\\d{12}",validator:"validateTime",tsType:"Dayjs"}};const m=e=>`src/${e}/api.xml`;async function p(e){const t=await s.promises.readFile(m(e),"utf-8"),{version:o,api:r}=n.toJson(t,{object:!0})[`${e}-api`];return{version:o,definitions:r.map(((e,t)=>{const s=e.name;if(!s)throw new Error(`index ${t} api name is required`);const o=e.method;if(!i.includes(o))throw new Error(`api ${s} invalid method`);const n=e.path;if(!n)throw new Error(`api ${s} path is required`);if(!n.startsWith("/"))throw new Error(`api ${s} path should be absolute`);const r=function(e,t){const s=[];for(;;){const o=/\{(?<parameterName>[\w\_]+):(?<parameterType>\w+)\}/.exec(t);if(!o)break;if(10==s.filter((e=>"parameter"==e.type)).length)throw new Error(`api ${e} too many parameters`);const[n,r]=[o.groups.parameterName,o.groups.parameterType];if(!c.includes(r))throw new Error(`api ${e} parameter ${n} invalid type ${r}`);0!=o.index&&s.push({type:"normal",value:t.slice(0,o.index)}),s.push({type:"parameter",parameterName:n,parameterType:r}),t=t.slice(o.index+n.length+r.length+3)}return t.length&&s.push({type:"normal",value:t}),s}(s,n),[a,l]=[e["body-type"],e["body-name"]];if(["POST","PUT","PATCH"].includes(o)&&(!a||!l))throw new Error(`api ${s} body is required for ${o}`);return{namespace:e.namespace||"default",apiName:s,method:o,apiPath:r,bodyType:a,bodyName:l,returnType:e["return-type"]||"void"}}))}}class d{constructor(e,t){this.app=e,this.target=t,this.definitionFile=m(this.app)}generate(){return"server"==this.target?async function(e){const t=`src/${e}/server/index.ts`;let n;r.logInfo("fcg",o`generate {yellow ${t}}`);try{n=await p(e)}catch(e){return r.logError("fcg",e.message),{success:!1}}const{version:i,definitions:a}=n;let m="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==a.length)return m+="// empty\n",await s.promises.writeFile(t,m),r.logInfo("fcg","generate completed with empty"),{success:!0};m+=`import { WebContext, ${c.filter((e=>a.some((t=>t.apiPath.some((t=>"parameter"==t.type&&t.parameterType==e)))))).map((e=>l[e].validator)).concat(a.some((e=>["PUT","POST","PATCH"].includes(e.method)))?["validateBody"]:[]).join(", ")} } from '../../shared/api-server';\n`,m+="import { MyError } from '../../shared/error';\n";for(const e of a.map((e=>e.namespace)).filter(((e,t,s)=>s.indexOf(e)==t)))m+=`import { ${a.filter((t=>t.namespace==e)).map((e=>e.apiName)).join(", ")} } from './${e}';\n`;m+="\n",m+="export async function dispatch(ctx: WebContext) {\n",m+="    let match: RegExpExecArray;\n",m+=`    if (!ctx.path.startsWith('/${e}/v${i}')) { throw new MyError('not-found', 'invalid invocation version'); }\n`,m+=`    const methodPath = \`\${ctx.method} \${ctx.path.slice(${e.length+i.length+3})}\`;\n`,m+="\n";for(const e of a){const{apiName:t,method:s,apiPath:o,bodyType:n,returnType:r}=e;m+=`    match = /^${s} `;for(const e of o)"normal"==e.type?m+=e.value.replaceAll("/","\\/"):m+=`(?<${e.parameterName}>${l[e.parameterType].pattern})`;m+="$/.exec(methodPath); if (match) {\n",m+="        ",r&&"void"!=r&&(m+="ctx.body = "),m+=`await ${t}(ctx.state`;for(const{parameterName:e,parameterType:t}of o.filter((e=>"parameter"==e.type)))m+=`, ${l[t].validator}('${e}', match.groups['${e}'])`;n&&(m+=", validateBody(ctx.request.body)"),m+=");\n","POST"==s?m+="        ctx.status = 201;\n":"DELETE"==s&&(m+="        ctx.status = 204;\n"),m+="        return;\n",m+="    }\n"}return m+="\n",m+="    throw new MyError('not-found', 'invalid invocation');\n",m+="}\n",await s.promises.writeFile(t,m),r.logInfo("fcg","generate completed"),{success:!0}}(this.app):async function(e){const t=`src/${e}/client/api.ts`;let n;r.logInfo("fcg",o`generate {yellow ${t}}`);try{n=await p(e)}catch(e){return r.logError("fcg",e.message),{success:!1}}const{version:c,definitions:m}=n;let d="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==m.length)return d+="// empty\n",await s.promises.writeFile(t,d),r.logInfo("fcg","generate completed with empty"),{success:!0};m.some((e=>e.apiPath.some((e=>"parameter"==e.type&&["date","time"].includes(e.parameterType)))))&&(d+="import type { Dayjs } from 'dayjs';\n"),d+=`import { ${i.filter((e=>m.some((t=>t.method==e)))).map((e=>a[e])).join(", ")} } from '../../shared/api-client';\n`;const u=m.filter((e=>!!e.bodyType)).map((e=>e.bodyType)),f=m.filter((e=>"void"!=e.returnType)).map((e=>e.returnType.endsWith("[]")?e.returnType.slice(0,-2):e.returnType));d+=`import type { ${u.concat(f).filter(((e,t,s)=>s.indexOf(e)==t)).join(", ")} } from '../api';\n`,d+="\n";for(const t of m){const{apiName:s,method:o,apiPath:n,bodyType:r,bodyName:i,returnType:m}=t;d+=`export const ${s} = (`;for(const{parameterName:e,parameterType:t}of n.filter((e=>"parameter"==e.type)))d.endsWith("(")||(d+=", "),d+=`${e}: ${l[t].tsType}`;r&&(d.endsWith("(")||(d+=", "),d+=`${i}: ${r}`),d+=`): Promise<${m}> => ${a[o]}(\`/${e}/v${c}`;for(const e of n)"normal"==e.type?d+=e.value:"date"==e.parameterType?d+=`\${${e.parameterName}.format('YYYYMMDD')}`:"time"==e.parameterType?d+=`\${${e.parameterName}.format('YYYYMMDDHHmmdd')}`:d+=`\${${e.parameterName}}`;d+="`",r&&(d+=`, ${i}`),d+=");\n"}return await s.promises.writeFile(t,d),r.logInfo("fcg","generate completed"),{success:!0}}(this.app)}watch(){r.logInfo("fcg",o`watch {yellow ${this.definitionFile}}`);let e=!0;s.watch(this.definitionFile,{persistent:!1},(()=>{e=!0})),setInterval((()=>{e&&(e=!1,this.generate())}),3007)}}e.codegen=function(e,t){return new d(e,t)}},"targets/app-server":(e,t)=>{const s=require("fs"),o=require("chalk"),n=t("common"),r=t("tools/admin"),i=t("tools/codegen"),a=t("tools/typescript"),c=t("tools/mypack"),l=(e,t)=>({base:"normal",entry:`src/${e}/server/index.ts`,sourceMap:"hide",watch:t}),m=(e,t,s)=>({type:"lib",entry:`/vbuild/${e}/server/index.js`,files:t,sourceMap:!0,output:`dist/${e}/server.js`,printModules:!0,minify:!0,lastResult:s});e.build=async function(e,t){t?function(e){n.logInfo("mka",o`watch {cyan ${e}-server}`),s.mkdirSync(`dist/${e}`,{recursive:!0}),i.codegen(e,"server").watch();let t=null;a.typescript(l(e,!0)).watch((async({files:s})=>{const o=await c.mypack(m(e,s,t));o.success&&(o.hash!=t?.hash&&await r.admin({type:"reload-server",app:e}).catch((()=>{})),t=o)}))}(e):await async function(e){if(n.logInfo("mka",o`{cyan ${e}-server}`),await s.promises.mkdir(`dist/${e}`,{recursive:!0}),!(await i.codegen(e,"server").generate()).success)return n.logCritical("mka",o`{cyan ${e}-server} failed at code generation`);const t=a.typescript(l(e,!1)).check();if(!t.success)return n.logCritical("mka",o`{cyan ${e}-server} failed at check`);if(!(await c.mypack(m(e,t.files))).success)return n.logCritical("mka",o`{cyan ${e}-server} failed at pack`);await r.admin({type:"reload-server",app:e}),n.logInfo("mka",o`{cyan ${e}-server} complete successfully`)}(e)}},"tools/wsadmin":(e,t)=>{const s=require("fs"),o=require("https"),n=require("chalk"),r=require("ws"),i=t("common"),a=o.createServer({key:s.readFileSync("/etc/letsencrypt/live/freskyz.com/privkey.pem"),cert:s.readFileSync("/etc/letsencrypt/live/freskyz.com/cert.pem")}),c={};a.on("connection",(e=>{const t=`https:${e.remoteAddress}:${e.remotePort}`;c[t]=e,e.on("close",(()=>delete c[t]))}));const l=new r.Server({server:a});let m=!1,p=!1;l.on("error",(e=>{m=!0,i.logError("wsa",`server error ${e.message}\n${JSON.stringify(e)}`)})),l.on("connection",((e,t)=>{const s=t.socket.remoteAddress;e.on("error",(e=>{i.logError("wsa",`connection from ${s} error ${e.message}\n${JSON.stringify(e)}`)})),e.on("close",(()=>{})),e.on("message",(e=>{e.startsWith("ACK ")?i.logInfo("wsa",n`ACK {blue ${e.slice(4)}}`):i.logInfo("wsa",n`{gray unexpected message ${e}}`)}))})),process.on("exit",(()=>{if(p){for(const e of l.clients)e.close();for(const e in c)c[e].destroy();l.close(),a.close()}})),e.wswatch=function(e){a.listen(e,(()=>{p=!0,i.logInfo("wsa",n`watch {yellow :${e}}`)}))},e.wsadmin=function(e){if(!p||m)return;const t=Array.from(l.clients).filter((e=>e.readyState==r.OPEN));if(0!=t.length)for(const s of t)s.send(e,(e=>{e&&i.logError("wsa",`send error ${e.message}\n${JSON.stringify(e)}`)}));else i.logInfo("wsa",n`{gray no client}`)}},"targets/app-client":(e,t)=>{const s=require("fs"),o=require("path"),n=require("zlib"),r=require("antd-dayjs-webpack-plugin"),i=require("chalk"),a=require("dayjs"),c=require("filesize"),l=require("memfs"),m=require("terser-webpack-plugin"),p=require("unionfs"),d=require("webpack"),u=t("common"),f=t("tools/admin"),y=t("tools/codegen"),h=t("tools/sass"),g=t("tools/typescript"),w=t("tools/wsadmin"),$=(e,t)=>({base:"jsx",entry:`src/${e}/client/index.tsx`,sourceMap:"normal",watch:t}),k=e=>({entry:`src/${e}/client/index.sass`,output:`dist/${e}/index.css`}),v="MAKA_AC_OSIZE"in process.env?"0"===process.env.MAKA_AC_OSIZE?0:parseInt(process.env.MAKA_AC_OSIZE)||2:2;function b(e,t,a){u.logInfo("wpk",i`${a?"watch":"once"} {yellow src/${e}/client/index.js}`);const c=d((e=>({mode:"development",entry:{client:o.resolve("src",e,"client/index.js")},module:{rules:[{test:/\.js$/,exclude:/node_modules/,enforce:"pre",use:["source-map-loader"]}]},output:{filename:"client.js",path:o.resolve(`dist/${e}`),pathinfo:!1},devtool:!1,cache:{type:"filesystem",name:`maka-webpack-${e}`,cacheDirectory:o.resolve(".cache")},performance:{hints:!1},optimization:{moduleIds:"deterministic",chunkIds:"deterministic",mangleExports:"deterministic",nodeEnv:"production",innerGraph:!0,usedExports:!0,emitOnErrors:!1,flagIncludedChunks:!0,concatenateModules:!0,splitChunks:{hidePathInfo:!0,cacheGroups:{1:{test:/node_modules\/react\-dom/,priority:20,chunks:"all",filename:"client-vendor1.js"},2:{test:/node_modules\/(rc|\@ant-design)/,priority:20,chunks:"all",filename:"client-vendor2.js"},3:{test:/node_modules\/(antd|lodash)/,priority:20,chunks:"all",filename:"client-vendor3.js"},4:{test:/node_modules/,priority:10,chunks:"all",filename:"client-vendor4.js"}}},minimize:0!=v,minimizer:[new m({terserOptions:{format:{comments:!1},compress:2==v},extractComments:!1})]},plugins:[new r,new d.SourceMapDevToolPlugin({exclude:/vendor/,filename:"[name].js.map"})]}))(e)),l={compressSizes:{}};return c.inputFileSystem=(new p.Union).use(s).use(t),c.hooks.emit.tap("CompressSizePlugin",(e=>{for(const t of e.getAssets())l.compressSizes[t.name]=n.brotliCompressSync(t.source.buffer()).length})),[c,l]}function x(e,t){const o=`/tmp/maka-stats-${a().format("YYYYMMDD-HHmmss")}.txt`,n=c(e.assets.reduce(((e,t)=>e+t.size),0)),r=c(e.assets.reduce(((e,s)=>e+t.compressSizes[s.name]),0)||0),l=e.assets.filter((e=>e.name.includes("vendor"))).reduce(((e,s)=>Math.max(e,t.compressSizes[s.name])),0);if(0==e.errorsCount){if(u.logInfo("wpk",i`completed with {yellow ${e.assets.length}} assets in ${e.time/1e3}s, `+i`{yellow ${r}} ({${l>3e5?"red":"black"} max ${c(l||0)}})`),e.warningsCount>0){u.logInfo("wpk",i`{yellow ${e.warningsCount}} warnings`);for(const{message:t}of e.warnings)console.log("  "+t)}}else{u.logError("wpk",i`completed with {red ${e.errorsCount}} errors, stat file {yellow ${o}}`);for(const{message:t}of e.errors)u.logError("wpk",t)}let m="";const p=["entry","rendered","initial","recorded"],d=["built","codeGenerated","cached","cacheable","optional","prefetched"];if(m+=`hash ${e.hash} time ${e.time}ms total size ${n} (${r})\n`,e.warningsCount){m+=`${e.warningsCount} warnings:\n`;for(const t of e.warnings)m+=JSON.stringify(t,void 0,1)+"\n"}if(e.errorsCount){m+=`${e.errorsCount} errors:\n`;for(const t of e.errors)m+=JSON.stringify(t,void 0,1)+"\n"}for(const s of e.assets)m+=`asset ${s.name} size ${c(s.size)} compress ${c(t.compressSizes[s.name]??0)} chunks [${s.chunks.join(",")}] chunkNames [${s.chunkNames.join(",")}]\n`;for(const t of e.chunks){m+=`chunk ${t.id} files [${t.files.join(",")}] size ${c(t.size)} flags [${p.filter((e=>t[e])).join(",")}] ${t.modules.length} chunks\n`;for(const e of t.modules)if(m+=`  module ${e.id} size ${c(e.size)} flags [${d.filter((t=>e[t])).join(",")}] name "${e.name}" identifier "${e.identifier}"\n`,/\+ \d+ modules/.test(e.name)&&e.modules)for(const t of e.modules)m+=`    submodule ${t.name} size ${c(t.size)}\n`}s.writeFileSync(o,m)}async function I(e,t,o){const n=`src/${e}/index.html`;o||u.logInfo("htm",i`read {yellow ${n}}`);let r=(await s.promises.readFile(n,"utf-8")).replace("<stylesheet-placeholder />",t[0].map((e=>`<link rel="stylesheet" type="text/css" href="/${e}">`)).join("\n  ")).replace("<script-placeholder />",t[1].map((e=>`<script type="text/javascript" src="/${e}"><\/script>`)).join("\n  "));await s.promises.writeFile(`dist/${e}/index.html`,r),u.logInfo("htm","template rendered")}async function S(e){u.logInfo("mka",i`{cyan ${e}-client}`),s.mkdirSync(`dist/${e}`,{recursive:!0});const t=(async()=>{const t=y.codegen(e,"client");if(s.existsSync(t.definitionFile)){if(!(await t.generate()).success)return u.logCritical("mka",i`{cyan ${e}-client} failed at codegen`)}const o=g.typescript($(e,!1)).check();if(!o.success)return u.logCritical("mka",i`{cyan ${e}-client} failed at check`);const n=l.Volume.fromJSON(o.files.reduce(((e,t)=>(e[t.name]=t.content,e)),{})),[r,a]=b(e,n,!1),c=await new Promise((e=>r.run(((t,s)=>e({error:t,statsObject:s})))));if(c.error)return u.logError("wpk",JSON.stringify(c.error,void 0,1)),u.logCritical("mka",i`{yellow ${e}-client} failed at pack (1)`);const m=c.statsObject.toJson();return x(m,a),m.errorsCount>0?u.logCritical("mka",i`{cyan ${e}-client} failed at pack (2)`):(r.close((e=>{e&&u.logError("wpk",`failed to close compiler: ${JSON.stringify(e)}`)})),m.assets.map((e=>e.name)))})(),o=(async()=>await h.sass(k(e)).transpile()?["index.css"]:u.logCritical("mka",i`{cyan ${e}-client} failed at transpile`))();await I(e,await Promise.all([o,t]),!1),await f.admin({type:"reload-static",key:e}),u.logInfo("mka",i`{cyan ${e}-client} complete successfully`)}function C(e){u.logInfo("mka",i`watch {cyan ${e}-client}`),s.mkdirSync(`dist/${e}`,{recursive:!0});let t=!1;const n=y.codegen(e,"client");s.existsSync(n.definitionFile)&&n.watch();const r=new l.Volume,[a,c]=b(e,r,!0);let m=[],p=[],d=null;g.typescript($(e,!0)).watch((async({files:e})=>{for(const{name:t,content:s}of e)r.existsSync(t)||t.endsWith(".map")||console.log(i`   + ${t}`),await r.promises.mkdir(o.dirname(t),{recursive:!0}),await r.promises.writeFile(t,s);m=e,u.logInfo("wpk","repack"),a.run(((e,s)=>{if(e)return void u.logError("wpk",JSON.stringify(e,void 0,1));const n=s.toJson();x(n,c),function(e,t,s){const n=[],r=o.resolve("src");for(const t of e.modules)if(/\+ \d+ modules/.test(t.name)&&t.modules)for(const e of t.modules){const t=o.resolve(e.name);t.startsWith(r)&&n.push(t)}else{const e=o.resolve(t.name);e.startsWith(r)&&n.push(e)}const a=t.filter((e=>!n.includes(e.name)&&!n.some((t=>t+".map"==e.name))));for(const e of a)t.splice(t.indexOf(e),1),s.unlinkSync(e.name),e.name.endsWith(".map")||console.log(i`   {gray - ${e.name}}`)}(n,m,r),0==n.errorsCount&&(n.hash!=d?(p=n.assets.map((e=>e.name)),d=n.hash,t=!0):u.logInfo("wpk",i`completed with {blue no change}`),a.close((e=>{e&&u.logError("wpk",`failed to close compiler: ${JSON.stringify(e)}`)})))}))}));let v=["index.css"];h.sass(k(e)).watch((()=>{t=!0})),setInterval((()=>{t&&(t=!1,I(e,[v,p.concat(["x/x.js"])],!0).then((()=>{f.admin({type:"reload-static",key:e}).catch((()=>{})),f.admin({type:"config-devmod",sourceMap:!0,websocketPort:S}).catch((()=>{})),w.wsadmin("refresh")})))}),3003);const S=Math.floor(98*Math.random()+8001);w.wswatch(S)}e.build=function(e,t){(t?C:S)(e)}},".":(e,t)=>{const s=t("tools/admin"),o=t("targets/self"),n=t("targets/public"),r=t("targets/server-core"),i=t("targets/web-page"),a=t("targets/app-server"),c=t("targets/app-client");function l(e){if(["home","user","404","418"].includes(e))return e;console.log("unknown page name"),process.exit(1)}function m(e){if(["cost","collect","ak"].includes(e))return e;console.log("unknown app name"),process.exit(1)}const[p,d]=[process.argv[2],process.argv[3]];"self"==p?o.build():"clean"==p?n.cleanAll():"public"==p?n.build():"server-core"==p?r.build(!1):"watch"==p&&"server-core"==d?r.build(!0):p.endsWith("-page")?i.build(l(p.slice(0,-5)),!1):"watch"==p&&d.endsWith("-page")?i.build(l(d.slice(0,-5)),!0):p.endsWith("-client")?c.build(m(p.slice(0,-7)),!1):"watch"==p&&d.endsWith("-client")?c.build(m(d.slice(0,-7)),!0):p.endsWith("-server")?a.build(m(p.slice(0,-7)),!1):"watch"==p&&d.endsWith("-server")?a.build(m(d.slice(0,-7)),!0):"watch"==p&&d.endsWith("-both")?(c.build(m(d.slice(0,-5)),!0),a.build(m(d.slice(0,-5)),!0)):"all"==p?(n.build(),r.build(!1),i.build("www",!1),i.build("user",!1),i.build("404",!1),i.build("418",!1),a.build("cost",!1),c.build("ak",!1)):"shutdown"==p?s.admin({type:"shutdown"}).then((()=>process.exit(1))):"reload-static"==p?s.admin({type:"reload-static",key:"home"==d||"user"==d?d:m(d)}).then((()=>process.exit(1))):"source-map"==p?s.admin({type:"config-devmod",sourceMap:"enable"==d}).then((()=>process.exit(1))):"reload-server"==p?s.admin({type:"reload-server",app:m(d)}).then((()=>process.exit(1))):"expire-device"==p?s.admin({type:"expire-device",deviceId:parseInt(d)}).then((()=>process.exit(1))):(console.log("unknown command"),process.exit(1))}});