#!/usr/bin/env node
(e=>{const n={};!function o(t){return t in n||(n[t]={},e[t](n[t],o)),n[t]}(".")})({common:(e,n)=>{const o=require("fs"),t=require("chalk"),i=require("dayjs");e.projectDirectory="<PROJECTDIR>",e.nodePackage=JSON.parse(o.readFileSync("package.json","utf-8")),e.compileTimeConfig=JSON.parse(o.readFileSync("maka.config","utf-8")),e.logInfo=function(e,n){console.log(t`[${i().format("HH:mm:ss")}][{cyan ${e}}] ${n}`)},e.logError=function(e,n){console.log(t`[${i().format("HH:mm:ss")}][{red ${e}}] ${n}`)},process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},admin:(e,n)=>{const o=require("net"),t=require("async-mutex"),i=n("common");const s=new t.Mutex;e.admin=async function(e){await s.runExclusive((async()=>await async function(e){const n=o.createConnection("/tmp/fps.socket").ref();return new Promise(((o,t)=>{const s=JSON.stringify(e);n.on("error",(e=>{"code"in e&&"ENOENT"==e.code?(i.logError("adm",`admin socket not open, command ${s} discarded`),o()):(i.logError("adm",`socket error: ${e.message}`),t())})),n.on("timeout",(()=>{i.logError("adm","socket timeout"),n.destroy(),t()})),n.once("data",(e=>{"ACK"==e.toString("utf-8")&&(i.logInfo("adm",`command ${s} acknowledged`),setTimeout((()=>{n.destroy(),o()}),0))})),n.write(s)}))}(e)))}},"run-typescript":(e,n)=>{const o=require("typescript"),t=require("chalk"),i=n("common");e.ModuleKind=o.ModuleKind,e.ModuleResolutionKind=o.ModuleResolutionKind;const s={lib:["lib.es2020.d.ts"],target:o.ScriptTarget.ES2020,module:o.ModuleKind.CommonJS,moduleResolution:o.ModuleResolutionKind.NodeJs,noEmitOnError:!0,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0},r={[o.DiagnosticCategory.Warning]:t.red,[o.DiagnosticCategory.Error]:t.red,[o.DiagnosticCategory.Suggestion]:t.green,[o.DiagnosticCategory.Message]:t.cyan};function a({category:e,code:n,messageText:s,file:a,start:l}){if(6031!=n)if(6032==n)i.logInfo("tsc","retranspile");else{if(6194==n)return;{const i=r[e](`  TS${n} `);let c="";if(a){const{line:e,character:n}=o.getLineAndCharacterOfPosition(a,l);c=t`{yellow ${a.fileName}:${e+1}:${n+1}} `}let m=o.flattenDiagnosticMessageText(s,"\n");m.includes("\n")&&(m="\n"+m),console.log(i+c+m)}}}e.transpileOnce=function(e,n){i.logInfo("tsc",t`once {yellow ${e}}`);const r={...s,...n,lib:"lib"in n?[...s.lib,...n.lib]:s.lib},l=function(e){const n=o.createCompilerHost(e);if(e.readFileHook){const o=n.readFile;n.readFile=n=>e.readFileHook(n,o)}const t=n.writeFile;return n.writeFile=(n,o,i,s,r)=>{n.endsWith(".js")&&((o=o.slice(o.indexOf("\n",o.indexOf("\n")+1)+1)).startsWith("exports.")&&(o=o.slice(o.indexOf("\n")+1)),e.sourceMap?o=o.slice(0,o.lastIndexOf("\n")+1):o.endsWith("\n")||(o+="\n")),e.writeFileHook?e.writeFileHook(n,o,i,s,r,t):t(n,o,i,s,r)},n}(r),c=o.createProgram(Array.isArray(e)?e:[e],r,l),{diagnostics:m}=c.emit(),{success:u,message:d}=function(e){const n=e.filter((e=>e.category==o.DiagnosticCategory.Error||o.DiagnosticCategory.Warning)).length,i=e.length-n;let s;return s=0==i&&0==n?"no diagnostic":0!=i&&0==n?t`{yellow ${i}} infos`:0==i?t`{yellow ${n}} errors`:t`{yellow ${n}} errors and {yellow ${i}} infos`,{success:0==n,message:s}}(m);return u?i.logInfo("tsc",`completed with ${d}`):i.logError("tsc",`completed with ${d}`),m.map(a),m.length>0&&i.logError("tsc","end of transpile diagnostics"),u},e.transpileWatch=function(e,n){if(i.logInfo("tsc",t`watch {yellow ${e}}`),n.watchReadFileHook){const e=o.sys.readFile;o.sys.readFile=(o,t)=>n.watchReadFileHook(o,t,e)}const r=o.sys.writeFile;o.sys.writeFile=(e,o,t)=>{e.endsWith(".js")&&((o=o.slice(o.indexOf("\n",o.indexOf("\n")+1)+1)).startsWith("exports.")&&(o=o.slice(o.indexOf("\n")+1)),n.sourceMap?o=o.slice(0,o.lastIndexOf("\n")+1):o.endsWith("\n")||(o+="\n")),n.watchWriteFileHook?n.watchWriteFileHook(e,o,t,r):r(e,o,t)},o.createWatchProgram(o.createWatchCompilerHost([e],{...s,...n},o.sys,((...e)=>{const t=o.createEmitAndSemanticDiagnosticsBuilderProgram(...e);if(n.watchEmit){const e=t.emit;t.emit=(...o)=>{const t=e(...o);return t.emitSkipped||n.watchEmit(),t}}return t}),a,a))}},"run-mypack":(e,n)=>{const o=require("path"),t=require("chalk"),i=require("crypto-js"),s=require("filesize"),r=require("source-map"),a=require("terser"),l=n("common");e.pack=async function(e){if(e.lastResult?l.logInfo("mpk","repack"):l.logInfo("mpk",t`pack {yellow ${e.entry}}`),!e.files.some((n=>n.name==e.entry)))return l.logError("mpk","invalid entry"),{success:!1};const n=o.dirname(e.entry),c=e.sourceMap?e.files.filter((e=>e.name.endsWith(".js"))).map((({name:n,content:o})=>({name:n,jsContent:o,mapContent:e.files.find((e=>e.name==n+".map")).content}))):e.files.map((({name:e,content:n})=>({name:e,jsContent:n,mapContent:null})));let m=null;e.sourceMap&&(m=new r.SourceMapGenerator({file:e.output}));let u=3;const d=[];let p="app"==e.type?"((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n":"module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n";for(let{name:t,jsContent:s,mapContent:a}of c){let f=o.relative(n,t);f.endsWith(".js")&&(f=f.slice(0,-3)),f.endsWith("index")&&(f=f.slice(0,-5)),0==f.length&&(f=".");let g=s;for(;;){const e=/require\("(?<moduleName>\.[\.\w\-\/]*)"\);/,i=e.exec(g);if(!i)break;const s=o.join(o.dirname(t),i.groups.moduleName);let r=c.some((e=>e.name==s))?s:c.some((e=>e.name==s+".js"))?s+".js":c.some((e=>e.name==s+"/index.js"))?s+"/index.js":null;if(null===r)return l.logError("mpk",`${t}: invalid module name ${i.groups.moduleName} at ${i.index}`),{success:!1};r=o.relative(n,r),r=r.slice(0,-3),r.endsWith("index")&&(r=r.slice(0,-5)),0==r.length&&(r="."),g=g.replace(e,`__myrequire__("${r}");`)}if(p+=`'${f}': (exports, __myrequire__) => {\n${g}}, `,d.push({fileName:t,moduleName:f,contentLength:g.length,hash:i.SHA256(g).toString()}),e.sourceMap){let e=null;(await new r.SourceMapConsumer(JSON.parse(a))).eachMapping((n=>{null===e&&(e=n.generatedLine),m.addMapping({source:o.resolve(n.source),original:{line:n.originalLine,column:n.originalColumn},generated:{line:n.generatedLine-e+u+1,column:n.generatedColumn}})}))}u+=g.split("\n").length}if(p+="})\n",e.minify){p=(await a.minify(p)).code}const f=i.SHA256(p).toString();if(f===e.lastResult?.hash)l.logInfo("mpk","completed with no change");else if(e.lastResult||(l.logInfo("mpk","completed with no error"),e.output&&l.logInfo("mpk",t`asset {yellow ${e.output}}`),l.logInfo("mpk",t`asset size {gray ${s(p.length)}} compression rate {gray ${(p.length/c.reduce(((e,n)=>e+n.jsContent.length),0)*100).toFixed(2)}%}`)),e.printModules)if(e.lastResult){for(const n of d.filter((n=>!e.lastResult.modules.some((e=>e.fileName==n.fileName)))))console.log(t`  {gray +} ${n.fileName} {cyan ${n.moduleName}} {gray size ${s(n.contentLength)}}`);for(const[n]of d.map((n=>[n,e.lastResult.modules.find((e=>e.fileName==n.fileName))])).filter((([e,n])=>n&&e.hash!=n.hash)))console.log(t`  {gray *} ${n.fileName} {cyan ${n.moduleName}} {gray size ${s(n.contentLength)}}`);for(const n of e.lastResult.modules.filter((e=>!d.some((n=>n.fileName==e.fileName)))))console.log(t`  {gray - removed ${n.fileName}} {cyan ${n.moduleName}}`)}else for(const{fileName:e,moduleName:n,contentLength:o}of d)console.log(t`   {gray +} ${e} {cyan ${n}} {gray size ${s(o)}}`);return{success:!0,jsContent:p,mapContent:m?.toString(),hash:f,modules:d}}},"build-self":(e,n)=>{const o=require("fs"),t=require("chalk"),i=n("common"),s=n("run-typescript"),r=n("run-mypack"),a=["script/index.ts"],l={types:["node"],outDir:"/vbuild"};function c(e){return(n,o)=>{e.push({name:n,content:o})}}const m={type:"app",entry:"/vbuild/index.js",files:[],output:"maka",minify:!0};e.build=async function(){i.logInfo("mka",t`{yellow self}`);const e=[];s.transpileOnce(a,{...l,writeFileHook:c(e)})||(i.logError("mka","self failed at transpile typescript"),process.exit(1));const n=await r.pack({...m,files:e});n.success||(i.logError("mka","self failed at pack"),process.exit(1)),o.writeFileSync("maka","#!/usr/bin/env node\n"+n.jsContent),i.logInfo("mka","self completed successfully")}},"build-server-core":(e,n)=>{const o=require("child_process"),t=require("fs/promises"),i=require("chalk"),s=n("common"),r=n("admin"),a=n("run-typescript"),l=n("run-mypack"),c="src/server-core/index.ts",m={sourceMap:!0,outDir:"/vbuild",readFileHook:(e,n)=>{let o=n(e);if(!e.endsWith(".d.ts"))for(const e in s.compileTimeConfig)o=o.split(e).join(s.compileTimeConfig[e]);return o}},u={type:"app",entry:"/vbuild/server-core/index.js",files:[],sourceMap:!0,output:"dist/home/server.js",printModules:!0,minify:!1};let d=null;function p(){function e(){s.logInfo("mds","start server"),d=o.spawn("node",["dist/home/server.js"]),d.stdout.pipe(process.stdout),d.stderr.pipe(process.stderr),d.on("error",(e=>{s.logError("mds",`server process error ${e.message}`)})),d.on("exit",(e=>{(0==e?s.logInfo:s.logError)("mds",`server process exited with code ${e}`),d=null}))}null!=d?(d.once("exit",e),r.admin({type:"shutdown"})):e()}e.startOrRestartServer=p,e.build=async function(e){e?function(){s.logInfo("mka",i`watch {yellow server-core}`),process.on("exit",(()=>d?.kill()));const e=[];let n=null;a.transpileWatch(c,{...m,watchWriteFileHook:(n,o)=>{const t=e.findIndex((e=>e.name==n));t>=0?e.splice(t,1,{name:n,content:o}):e.push({name:n,content:o})},watchEmit:async()=>{const o=await l.pack({...u,files:e,lastResult:n});o.success&&(await t.writeFile("dist/home/server.js",o.jsContent),await t.writeFile("dist/home/server.js.map",o.mapContent)),o.hash!=n?.hash&&p(),n=o}})}():await async function(){s.logInfo("mka",i`{yellow server-core}`);const e=[];a.transpileOnce(c,{...m,writeFileHook:(n,o)=>e.push({name:n,content:o})})||(s.logError("mka",i`{yellow server-core} failed at transpile typescript`),process.exit(1));const n=await l.pack({...u,files:e});n.success||(s.logError("mka",i`{yellow server-core} failed at pack`),process.exit(1)),await t.writeFile("dist/home/server.js",n.jsContent),await t.writeFile("dist/home/server.js.map",n.mapContent),s.logInfo("mka","server-core completed successfully")}()}},"build-simple-page":(e,n)=>{e.build=async function(e,n){}},"build-app-server":(e,n)=>{const o=require("fs/promises"),t=require("chalk"),i=n("admin"),s=n("common"),r=n("run-typescript"),a=n("run-mypack");function l(e){return`src/${e}/server/index.ts`}const c={sourceMap:!0,outDir:"/vbuild",readFileHook:(e,n)=>{let o=n(e);for(const e in s.compileTimeConfig)o=o.split(e).join(s.compileTimeConfig[e]);return o}};function m(e,n){return{type:"lib",entry:`/vbuild/${e}/server/index.js`,files:n,sourceMap:!0,output:`dist/${e}/server.js`,printModules:!0,minify:!1}}e.build=async function(e,n){n?function(e){s.logInfo("mka",t`watch {yellow ${e}-server}`);const n=[];let u=null;r.transpileWatch(l(e),{...c,watchWriteFileHook:(e,o)=>{const t=n.findIndex((n=>n.name==e));t>=0?n.splice(t,1,{name:e,content:o}):n.push({name:e,content:o})},watchEmit:async()=>{const t=await a.pack(m(e,n));t.success&&(await o.writeFile(`dist/${e}/server.js`,t.jsContent),await o.writeFile(`dist/${e}/server.js.map`,t.mapContent)),t.hash!=u?.hash&&await i.admin({type:"reload-server",app:e}),u=t}})}(e):await async function(e){s.logInfo("mka",t`{yellow ${e}-server}`);const n=[];r.transpileOnce(l(e),{...c,writeFileHook:(e,o)=>n.push({name:e,content:o})})||(s.logError("mka",t`{yellow ${e}-server} failed at transpile typescript`),process.exit(1));const u=await a.pack(m(e,n));u.success||(s.logError("mka",t`{yellow ${e}-server} failed at pack`),process.exit(1)),await o.writeFile(`dist/${e}/server.js`,u.jsContent),await o.writeFile(`dist/${e}/server.js.map`,u.mapContent),await i.admin({type:"reload-server",app:e}),s.logInfo("mka",`${e}-server completed successfully`)}(e)}},"build-app-client":(e,n)=>{e.build=async function(e,n){n||await async function(e){}()}},".":(e,n)=>{const o=n("admin"),t=n("common"),i=n("build-self"),s=n("build-server-core"),r=n("build-simple-page"),a=n("build-app-server"),l=n("build-app-client");function c(e){if(JSON.parse(t.compileTimeConfig.APP_NAMES).includes(e))return e;console.log("unknown app name"),process.exit(1)}const[m,u]=[process.argv[2],process.argv[3]];"self"==m?i.build():"server-core"==m?s.build(!1):"watch"==m&&"server-core"==u?s.build(!0):"home-page"==m?r.build("home",!1):"watch"==m&&"home-page"==u?r.build("home",!0):"login-page"==m?r.build("login",!1):"watch"==m&&"login-page"==u?r.build("login",!0):m.endsWith("-client")?l.build(c(m.slice(0,-7)),!1):m.endsWith("-server")?a.build(c(m.slice(0,-7)),!1):"watch"==m&&u.endsWith("-client")?l.build(c(u.slice(0,-7)),!0):"watch"==m&&u.endsWith("-server")?a.build(c(u.slice(0,-7)),!0):"watch"==m&&u?(l.build(c(u),!0),a.build(c(u),!0)):"shutdown"==m?o.admin({type:"shutdown"}).then((()=>process.exit(1))):"reload-static"==m?o.admin({type:"reload-static",key:"www"==u||"login"==u?u:c(u)}).then((()=>process.exit(1))):"reload-server"==m?o.admin({type:"reload-server",app:c(u)}).then((()=>process.exit(1))):"expire-device"==m?o.admin({type:"expire-device",deviceId:parseInt(u)}).then((()=>process.exit(1))):(console.log("unknown command"),process.exit(1))}});