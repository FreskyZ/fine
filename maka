#!/usr/bin/env node
(e=>{const t={};!function r(o){return o in t||(t[o]={},e[o](t[o],r)),t[o]}(".")})({common:(e,t)=>{const r=require("fs"),o=require("chalk"),n=require("dayjs");e.projectDirectory="<PROJECRDIR>",e.nodePackage=JSON.parse(r.readFileSync("package.json","utf-8")),e.compileTimeConfig=JSON.parse(r.readFileSync("maka.config","utf-8")),e.logInfo=function(e,t){console.log(o`[${n().format("HH:mm:ss")}][{cyan ${e}}] ${t}`)},e.logError=function(e,t){console.log(o`[${n().format("HH:mm:ss")}][{red ${e}}] ${t}`)},process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},admin:(e,t)=>{const r=require("net"),o=require("async-mutex"),n=t("common");const i=new o.Mutex;e.admin=async function(e){await i.runExclusive((async()=>await async function(e){const t=r.createConnection("/tmp/fps.socket").ref();return new Promise(((r,o)=>{const i=JSON.stringify(e);t.on("error",(e=>{"code"in e&&"ENOENT"==e.code?(n.logError("adm",`admin socket not open, command ${i} discarded`),r()):(n.logError("adm",`socket error: ${e.message}`),o())})),t.on("timeout",(()=>{n.logError("adm","socket timeout"),t.destroy(),o()})),t.once("data",(e=>{"ACK"==e.toString("utf-8")&&(n.logInfo("adm",`command ${i} acknowledged`),setTimeout((()=>{t.destroy(),r()}),0))})),t.write(i)}))}(e)))}},"run-typescript":(e,t)=>{const r=require("typescript"),o=require("chalk"),n=t("common"),i={lib:["lib.es2020.d.ts"],outDir:"/vbuild",target:r.ScriptTarget.ES2020,module:r.ModuleKind.CommonJS,moduleResolution:r.ModuleResolutionKind.NodeJs,noEmitOnError:!0,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function a(e){return{...i,sourceMap:"sourceMap"in e?e.sourceMap:void 0,lib:"additionalLib"in e?[...i.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:i.lib}}function s({category:e,code:t,messageText:i,file:a,start:s}){if(6031!=t)if(6032==t)n.logInfo("tsc","retranspile");else{if(6194==t)return;{const n=(0,{[r.DiagnosticCategory.Warning]:o.red,[r.DiagnosticCategory.Error]:o.red,[r.DiagnosticCategory.Suggestion]:o.green,[r.DiagnosticCategory.Message]:o.cyan}[e])(`  TS${t} `);let l="";if(a){const{line:e,character:t}=r.getLineAndCharacterOfPosition(a,s);l=o`{yellow ${a.fileName}:${e+1}:${t+1}} `}let c=r.flattenDiagnosticMessageText(i,"\n");c.includes("\n")&&(c="\n"+c),console.log(n+l+c)}}}function l(e){const t=r.sys.readFile;r.sys.readFile=(r,o)=>{let i;if(i=e.readFile?e.readFile(r,(e=>t(e,o))):t(r,o),!r.endsWith(".d.ts"))for(const e in n.compileTimeConfig)i=i.split(e).join(n.compileTimeConfig[e]);return i}}function c(e){return(t,r)=>{if(t.endsWith(".js")){r.startsWith('"use strict"')&&(r=r.slice(r.indexOf("\n")+1)),r.startsWith("Object.defineProperty")&&(r=r.slice(r.indexOf("\n")+1)),r.startsWith("exports.")&&(r=r.slice(r.indexOf("\n")+1));const e=/\/\/#\s*sourceMappingURL/.exec(r);e?r=r.slice(0,e.index):r.endsWith("\n")||(r+="\n")}const o=e.findIndex((e=>e.name==t));o>=0?e.splice(o,1,{name:t,content:r}):e.push({name:t,content:r})}}function m(e,t){n.logInfo("tsc",o`once {yellow ${e.entry}}`),l(t);const i=a(e),m=[],p=function(e){const t=e.diagnostics.filter((e=>e.category==r.DiagnosticCategory.Error||r.DiagnosticCategory.Warning)).length,i=e.diagnostics.length-t;let a;a=0==i&&0==t?"no diagnostic":0!=i&&0==t?o`{yellow ${i}} infos`:0==i?o`{yellow ${t}} errors`:o`{yellow ${t}} errors and {yellow ${i}} infos`,(e.emitSkipped?n.logError:n.logInfo)("tsc",`completed with ${a}`);for(const t of e.diagnostics)s(t);return!e.emitSkipped}(r.createProgram([e.entry],i,r.createCompilerHost(i)).emit(void 0,c(m)));t.afterEmit({success:p,files:m})}function p(e,t){n.logInfo("tsc",o`watch {yellow ${e.entry}}`),l(t);const i=[];r.createWatchProgram(r.createWatchCompilerHost([e.entry],a(e),r.sys,((...e)=>{const o=r.createEmitAndSemanticDiagnosticsBuilderProgram(...e),n=o.emit;return o.emit=(e,r,...o)=>{const a=n(e,c(i),...o);return a.emitSkipped||t.afterEmit({files:i}),a},o}),s,s))}e.transpile=function(e,t){(e.watch?p:m)(e,t)}},"run-mypack":(e,t)=>{const r=require("path"),o=require("chalk"),n=require("crypto-js"),i=require("filesize"),a=require("source-map"),s=require("terser"),l=t("common");e.pack=async function(e){if(e.lastResult?l.logInfo("mpk","repack"):l.logInfo("mpk",o`pack {yellow ${e.entry}}`),!e.files.some((t=>t.name==e.entry)))return l.logError("mpk","invalid entry"),{success:!1};const t=r.dirname(e.entry),c=e.sourceMap?e.files.filter((e=>e.name.endsWith(".js"))).map((({name:t,content:r})=>({name:t,jsContent:r,mapContent:e.files.find((e=>e.name==t+".map")).content}))):e.files.map((({name:e,content:t})=>({name:e,jsContent:t,mapContent:null})));let m=null;e.sourceMap&&(m=new a.SourceMapGenerator({file:e.output}));let p=3;const d=[];let u="app"==e.type?"((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n":"module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n";for(let{name:o,jsContent:i,mapContent:s}of c){let f=r.relative(t,o);f.endsWith(".js")&&(f=f.slice(0,-3)),f.endsWith("index")&&(f=f.slice(0,-5)),0==f.length&&(f=".");let y=i;for(;;){const e=/require\("(?<moduleName>\.[\.\w\-\/]*)"\);/,n=e.exec(y);if(!n)break;const i=r.join(r.dirname(o),n.groups.moduleName);let a=c.some((e=>e.name==i))?i:c.some((e=>e.name==i+".js"))?i+".js":c.some((e=>e.name==i+"/index.js"))?i+"/index.js":null;if(null===a)return l.logError("mpk",`${o}: invalid module name ${n.groups.moduleName} at ${n.index}`),{success:!1};a=r.relative(t,a),a=a.slice(0,-3),a.endsWith("index")&&(a=a.slice(0,-5)),0==a.length&&(a="."),y=y.replace(e,`__myrequire__("${a}");`)}if(u+=`'${f}': (exports, __myrequire__) => {\n${y}}, `,d.push({fileName:o,moduleName:f,contentLength:y.length,hash:n.SHA256(y).toString()}),e.sourceMap){let e=null;(await new a.SourceMapConsumer(JSON.parse(s))).eachMapping((t=>{null===e&&(e=t.generatedLine),m.addMapping({source:r.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-e+p+1,column:t.generatedColumn}})}))}p+=y.split("\n").length}u+="})\n";let f=m?.toString();if(e.minify){const t=await s.minify(u,{sourceMap:!!e.sourceMap&&{content:f,filename:e.output,url:e.output+".map"}});u=t.code,f="object"==typeof t.map?JSON.stringify(t.map):t.map}const y=n.SHA256(u).toString();if(y===e.lastResult?.hash)l.logInfo("mpk","completed with no change");else if(e.lastResult||(l.logInfo("mpk","completed with no error"),e.output&&l.logInfo("mpk",o`asset {yellow ${e.output}}`)),l.logInfo("mpk",o`asset size {gray ${i(u.length)}} compression rate {gray ${(u.length/c.reduce(((e,t)=>e+t.jsContent.length),0)*100).toFixed(2)}%}`),e.printModules)if(e.lastResult){for(const t of d.filter((t=>!e.lastResult.modules.some((e=>e.fileName==t.fileName)))))console.log(o`  {gray +} ${t.fileName} {cyan ${t.moduleName}} {gray size ${i(t.contentLength)}}`);for(const[t]of d.map((t=>[t,e.lastResult.modules.find((e=>e.fileName==t.fileName))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(o`  {gray *} ${t.fileName} {cyan ${t.moduleName}} {gray size ${i(t.contentLength)}}`);for(const t of e.lastResult.modules.filter((e=>!d.some((t=>t.fileName==e.fileName)))))console.log(o`  {gray - removed ${t.fileName}} {cyan ${t.moduleName}}`)}else for(const{fileName:e,moduleName:t,contentLength:r}of d)console.log(o`   {gray +} ${e} {cyan ${t}} {gray size ${i(r)}}`);return{success:!0,jsContent:u,mapContent:f,hash:y,modules:d}}},"build-self":(e,t)=>{const r=require("fs"),o=require("chalk"),n=t("common"),i=t("run-typescript"),a=t("run-mypack"),s={entry:"script/index.ts"},l={type:"app",entry:"/vbuild/index.js",files:[],output:"maka",minify:!0};e.build=function(){n.logInfo("mka",o`{yellow self}`),i.transpile(s,{afterEmit:async({success:e,files:t})=>{e||(n.logError("mka",o`{yellow self} failed at transpile}`),process.exit(1));const i=await a.pack({...l,files:t});i.success||(n.logError("mka",o`{yellow self} failed at pack`),process.exit(1)),r.writeFileSync("maka","#!/usr/bin/env node\n"+i.jsContent),n.logInfo("mka","self completed successfully")}})}},"build-server-core":(e,t)=>{const r=require("child_process"),o=require("fs"),n=require("chalk"),i=t("common"),a=t("admin"),s=t("run-typescript"),l=t("run-mypack"),c={entry:"src/server-core/index.ts",sourceMap:!0},m={type:"app",entry:"/vbuild/server-core/index.js",files:[],sourceMap:!0,output:"dist/home/server.js",printModules:!0,minify:!0};function p(){i.logInfo("mka",n`{yellow server-core}`),s.transpile(c,{afterEmit:async({success:e,files:t})=>{e||(i.logError("mka",n`{yellow server-core} failed at transpile typescript`),process.exit(1));const r=await l.pack({...m,files:t});r.success||(i.logError("mka",n`{yellow server-core} failed at pack`),process.exit(1)),await Promise.all([o.promises.writeFile("dist/home/server.js",r.jsContent),o.promises.writeFile("dist/home/server.js.map",r.mapContent)]),i.logInfo("mka","server-core completed successfully")}})}let d=null;function u(){function e(){i.logInfo("mds","start server"),d=r.spawn("node",["dist/home/server.js"]),d.stdout.pipe(process.stdout),d.stderr.pipe(process.stderr),d.on("error",(e=>{i.logError("mds",`server process error ${e.message}`)})),d.on("exit",(e=>{(0==e?i.logInfo:i.logError)("mds",`server process exited with code ${e}`),d=null}))}null!=d?(d.once("exit",e),a.admin({type:"shutdown"})):e()}function f(){i.logInfo("mka",n`watch {yellow server-core}`),process.on("exit",(()=>d?.kill()));let e=null;s.transpile({...c,watch:!0},{afterEmit:async({files:t})=>{const r=await l.pack({...m,files:t,lastResult:e});r.success&&(await Promise.all([o.promises.writeFile("dist/home/server.js",r.jsContent),o.promises.writeFile("dist/home/server.js.map",r.mapContent)]),r.hash!=e?.hash&&u(),e=r)}})}e.startOrRestartServer=u,e.build=function(e){(e?f:p)()}},"run-sass":(e,t)=>{const r=require("chalk"),o=require("node-sass"),n=t("common");e.transpile=async function(e){return n.logInfo("css",r`transpile {yellow ${e.file}}`),new Promise(((t,r)=>{o.render(e,((o,i)=>{o?(n.logError("css",`error at ${e.file}:${o.line}:${o.column}: ${o.message}`),r()):(n.logInfo("css",`transpile completed in ${i.stats.duration}ms`),t(i.css.toString("utf-8")))}))}))}},"build-simple-page":(e,t)=>{const r=require("fs"),o=require("chalk"),n=t("common"),i=t("run-typescript"),a=t("run-sass"),s=t("admin"),l=e=>"index"==e?"www":"login",c=e=>({entry:`src/home-page/${e}.ts`,additionalLib:["dom"]}),m=e=>({file:`src/home-page/${e}.sass`,outputStyle:"compressed"});e.build=async function(e,t){t?function(e){n.logInfo("mka",o`watch {yellow ${e}-page}`),"index"!=e&&i.transpile({...c(e),watch:!0},{afterEmit:({files:t})=>{r.writeFileSync(`dist/home/${e}.js`,t[0].content),s.admin({type:"reload-static",key:l(e)}).catch((()=>{}))}}),r.watchFile(`src/home-page/${e}.html`,{persistent:!1},((t,i)=>{t.mtime!=i.mtime&&(n.logInfo("htm",o`copy {yellow ${e}.html}`),r.copyFileSync(`src/home-page/${e}.html`,`dist/home/${e}.html`),n.logInfo("htm","copy completed"),s.admin({type:"reload-static",key:l(e)}).catch((()=>{})))}));const t=m(e);r.watchFile(t.file,{persistent:!1},((t,o)=>{t.mtime!=o.mtime&&a.transpile(m(e)).then((t=>{r.writeFileSync(`dist/home/${e}.css`,t),s.admin({type:"reload-static",key:l(e)}).catch((()=>{}))})).catch((()=>{}))})),process.on("SIGINT",(()=>{r.unwatchFile(`src/home-page/${e}.html`),r.unwatchFile(t.file),process.exit(0)})),n.logInfo("mka","tsc watch and fs watch setup")}(e):await async function(e){if(n.logInfo("mka",o`{yellow ${e}-page}`),"index"!=e){const t=await new Promise((t=>i.transpile(c(e),{afterEmit:({success:r,files:i})=>{r||(n.logError("mka",o`{yellow ${e}-page} failed at transpile typescript`),process.exit(1)),t(i)}})));await r.promises.writeFile(`dist/home/${e}.js`,t[0].content)}try{const t=await a.transpile(m(e));await r.promises.writeFile(`dist/home/${e}.css`,t)}catch{n.logError("mka",o`{yellow ${e}-page} failed at transpile stylesheet`),process.exit(1)}n.logInfo("htm",o`copy {yellow ${e}.html}`),await r.promises.copyFile(`src/home-page/${e}.html`,`dist/home/${e}.html`),n.logInfo("htm","copy completed"),await s.admin({type:"reload-static",key:l(e)}),n.logInfo("mka",`build ${e}-page completed succesfully`)}(e)}},"run-codegen":(e,t)=>{const r=require("fs/promises"),o=require("chalk"),n=require("xml2json"),i=t("common"),a=["GET","POST","PUT","PATCH","DELETE"],s={GET:"get",POST:"post",PUT:"put",PATCH:"patch",DELETE:"del"},l=["id","number","string","boolean","date","time"],c={id:{pattern:"\\d+",validator:"validateId",tsType:"number"},number:{pattern:"\\d+",validator:"validateNumber",tsType:"number"},string:{pattern:".+",validator:"validateString",tsType:"string"},boolean:{pattern:"(true|false)",validator:"validateBoolean",tsType:"boolean"},date:{pattern:"\\d{6}",validator:"validateDate",tsType:"Dayjs"},time:{pattern:"\\d{12}",validator:"validateTime",tsType:"Dayjs"}};async function m(e){const t=await r.readFile(`src/${e}/api.xml`,"utf-8"),{version:o,api:i}=n.toJson(t,{object:!0})[`${e}-api`];return{version:o,definitions:i.map(((e,t)=>{const r=e.name;if(!r)throw new Error(`index ${t} api name is required`);const o=e.method;if(!a.includes(o))throw new Error(`api ${r} invalid method`);const n=e.path;if(!n)throw new Error(`api ${r} path is required`);if(!n.startsWith("/"))throw new Error(`api ${r} path should be absolute`);const i=function(e,t){const r=[];for(;;){const o=/\{(?<parameterName>[\w\_]+):(?<parameterType>\w+)\}/.exec(t);if(!o)break;if(10==r.filter((e=>"parameter"==e.type)).length)throw new Error(`api ${e} too many parameters`);const[n,i]=[o.groups.parameterName,o.groups.parameterType];if(!l.includes(i))throw new Error(`api ${e} parameter ${n} invalid type ${i}`);0!=o.index&&r.push({type:"normal",value:t.slice(0,o.index)}),r.push({type:"parameter",parameterName:n,parameterType:i}),t=t.slice(o.index+n.length+i.length+3)}return t.length&&r.push({type:"normal",value:t}),r}(r,n),[s,c]=[e["body-type"],e["body-name"]];if(["POST","PUT","PATCH"].includes(o)&&(!s||!c))throw new Error(`api ${r} body is required for ${o}`);return{namespace:e.namespace||"default",apiName:r,method:o,apiPath:i,bodyType:s,bodyName:c,returnType:e["return-type"]||"void"}}))}}e.generate=async function(e,t){return"server"==t?await async function(e){const t=`src/${e}/server/index.ts`;let n;i.logInfo("fcg",o`generate {yellow ${t}}`);try{n=await m(e)}catch(e){return i.logError("fcg",e.message),!1}const{version:a,definitions:s}=n;let p="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==s.length)return p+="// empty\n",await r.writeFile(t,p),i.logInfo("fcg","generate completed with empty"),!0;p+=`import { WebContext, ${l.filter((e=>s.some((t=>t.apiPath.some((t=>"parameter"==t.type&&t.parameterType==e)))))).map((e=>c[e].validator)).concat(s.some((e=>["PUT","POST","PATCH"].includes(e.method)))?["validateBody"]:[]).join(", ")} } from '../../shared/api-server';\n`,p+="import { MyError } from '../../shared/error';\n";for(const e of s.map((e=>e.namespace)).filter(((e,t,r)=>r.indexOf(e)==t)))p+=`import { ${s.filter((t=>t.namespace==e)).map((e=>e.apiName)).join(", ")} } from './${e}';\n`;p+="\n",p+="export async function dispatch(ctx: WebContext) {\n",p+="    let match: RegExpExecArray;\n",p+=`    if (!ctx.path.startsWith('/${e}/v${a}')) { throw new MyError('not-found', 'invalid invocation version'); }\n`,p+=`    const methodPath = \`\${ctx.method} \${ctx.path.slice(${e.length+a.length+3})}\`;\n`,p+="\n";for(const e of s){const{apiName:t,method:r,apiPath:o,bodyType:n,returnType:i}=e;p+=`    match = /^${r} `;for(const e of o)"normal"==e.type?p+=e.value.split("/").join("\\/"):p+=`(?<${e.parameterName}>${c[e.parameterType].pattern})`;p+="$/.exec(methodPath); if (match) {\n",p+="        ",i&&"void"!=i&&(p+="ctx.body = "),p+=`await ${t}(ctx.state`;for(const{parameterName:e,parameterType:t}of o.filter((e=>"parameter"==e.type)))p+=`, ${c[t].validator}('${e}', match.groups['${e}'])`;n&&(p+=", validateBody(ctx.request.body)"),p+=");\n","POST"==r?p+="        ctx.status = 201;\n":"DELETE"==r&&(p+="        ctx.status = 204;\n"),p+="        return;\n",p+="    }\n"}return p+="\n",p+="    throw new MyError('not-found', 'invalid invocation');\n",p+="}\n",await r.writeFile(t,p),i.logInfo("fcg","generate completed"),!0}(e):await async function(e){const t=`src/${e}/client/api.ts`;let n;i.logInfo("fcg",o`generate {yellow ${t}}`);try{n=await m(e)}catch(e){return i.logError("fcg",e.message),!1}const{version:l,definitions:p}=n;let d="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==p.length)return d+="// empty\n",await r.writeFile(t,d),i.logInfo("fcg","generate completed with empty"),!0;p.some((e=>e.apiPath.some((e=>"parameter"==e.type&&["date","time"].includes(e.parameterType)))))&&(d+="import type { Dayjs } from 'dayjs';\n"),d+=`import { ${a.filter((e=>p.some((t=>t.method==e)))).map((e=>s[e])).join(", ")} } from '../../shared/api-client';\n`,d+=`import type { ${p.filter((e=>!!e.bodyType)).map((e=>e.bodyType)).filter(((e,t,r)=>r.indexOf(e)==t)).join(",")} } from '../api';\n`,d+="\n";for(const t of p){const{apiName:r,method:o,apiPath:n,bodyType:i,bodyName:a,returnType:m}=t;d+=`export const ${r} = (`;for(const{parameterName:e,parameterType:t}of n.filter((e=>"parameter"==e.type)))d.endsWith("(")||(d+=", "),d+=`${e}: ${c[t].tsType}`;i&&(d.endsWith("(")||(d+=", "),d+=`${a}: ${i}`),d+=`): Promise<${m}> => ${s[o]}(\`/${e}/v${l}`;for(const e of n)"normal"==e.type?d+=e.value:"date"==e.parameterType?d+=`\${${e.parameterName}.format('YYYYMMDD')}`:"time"==e.parameterType?d+=`\${${e.parameterName}.format('YYYYMMDDHHmmdd')}`:d+=`\${${e.parameterName}}`;d+="`",i&&(d+=`, ${a}`),d+=");\n"}return await r.writeFile(t,d),i.logInfo("fcg","generate completed"),!0}(e)}},"build-app-server":(e,t)=>{const r=require("fs"),o=require("chalk"),n=t("admin"),i=t("common"),a=t("run-codegen"),s=t("run-typescript"),l=t("run-mypack"),c=(e,t)=>({entry:`src/${e}/server/index.ts`,sourceMap:!0,watch:t}),m=(e,t,r)=>({type:"lib",entry:`/vbuild/${e}/server/index.js`,files:t,sourceMap:!0,output:`dist/${e}/server.js`,printModules:!0,minify:!0,lastResult:r});e.build=async function(e,t){t?function(e){i.logInfo("mka",o`watch {yellow ${e}-server}`),r.watchFile(`src/${e}/api.xml`,{persistent:!1},((t,r)=>{t.mtime!=r.mtime&&a.generate(e,"server")})),process.on("SIGINT",(()=>{r.unwatchFile(`src/${e}/api.xml`),process.exit(0)}));let t=null;s.transpile(c(e,!0),{afterEmit:async({files:o})=>{const i=await l.pack(m(e,o,t));i.success&&(await Promise.all([r.promises.writeFile(`dist/${e}/server.js`,i.jsContent),r.promises.writeFile(`dist/${e}/server.js.map`,i.mapContent)]),i.hash!=t?.hash&&await n.admin({type:"reload-server",app:e}),t=i)}}),a.generate(e,"server")}(e):await async function(e){i.logInfo("mka",o`{yellow ${e}-server}`),await a.generate(e,"server")||(i.logError("mka",o`{yellow ${e}-server} failed at code generation`),process.exit(1)),s.transpile(c(e,!1),{afterEmit:async({success:t,files:a})=>{t||(i.logError("mka",o`{yellow ${e}-server} failed at transpile typescript`),process.exit(1));const s=await l.pack(m(e,a));s.success||(i.logError("mka",o`{yellow ${e}-server} failed at pack`),process.exit(1)),await Promise.all([r.promises.writeFile(`dist/${e}/server.js`,s.jsContent),r.promises.writeFile(`dist/${e}/server.js.map`,s.mapContent)]),await n.admin({type:"reload-server",app:e}),i.logInfo("mka",`${e}-server completed successfully`)}})}(e)}},"build-app-client":(e,t)=>{e.build=async function(e,t){t||await async function(e){}()}},".":(e,t)=>{const r=t("admin"),o=t("build-self"),n=t("build-server-core"),i=t("build-simple-page"),a=t("build-app-server"),s=t("build-app-client");function l(e){if(["ak","collect","cost"].includes(e))return e;console.log("unknown app name"),process.exit(1)}const[c,m]=[process.argv[2],process.argv[3]];"self"==c?o.build():"server-core"==c?n.build(!1):"watch"==c&&"server-core"==m?n.build(!0):"index-page"==c?i.build("index",!1):"watch"==c&&"index-page"==m?i.build("index",!0):"login-page"==c?i.build("login",!1):"watch"==c&&"login-page"==m?i.build("login",!0):c.endsWith("-client")?s.build(l(c.slice(0,-7)),!1):c.endsWith("-server")?a.build(l(c.slice(0,-7)),!1):"watch"==c&&m.endsWith("-client")?s.build(l(m.slice(0,-7)),!0):"watch"==c&&m.endsWith("-server")?a.build(l(m.slice(0,-7)),!0):"watch"==c&&m?(s.build(l(m),!0),a.build(l(m),!0)):"shutdown"==c?r.admin({type:"shutdown"}).then((()=>process.exit(1))):"reload-static"==c?r.admin({type:"reload-static",key:"www"==m||"login"==m?m:l(m)}).then((()=>process.exit(1))):"reload-server"==c?r.admin({type:"reload-server",app:l(m)}).then((()=>process.exit(1))):"expire-device"==c?r.admin({type:"expire-device",deviceId:parseInt(m)}).then((()=>process.exit(1))):(console.log("unknown command"),process.exit(1))}});