#!/usr/bin/env node
(e=>{const t={};!function o(n){return n in t||(t[n]={},e[n](t[n],o)),t[n]}(".")})({common:(e,t)=>{const o=require("fs"),n=require("chalk"),i=require("dayjs");e.projectDirectory="<PROJECTDIR>",e.nodePackage=JSON.parse(o.readFileSync("package.json","utf-8")),e.compileTimeConfig=JSON.parse(o.readFileSync("maka.config","utf-8")),e.logInfo=function(e,t){console.log(n`[${i().format("HH:mm:ss")}][{cyan ${e}}] ${t}`)},e.logError=function(e,t){console.log(n`[${i().format("HH:mm:ss")}][{red ${e}}] ${t}`)},process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},admin:(e,t)=>{const o=require("net"),n=require("async-mutex"),i=t("common");const s=new n.Mutex;e.admin=async function(e){await s.runExclusive((async()=>await async function(e){const t=o.createConnection("/tmp/fps.socket").ref();return new Promise(((o,n)=>{const s=JSON.stringify(e);t.on("error",(e=>{"code"in e&&"ENOENT"==e.code?(i.logError("adm",`admin socket not open, command ${s} discarded`),o()):(i.logError("adm",`socket error: ${e.message}`),n())})),t.on("timeout",(()=>{i.logError("adm","socket timeout"),t.destroy(),n()})),t.once("data",(e=>{"ACK"==e.toString("utf-8")&&(i.logInfo("adm",`command ${s} acknowledged`),setTimeout((()=>{t.destroy(),o()}),0))})),t.write(s)}))}(e)))}},"run-typescript":(e,t)=>{const o=require("typescript"),n=require("chalk"),i=t("common");e.ModuleKind=o.ModuleKind,e.ModuleResolutionKind=o.ModuleResolutionKind;const s={lib:["lib.es2020.d.ts"],target:o.ScriptTarget.ES2020,module:o.ModuleKind.CommonJS,moduleResolution:o.ModuleResolutionKind.NodeJs,noEmitOnError:!0,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0},r={[o.DiagnosticCategory.Warning]:n.red,[o.DiagnosticCategory.Error]:n.red,[o.DiagnosticCategory.Suggestion]:n.green,[o.DiagnosticCategory.Message]:n.cyan};function l({category:e,code:t,messageText:s,file:l,start:a}){if(6031!=t)if(6032==t)i.logInfo("tsc","retranspile");else{if(6194==t)return;{const i=r[e](`  TS${t} `);let c="";if(l){const{line:e,character:t}=o.getLineAndCharacterOfPosition(l,a);c=n`{yellow ${l.fileName}:${e+1}:${t+1}} `}let m=o.flattenDiagnosticMessageText(s,"\n");m.includes("\n")&&(m="\n"+m),console.log(i+c+m)}}}e.transpileOnce=function(e,t){i.logInfo("tsc",n`once {yellow ${e}}`);const r={...s,...t,lib:"lib"in t?[...s.lib,...t.lib]:s.lib},a=function(e){const t=o.createCompilerHost(e);if(e.readFileHook){const o=t.readFile;t.readFile=t=>e.readFileHook(t,o)}const n=t.writeFile;return t.writeFile=(t,o,i,s,r)=>{t.endsWith(".js")&&((o=o.slice(o.indexOf("\n",o.indexOf("\n")+1)+1)).startsWith("exports.")&&(o=o.slice(o.indexOf("\n")+1)),e.sourceMap?o=o.slice(0,o.lastIndexOf("\n")+1):o.endsWith("\n")||(o+="\n")),e.writeFileHook?e.writeFileHook(t,o,i,s,r,n):n(t,o,i,s,r)},t}(r),c=o.createProgram(Array.isArray(e)?e:[e],r,a),{diagnostics:m}=c.emit(),{success:d,message:u}=function(e){const t=e.filter((e=>e.category==o.DiagnosticCategory.Error||o.DiagnosticCategory.Warning)).length,i=e.length-t;let s;return s=0==i&&0==t?"no diagnostic":0!=i&&0==t?n`{yellow ${i}} infos`:0==i?n`{yellow ${t}} errors`:n`{yellow ${t}} errors and {yellow ${i}} infos`,{success:0==t,message:s}}(m);return d?i.logInfo("tsc",`completed with ${u}`):i.logError("tsc",`completed with ${u}`),m.map(l),m.length>0&&i.logError("tsc","end of transpile diagnostics"),d},e.transpileWatch=function(e,t){if(i.logInfo("tsc",n`watch {yellow ${e}}`),t.watchReadFileHook){const e=o.sys.readFile;o.sys.readFile=(o,n)=>t.watchReadFileHook(o,n,e)}const r=o.sys.writeFile;o.sys.writeFile=(e,o,n)=>{e.endsWith(".js")&&((o=o.slice(o.indexOf("\n",o.indexOf("\n")+1)+1)).startsWith("exports.")&&(o=o.slice(o.indexOf("\n")+1)),t.sourceMap?o=o.slice(0,o.lastIndexOf("\n")+1):o.endsWith("\n")||(o+="\n")),t.watchWriteFileHook?t.watchWriteFileHook(e,o,n,r):r(e,o,n)},o.createWatchProgram(o.createWatchCompilerHost([e],{...s,...t},o.sys,((...e)=>{const n=o.createEmitAndSemanticDiagnosticsBuilderProgram(...e);if(t.watchEmit){const e=n.emit;n.emit=(...o)=>{const n=e(...o);return n.emitSkipped||t.watchEmit(),n}}return n}),l,l))}},"run-mypack":(e,t)=>{const o=require("path"),n=require("chalk"),i=require("crypto-js"),s=require("filesize"),r=require("source-map"),l=require("terser"),a=t("common");e.pack=async function(e){if(e.lastResult?a.logInfo("mpk","repack"):a.logInfo("mpk",n`pack {yellow ${e.entry}}`),!e.files.some((t=>t.name==e.entry)))return a.logError("mpk","invalid entry"),{success:!1};const t=o.dirname(e.entry),c=e.sourceMap?e.files.filter((e=>e.name.endsWith(".js"))).map((({name:t,content:o})=>({name:t,jsContent:o,mapContent:e.files.find((e=>e.name==t+".map")).content}))):e.files.map((({name:e,content:t})=>({name:e,jsContent:t,mapContent:null})));let m=null;e.sourceMap&&(m=new r.SourceMapGenerator({file:e.output}));let d=3;const u=[];let p="app"==e.type?"((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n":"module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n";for(let{name:n,jsContent:s,mapContent:l}of c){let f=o.relative(t,n);f.endsWith(".js")&&(f=f.slice(0,-3)),f.endsWith("index")&&(f=f.slice(0,-5)),0==f.length&&(f=".");let g=s;for(;;){const e=/require\("(?<moduleName>\.[\.\w\-\/]*)"\);/,i=e.exec(g);if(!i)break;const s=o.join(o.dirname(n),i.groups.moduleName);let r=c.some((e=>e.name==s))?s:c.some((e=>e.name==s+".js"))?s+".js":c.some((e=>e.name==s+"/index.js"))?s+"/index.js":null;if(null===r)return a.logError("mpk",`${n}: invalid module name ${i.groups.moduleName} at ${i.index}`),{success:!1};r=o.relative(t,r),r=r.slice(0,-3),r.endsWith("index")&&(r=r.slice(0,-5)),0==r.length&&(r="."),g=g.replace(e,`__myrequire__("${r}");`)}if(p+=`'${f}': (exports, __myrequire__) => {\n${g}}, `,u.push({fileName:n,moduleName:f,contentLength:g.length,hash:i.SHA256(g).toString()}),e.sourceMap){let e=null;(await new r.SourceMapConsumer(JSON.parse(l))).eachMapping((t=>{null===e&&(e=t.generatedLine),m.addMapping({source:o.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-e+d+1,column:t.generatedColumn}})}))}d+=g.split("\n").length}if(p+="})\n",e.minify){p=(await l.minify(p)).code}const f=i.SHA256(p).toString();if(f===e.lastResult?.hash)a.logInfo("mpk","completed with no change");else if(e.lastResult||(a.logInfo("mpk","completed with no error"),e.output&&a.logInfo("mpk",n`asset {yellow ${e.output}}`),a.logInfo("mpk",n`asset size {gray ${s(p.length)}} compression rate {gray ${(p.length/c.reduce(((e,t)=>e+t.jsContent.length),0)*100).toFixed(2)}%}`)),e.printModules)if(e.lastResult){for(const t of u.filter((t=>!e.lastResult.modules.some((e=>e.fileName==t.fileName)))))console.log(n`  {gray +} ${t.fileName} {cyan ${t.moduleName}} {gray size ${s(t.contentLength)}}`);for(const[t]of u.map((t=>[t,e.lastResult.modules.find((e=>e.fileName==t.fileName))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(n`  {gray *} ${t.fileName} {cyan ${t.moduleName}} {gray size ${s(t.contentLength)}}`);for(const t of e.lastResult.modules.filter((e=>!u.some((t=>t.fileName==e.fileName)))))console.log(n`  {gray - removed ${t.fileName}} {cyan ${t.moduleName}}`)}else for(const{fileName:e,moduleName:t,contentLength:o}of u)console.log(n`   {gray +} ${e} {cyan ${t}} {gray size ${s(o)}}`);return{success:!0,jsContent:p,mapContent:m?.toString(),hash:f,modules:u}}},"build-self":(e,t)=>{const o=require("fs"),n=require("chalk"),i=t("common"),s=t("run-typescript"),r=t("run-mypack"),l=["script/index.ts"],a={types:["node"],outDir:"/vbuild"};function c(e){return(t,o)=>{e.push({name:t,content:o})}}const m={type:"app",entry:"/vbuild/index.js",files:[],output:"maka",minify:!0};e.build=async function(){i.logInfo("mka",n`{yellow self}`);const e=[];s.transpileOnce(l,{...a,writeFileHook:c(e)})||(i.logError("mka","self failed at transpile typescript"),process.exit(1));const t=await r.pack({...m,files:e});t.success||(i.logError("mka","self failed at pack"),process.exit(1)),o.writeFileSync("maka","#!/usr/bin/env node\n"+t.jsContent),i.logInfo("mka","self completed successfully")}},"build-server-core":(e,t)=>{const o=require("child_process"),n=require("fs/promises"),i=require("chalk"),s=t("common"),r=t("admin"),l=t("run-typescript"),a=t("run-mypack"),c="src/server-core/index.ts",m={sourceMap:!0,outDir:"/vbuild",readFileHook:(e,t)=>{let o=t(e);if(!e.endsWith(".d.ts"))for(const e in s.compileTimeConfig)o=o.split(e).join(s.compileTimeConfig[e]);return o},watchReadFileHook:(e,t,o)=>{let n=o(e,t);if(!e.endsWith(".d.ts"))for(const e in s.compileTimeConfig)n=n.split(e).join(s.compileTimeConfig[e]);return n}},d={type:"app",entry:"/vbuild/server-core/index.js",files:[],sourceMap:!0,output:"dist/home/server.js",printModules:!0,minify:!1};let u=null;function p(){function e(){s.logInfo("mds","start server"),u=o.spawn("node",["dist/home/server.js"]),u.stdout.pipe(process.stdout),u.stderr.pipe(process.stderr),u.on("error",(e=>{s.logError("mds",`server process error ${e.message}`)})),u.on("exit",(e=>{(0==e?s.logInfo:s.logError)("mds",`server process exited with code ${e}`),u=null}))}null!=u?(u.once("exit",e),r.admin({type:"shutdown"})):e()}e.startOrRestartServer=p,e.build=async function(e){e?function(){s.logInfo("mka",i`watch {yellow server-core}`),process.on("exit",(()=>u?.kill()));const e=[];let t=null;l.transpileWatch(c,{...m,watchWriteFileHook:(t,o)=>{const n=e.findIndex((e=>e.name==t));n>=0?e.splice(n,1,{name:t,content:o}):e.push({name:t,content:o})},watchEmit:async()=>{const o=await a.pack({...d,files:e,lastResult:t});o.success&&(await n.writeFile("dist/home/server.js",o.jsContent),await n.writeFile("dist/home/server.js.map",o.mapContent)),o.hash!=t?.hash&&p(),t=o}})}():await async function(){s.logInfo("mka",i`{yellow server-core}`);const e=[];l.transpileOnce(c,{...m,writeFileHook:(t,o)=>e.push({name:t,content:o})})||(s.logError("mka",i`{yellow server-core} failed at transpile typescript`),process.exit(1));const t=await a.pack({...d,files:e});t.success||(s.logError("mka",i`{yellow server-core} failed at pack`),process.exit(1)),await n.writeFile("dist/home/server.js",t.jsContent),await n.writeFile("dist/home/server.js.map",t.mapContent),s.logInfo("mka","server-core completed successfully")}()}},"build-simple-page":(e,t)=>{const o=require("fs"),n=require("fs/promises"),i=require("chalk"),s=t("common"),r=t("run-typescript"),l=require("node-sass"),a=t("admin"),c=e=>"index"==e?"www":"login",m=e=>`src/home-page/${e}.ts`,d={outDir:"dist/home/",lib:["lib.dom.d.ts"]},u=e=>({file:`src/home-page/${e}.sass`,outputStyle:"compressed"});async function p(e,t){return s.logInfo("css",i`transpile {yellow ${e.file}}${t?` #${t}`:""}`),new Promise(((t,o)=>{l.render(e,((n,i)=>{n?(s.logError("css",`error at ${e.file}:${n.line}:${n.column}: ${n.message}`),o()):(s.logInfo("css",`transpile completed in ${i.stats.duration}ms`),t(i.css.toString("utf-8")))}))}))}e.build=async function(e,t){t?function(e){s.logInfo("mka",i`watch {yellow ${e}-page}`),"index"!=e&&r.transpileWatch(m(e),{...d,watchEmit:()=>{a.admin({type:"reload-static",key:c(e)}).catch((()=>{}))}});let t=0;o.watchFile(`src/home-page/${e}.html`,{persistent:!1},((n,r)=>{n.mtime!=r.mtime&&(t+=1,s.logInfo("htm",i`copy {yellow ${e}.html} #${t}`),o.copyFileSync(`src/home-page/${e}.html`,`dist/home/${e}.html`),s.logInfo("htm","copy completed"),a.admin({type:"reload-static",key:c(e)}).catch((()=>{})))}));let n=0;const l=u(e);o.watchFile(l.file,{persistent:!1},((t,o)=>{t.mtime!=o.mtime&&p(u(e),n).then((()=>{n+=1,a.admin({type:"reload-static",key:c(e)}).catch((()=>{}))})).catch((()=>{}))})),process.on("SIGINT",(()=>{o.unwatchFile("build/home-page/index.js"),o.unwatchFile("src/home-page/index.html"),o.unwatchFile("src/home-page/index.sass"),process.exit(0)})),s.logInfo("mka","tsc watch and fs watch setup")}(e):await async function(e){s.logInfo("mka",i`{yellow ${e}-page}`),"index"!=e&&(r.transpileOnce(m(e),d)||(s.logError("mka",i`{yellow ${e}-page} failed at transpile typescript`),process.exit(1)));try{const t=await p(u(e));await n.writeFile(`dist/home/${e}.css`,t)}catch{s.logError("mka",i`{yellow ${e}-page} failed at transpile stylesheet`),process.exit(1)}s.logInfo("htm",i`copy {yellow ${e}.html}`),await n.copyFile(`src/home-page/${e}.html`,`dist/home/${e}.html`),s.logInfo("htm","copy completed"),await a.admin({type:"reload-static",key:c(e)}),s.logInfo("mka",`build ${e}-page completed succesfully`)}(e)}},"build-app-server":(e,t)=>{const o=require("fs/promises"),n=require("chalk"),i=t("admin"),s=t("common"),r=t("run-typescript"),l=t("run-mypack");function a(e){return`src/${e}/server/index.ts`}const c={sourceMap:!0,outDir:"/vbuild",readFileHook:(e,t)=>{let o=t(e);if(!e.endsWith(".d.ts"))for(const e in s.compileTimeConfig)o=o.split(e).join(s.compileTimeConfig[e]);return o},watchReadFileHook:(e,t,o)=>{let n=o(e,t);if(!e.endsWith(".d.ts"))for(const e in s.compileTimeConfig)n=n.split(e).join(s.compileTimeConfig[e]);return n}};function m(e,t){return{type:"lib",entry:`/vbuild/${e}/server/index.js`,files:t,sourceMap:!0,output:`dist/${e}/server.js`,printModules:!0,minify:!1}}e.build=async function(e,t){t?function(e){s.logInfo("mka",n`watch {yellow ${e}-server}`);const t=[];let d=null;r.transpileWatch(a(e),{...c,watchWriteFileHook:(e,o)=>{const n=t.findIndex((t=>t.name==e));n>=0?t.splice(n,1,{name:e,content:o}):t.push({name:e,content:o})},watchEmit:async()=>{const n=await l.pack(m(e,t));n.success&&(await o.writeFile(`dist/${e}/server.js`,n.jsContent),await o.writeFile(`dist/${e}/server.js.map`,n.mapContent)),n.hash!=d?.hash&&await i.admin({type:"reload-server",app:e}),d=n}})}(e):await async function(e){s.logInfo("mka",n`{yellow ${e}-server}`);const t=[];r.transpileOnce(a(e),{...c,writeFileHook:(e,o)=>t.push({name:e,content:o})})||(s.logError("mka",n`{yellow ${e}-server} failed at transpile typescript`),process.exit(1));const d=await l.pack(m(e,t));d.success||(s.logError("mka",n`{yellow ${e}-server} failed at pack`),process.exit(1)),await o.writeFile(`dist/${e}/server.js`,d.jsContent),await o.writeFile(`dist/${e}/server.js.map`,d.mapContent),await i.admin({type:"reload-server",app:e}),s.logInfo("mka",`${e}-server completed successfully`)}(e)}},"build-app-client":(e,t)=>{e.build=async function(e,t){t||await async function(e){}()}},".":(e,t)=>{const o=t("admin"),n=t("common"),i=t("build-self"),s=t("build-server-core"),r=t("build-simple-page"),l=t("build-app-server"),a=t("build-app-client");function c(e){if(JSON.parse(n.compileTimeConfig.APP_NAMES).includes(e))return e;console.log("unknown app name"),process.exit(1)}const[m,d]=[process.argv[2],process.argv[3]];"self"==m?i.build():"server-core"==m?s.build(!1):"watch"==m&&"server-core"==d?s.build(!0):"index-page"==m?r.build("index",!1):"watch"==m&&"index-page"==d?r.build("index",!0):"login-page"==m?r.build("login",!1):"watch"==m&&"login-page"==d?r.build("login",!0):m.endsWith("-client")?a.build(c(m.slice(0,-7)),!1):m.endsWith("-server")?l.build(c(m.slice(0,-7)),!1):"watch"==m&&d.endsWith("-client")?a.build(c(d.slice(0,-7)),!0):"watch"==m&&d.endsWith("-server")?l.build(c(d.slice(0,-7)),!0):"watch"==m&&d?(a.build(c(d),!0),l.build(c(d),!0)):"shutdown"==m?o.admin({type:"shutdown"}).then((()=>process.exit(1))):"reload-static"==m?o.admin({type:"reload-static",key:"www"==d||"login"==d?d:c(d)}).then((()=>process.exit(1))):"reload-server"==m?o.admin({type:"reload-server",app:c(d)}).then((()=>process.exit(1))):"expire-device"==m?o.admin({type:"expire-device",deviceId:parseInt(d)}).then((()=>process.exit(1))):(console.log("unknown command"),process.exit(1))}});