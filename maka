#!/usr/bin/env node
(e=>{const t={};!function o(s){return s in t||(t[s]={},e[s](t[s],o)),t[s]}(".")})({common:(e,t)=>{const o=require("fs"),s=require("chalk"),r=require("dayjs");e.projectDirectory="<PROJECTDIR>",e.nodePackage=JSON.parse(o.readFileSync("package.json","utf-8")),e.compileTimeConfig=JSON.parse(o.readFileSync("maka.config","utf-8")),e.logInfo=function(e,t){console.log(s`[{blueBright ${r().format("HH:mm:ss.SSS")}} ${e}] ${t}`)},e.logError=function(e,t){console.log(s`[{blueBright ${r().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`)},process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}))},"tools/admin":(e,t)=>{const o=require("net"),s=require("async-mutex"),r=t("common");const n=new s.Mutex;e.admin=async function(e){await n.runExclusive((async()=>await async function(e){const t=o.createConnection("/tmp/fps.socket").ref();return new Promise(((o,s)=>{const n=JSON.stringify(e);t.on("error",(e=>{"code"in e&&"ENOENT"==e.code?(r.logError("adm",`admin socket not open, command ${n} discarded`),o()):(r.logError("adm",`socket error: ${e.message}`),s())})),t.on("timeout",(()=>{r.logError("adm","socket timeout"),t.destroy(),s()})),t.once("data",(e=>{"ACK"==e.toString("utf-8")&&(r.logInfo("adm",`command ${n} acknowledged`),setTimeout((()=>{t.destroy(),o()}),0))})),t.write(n)}))}(e)))}},"tools/typescript":(e,t)=>{const o=require("typescript"),s=require("chalk"),r=t("common"),n={lib:["lib.es2020.d.ts"],outDir:"/vbuild",target:o.ScriptTarget.ES2020,module:o.ModuleKind.CommonJS,moduleResolution:o.ModuleResolutionKind.NodeJs,skipLibCheck:!0,noEmitOnError:!0,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function i(e){return{...n,sourceMap:e.sourceMap,esModuleInterop:e.importDefault,jsx:"jsx"in e?o.JsxEmit.ReactJSX:void 0,lib:"additionalLib"in e?[...n.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:n.lib}}function a({category:e,code:t,messageText:n,file:i,start:a}){if(6031!=t)if(6032==t)r.logInfo("tsc","retranspile");else{if(6194==t)return;{const r=(0,{[o.DiagnosticCategory.Warning]:s.red,[o.DiagnosticCategory.Error]:s.red,[o.DiagnosticCategory.Suggestion]:s.green,[o.DiagnosticCategory.Message]:s.cyan}[e])(`  TS${t} `);let l="";if(i){const{line:e,character:t}=o.getLineAndCharacterOfPosition(i,a);l=s`{yellow ${i.fileName}:${e+1}:${t+1}} `}let c=o.flattenDiagnosticMessageText(n,"\n");c.includes("\n")&&(c="\n"+c),console.log(r+l+c)}}}function l(e){const t=o.sys.readFile;o.sys.readFile=(o,s)=>{let n;if(n=e.readFile?e.readFile(o,(e=>t(e,s))):t(o,s),!o.endsWith(".d.ts"))for(const e in r.compileTimeConfig)n=n.split(e).join(r.compileTimeConfig[e]);return n}}function c(e){return(t,o)=>{if(t.endsWith(".js")){o.startsWith('"use strict"')&&(o=o.slice(o.indexOf("\n")+1)),o.startsWith("Object.defineProperty")&&(o=o.slice(o.indexOf("\n")+1)),o.startsWith("exports.")&&(o=o.slice(o.indexOf("\n")+1));const e=/\/\/#\s*sourceMappingURL/.exec(o);e?o=o.slice(0,e.index):o.endsWith("\n")||(o+="\n")}const s=e.findIndex((e=>e.name==t));s>=0?e.splice(s,1,{name:t,content:o}):e.push({name:t,content:o})}}function m(e,t){r.logInfo("tsc",s`once {yellow ${e.entry}}`),l(t);const n=i(e),m=[],p=function(e){const t=e.diagnostics.filter((e=>e.category==o.DiagnosticCategory.Error||o.DiagnosticCategory.Warning)).length,n=e.diagnostics.length-t;let i;i=0==n&&0==t?"no diagnostic":0!=n&&0==t?s`{yellow ${n}} infos`:0==n?s`{yellow ${t}} errors`:s`{yellow ${t}} errors and {yellow ${n}} infos`,(e.emitSkipped?r.logError:r.logInfo)("tsc",`completed with ${i}`);for(const t of e.diagnostics)a(t);return!e.emitSkipped}(o.createProgram([e.entry],n,o.createCompilerHost(n)).emit(void 0,c(m)));t.afterEmit({success:p,files:m})}function p(e,t){r.logInfo("tsc",s`watch {yellow ${e.entry}}`),l(t);const n=[];o.createWatchProgram(o.createWatchCompilerHost([e.entry],i(e),o.sys,((...e)=>{const s=o.createEmitAndSemanticDiagnosticsBuilderProgram(...e),r=s.emit;return s.emit=(e,o,...s)=>{const i=r(e,c(n),...s);return i.emitSkipped||t.afterEmit({files:n}),i},s}),a,a))}e.transpile=function(e,t){(e.watch?p:m)(e,t)}},"tools/mypack":(e,t)=>{const o=require("path"),s=require("chalk"),r=require("crypto-js"),n=require("filesize"),i=require("source-map"),a=require("terser"),l=t("common");e.pack=async function(e){if(e.lastResult?l.logInfo("mpk","repack"):l.logInfo("mpk",s`pack {yellow ${e.entry}}`),!e.files.some((t=>t.name==e.entry)))return l.logError("mpk","invalid entry"),{success:!1};const t=o.dirname(e.entry),c=e.sourceMap?e.files.filter((e=>e.name.endsWith(".js"))).map((({name:t,content:o})=>({name:t,jsContent:o,mapContent:e.files.find((e=>e.name==t+".map")).content}))):e.files.map((({name:e,content:t})=>({name:e,jsContent:t,mapContent:null})));let m=null;e.sourceMap&&(m=new i.SourceMapGenerator({file:e.output}));let p=3;const d=[];let u="app"==e.type?"((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n":"module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('.'); })({\n";for(let{name:s,jsContent:n,mapContent:a}of c){let f=o.relative(t,s);f.endsWith(".js")&&(f=f.slice(0,-3)),f.endsWith("index")&&(f=f.slice(0,-5)),0==f.length&&(f=".");let y=n;for(;;){const e=/require\("(?<moduleName>\.[\.\w\-\/]*)"\);/,r=e.exec(y);if(!r)break;const n=o.join(o.dirname(s),r.groups.moduleName);let i=c.some((e=>e.name==n))?n:c.some((e=>e.name==n+".js"))?n+".js":c.some((e=>e.name==n+"/index.js"))?n+"/index.js":null;if(null===i)return l.logError("mpk",`${s}: invalid module name ${r.groups.moduleName} at ${r.index}`),{success:!1};i=o.relative(t,i),i=i.slice(0,-3),i.endsWith("index")&&(i=i.slice(0,-5)),0==i.length&&(i="."),y=y.replace(e,`__myrequire__("${i}");`)}if(u+=`'${f}': (exports, __myrequire__) => {\n${y}}, `,d.push({fileName:s,moduleName:f,contentLength:y.length,hash:r.SHA256(y).toString()}),e.sourceMap){let e=null;(await new i.SourceMapConsumer(JSON.parse(a))).eachMapping((t=>{null===e&&(e=t.generatedLine),m.addMapping({source:o.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-e+p+1,column:t.generatedColumn}})}))}p+=y.split("\n").length}u+="})\n";let f=m?.toString();if(e.minify){const t=await a.minify(u,{sourceMap:!!e.sourceMap&&{content:f,filename:e.output,url:e.output+".map"}});u=t.code,f="object"==typeof t.map?JSON.stringify(t.map):t.map}const y=r.SHA256(u).toString();if(y===e.lastResult?.hash)l.logInfo("mpk","completed with no change");else if(e.lastResult||e.output&&l.logInfo("mpk",s`asset {yellow ${e.output}}`),l.logInfo("mpk",s`asset size {gray ${n(u.length)}} compression rate {gray ${(u.length/c.reduce(((e,t)=>e+t.jsContent.length),0)*100).toFixed(2)}%}`),e.printModules)if(e.lastResult){for(const t of d.filter((t=>!e.lastResult.modules.some((e=>e.fileName==t.fileName)))))console.log(s`  {gray +} ${t.fileName} {cyan ${t.moduleName}} {gray size ${n(t.contentLength)}}`);for(const[t]of d.map((t=>[t,e.lastResult.modules.find((e=>e.fileName==t.fileName))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(s`  {gray *} ${t.fileName} {cyan ${t.moduleName}} {gray size ${n(t.contentLength)}}`);for(const t of e.lastResult.modules.filter((e=>!d.some((t=>t.fileName==e.fileName)))))console.log(s`  {gray - removed ${t.fileName}} {cyan ${t.moduleName}}`)}else for(const{fileName:e,moduleName:t,contentLength:o}of d)console.log(s`   {gray +} ${e} {cyan ${t}} {gray size ${n(o)}}`);return{success:!0,jsContent:u,mapContent:f,hash:y,modules:d}}},"targets/self":(e,t)=>{const o=require("fs"),s=require("chalk"),r=t("common"),n=t("tools/typescript"),i=t("tools/mypack"),a={entry:"script/index.ts"},l={type:"app",entry:"/vbuild/index.js",files:[],output:"maka",minify:!0};e.build=function(){r.logInfo("mka",s`{yellow self}`),n.transpile(a,{afterEmit:async({success:e,files:t})=>{e||(r.logError("mka",s`{yellow self} failed at transpile`),process.exit(1));const n=await i.pack({...l,files:t});n.success||(r.logError("mka",s`{yellow self} failed at pack`),process.exit(1)),o.writeFileSync("maka","#!/usr/bin/env node\n"+n.jsContent),r.logInfo("mka","self completed successfully")}})}},"targets/public":(e,t)=>{const o=require("fs-extra"),s=require("rimraf"),r=t("common");e.build=function(){r.logInfo("mka","copy public"),o.copySync("src/public","dist/public",{overwrite:!0}),r.logInfo("mka","copy public completed")},e.cleanAll=function(){r.logInfo("mka","clean all"),s("dist",(e=>{e?r.logError("mka","clean failed: "+e.message):r.logInfo("mka","clean all completed")}))}},"targets/server-core":(e,t)=>{const o=require("child_process"),s=require("fs"),r=require("chalk"),n=t("common"),i=t("tools/admin"),a=t("tools/typescript"),l=t("tools/mypack"),c={entry:"src/server-core/index.ts",sourceMap:!0},m={type:"app",entry:"/vbuild/server-core/index.js",files:[],sourceMap:!0,output:"dist/home/server.js",printModules:!0,minify:!0};function p(){n.logInfo("mka",r`{yellow server-core}`),a.transpile(c,{afterEmit:async({success:e,files:t})=>{e||(n.logError("mka",r`{yellow server-core} failed at transpile typescript`),process.exit(1));const o=await l.pack({...m,files:t});o.success||(n.logError("mka",r`{yellow server-core} failed at pack`),process.exit(1)),await s.promises.mkdir("dist/home",{recursive:!0}),await Promise.all([s.promises.writeFile("dist/home/server.js",o.jsContent),s.promises.writeFile("dist/home/server.js.map",o.mapContent)]),n.logInfo("mka","server-core completed successfully")}})}let d=null;function u(){function e(){n.logInfo("mds","start server"),d=o.spawn("node",["dist/home/server.js"]),d.stdout.pipe(process.stdout),d.stderr.pipe(process.stderr),d.on("error",(e=>{n.logError("mds",`server process error ${e.message}`)})),d.on("exit",(e=>{(0==e?n.logInfo:n.logError)("mds",`server process exited with code ${e}`),d=null}))}null!=d?(d.once("exit",e),i.admin({type:"shutdown"})):e()}function f(){n.logInfo("mka",r`watch {yellow server-core}`),process.on("exit",(()=>d?.kill()));let e=null;a.transpile({...c,watch:!0},{afterEmit:async({files:t})=>{const o=await l.pack({...m,files:t,lastResult:e});o.success&&(await s.promises.mkdir("dist/home",{recursive:!0}),await Promise.all([s.promises.writeFile("dist/home/server.js",o.jsContent),s.promises.writeFile("dist/home/server.js.map",o.mapContent)]),o.hash!=e?.hash&&u(),e=o)}})}e.startOrRestartServer=u,e.build=function(e){(e?f:p)()}},"tools/sass":(e,t)=>{const o=require("chalk"),s=require("node-sass"),r=t("common");e.transpile=async function(e){return r.logInfo("css",o`{yellow ${e.file}}`),new Promise((t=>{s.render(e,((o,s)=>{o?(r.logError("css",`error at ${e.file}:${o.line}:${o.column}: ${o.message}`),t({success:!1})):(r.logInfo("css",`completed in ${s.stats.duration}ms`),t({success:!0,style:s.css.toString("utf-8")}))}))}))}},"targets/web-page":(e,t)=>{const o=require("fs"),s=require("chalk"),r=t("common"),n=t("tools/admin"),i=t("tools/typescript"),a=t("tools/sass"),l=(e,t)=>({entry:`src/pages/${e}.ts`,additionalLib:["dom"],watch:t}),c=e=>({file:`src/pages/${e}.sass`,outputStyle:"compressed"});async function m(e){r.logInfo("mka",s`{yellow ${e}-page}`),await o.promises.mkdir("dist/home",{recursive:!0});const t=l(e,!1);if(o.existsSync(t.entry)){const n=(await new Promise((o=>i.transpile(t,{afterEmit:({success:t,files:n})=>{t||(r.logError("mka",s`{yellow ${e}-page} failed at transpile typescript`),process.exit(1)),o(n)}}))))[0].content;await o.promises.writeFile(`dist/home/${e}.js`,n)}const m=c(e);if(o.existsSync(m.file)){const{success:t,style:n}=await a.transpile(m);t||(r.logError("mka",s`{yellow ${e}-page} failed at transpile stylesheet`),process.exit(1)),await o.promises.writeFile(`dist/home/${e}.css`,n)}r.logInfo("htm",s`copy {yellow ${e}.html}`),await o.promises.copyFile(`src/pages/${e}.html`,`dist/home/${e}.html`),r.logInfo("htm","copy completed"),await n.admin({type:"reload-static",key:e}),r.logInfo("mka",`build ${e}-page completed succesfully`)}async function p(e){r.logInfo("mka",s`watch {yellow ${e}-page}`),await o.promises.mkdir("dist/home",{recursive:!0});const t=l(e,!0);o.existsSync(t.entry)&&i.transpile(t,{afterEmit:async({files:t})=>{const s=t[0].content;await o.promises.writeFile(`dist/home/${e}.js`,s),n.admin({type:"reload-static",key:e}).catch((()=>{}))}});const m=c(e);o.existsSync(m.file)&&o.watchFile(m.file,{persistent:!1},(async(t,s)=>{if(t.mtime==s.mtime)return;const{success:r,style:i}=await a.transpile(c(e));r&&(o.writeFileSync(`dist/home/${e}.css`,i),n.admin({type:"reload-static",key:e}).catch((()=>{})))})),o.watchFile(`src/pages/${e}.html`,{persistent:!1},((t,i)=>{t.mtime!=i.mtime&&(r.logInfo("htm",s`copy {yellow ${e}.html}`),o.copyFileSync(`src/pages/${e}.html`,`dist/home/${e}.html`),r.logInfo("htm","copy completed"),n.admin({type:"reload-static",key:e}).catch((()=>{})))})),process.on("SIGINT",(()=>{o.unwatchFile(`src/pages/${e}.html`),o.existsSync(m.file)&&o.unwatchFile(m.file),process.exit(0)})),r.logInfo("mka","tsc watch and fs watch setup")}e.build=function(e,t){return(t?p:m)(e)}},"tools/codegen":(e,t)=>{const o=require("fs/promises"),s=require("chalk"),r=require("xml2json"),n=t("common"),i=["GET","POST","PUT","PATCH","DELETE"],a={GET:"get",POST:"post",PUT:"put",PATCH:"patch",DELETE:"del"},l=["id","number","string","boolean","date","time"],c={id:{pattern:"\\d+",validator:"validateId",tsType:"number"},number:{pattern:"\\d+",validator:"validateNumber",tsType:"number"},string:{pattern:".+",validator:"validateString",tsType:"string"},boolean:{pattern:"(true|false)",validator:"validateBoolean",tsType:"boolean"},date:{pattern:"\\d{6}",validator:"validateDate",tsType:"Dayjs"},time:{pattern:"\\d{12}",validator:"validateTime",tsType:"Dayjs"}};async function m(e){const t=await o.readFile(`src/${e}/api.xml`,"utf-8"),{version:s,api:n}=r.toJson(t,{object:!0})[`${e}-api`];return{version:s,definitions:n.map(((e,t)=>{const o=e.name;if(!o)throw new Error(`index ${t} api name is required`);const s=e.method;if(!i.includes(s))throw new Error(`api ${o} invalid method`);const r=e.path;if(!r)throw new Error(`api ${o} path is required`);if(!r.startsWith("/"))throw new Error(`api ${o} path should be absolute`);const n=function(e,t){const o=[];for(;;){const s=/\{(?<parameterName>[\w\_]+):(?<parameterType>\w+)\}/.exec(t);if(!s)break;if(10==o.filter((e=>"parameter"==e.type)).length)throw new Error(`api ${e} too many parameters`);const[r,n]=[s.groups.parameterName,s.groups.parameterType];if(!l.includes(n))throw new Error(`api ${e} parameter ${r} invalid type ${n}`);0!=s.index&&o.push({type:"normal",value:t.slice(0,s.index)}),o.push({type:"parameter",parameterName:r,parameterType:n}),t=t.slice(s.index+r.length+n.length+3)}return t.length&&o.push({type:"normal",value:t}),o}(o,r),[a,c]=[e["body-type"],e["body-name"]];if(["POST","PUT","PATCH"].includes(s)&&(!a||!c))throw new Error(`api ${o} body is required for ${s}`);return{namespace:e.namespace||"default",apiName:o,method:s,apiPath:n,bodyType:a,bodyName:c,returnType:e["return-type"]||"void"}}))}}e.generate=async function(e,t){return"server"==t?await async function(e){const t=`src/${e}/server/index.ts`;let r;n.logInfo("fcg",s`generate {yellow ${t}}`);try{r=await m(e)}catch(e){return n.logError("fcg",e.message),!1}const{version:i,definitions:a}=r;let p="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==a.length)return p+="// empty\n",await o.writeFile(t,p),n.logInfo("fcg","generate completed with empty"),!0;p+=`import { WebContext, ${l.filter((e=>a.some((t=>t.apiPath.some((t=>"parameter"==t.type&&t.parameterType==e)))))).map((e=>c[e].validator)).concat(a.some((e=>["PUT","POST","PATCH"].includes(e.method)))?["validateBody"]:[]).join(", ")} } from '../../shared/api-server';\n`,p+="import { MyError } from '../../shared/error';\n";for(const e of a.map((e=>e.namespace)).filter(((e,t,o)=>o.indexOf(e)==t)))p+=`import { ${a.filter((t=>t.namespace==e)).map((e=>e.apiName)).join(", ")} } from './${e}';\n`;p+="\n",p+="export async function dispatch(ctx: WebContext) {\n",p+="    let match: RegExpExecArray;\n",p+=`    if (!ctx.path.startsWith('/${e}/v${i}')) { throw new MyError('not-found', 'invalid invocation version'); }\n`,p+=`    const methodPath = \`\${ctx.method} \${ctx.path.slice(${e.length+i.length+3})}\`;\n`,p+="\n";for(const e of a){const{apiName:t,method:o,apiPath:s,bodyType:r,returnType:n}=e;p+=`    match = /^${o} `;for(const e of s)"normal"==e.type?p+=e.value.split("/").join("\\/"):p+=`(?<${e.parameterName}>${c[e.parameterType].pattern})`;p+="$/.exec(methodPath); if (match) {\n",p+="        ",n&&"void"!=n&&(p+="ctx.body = "),p+=`await ${t}(ctx.state`;for(const{parameterName:e,parameterType:t}of s.filter((e=>"parameter"==e.type)))p+=`, ${c[t].validator}('${e}', match.groups['${e}'])`;r&&(p+=", validateBody(ctx.request.body)"),p+=");\n","POST"==o?p+="        ctx.status = 201;\n":"DELETE"==o&&(p+="        ctx.status = 204;\n"),p+="        return;\n",p+="    }\n"}return p+="\n",p+="    throw new MyError('not-found', 'invalid invocation');\n",p+="}\n",await o.writeFile(t,p),n.logInfo("fcg","generate completed"),!0}(e):await async function(e){const t=`src/${e}/client/api.ts`;let r;n.logInfo("fcg",s`generate {yellow ${t}}`);try{r=await m(e)}catch(e){return n.logError("fcg",e.message),!1}const{version:l,definitions:p}=r;let d="// ATTENTION:\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n\n";if(0==p.length)return d+="// empty\n",await o.writeFile(t,d),n.logInfo("fcg","generate completed with empty"),!0;p.some((e=>e.apiPath.some((e=>"parameter"==e.type&&["date","time"].includes(e.parameterType)))))&&(d+="import type { Dayjs } from 'dayjs';\n"),d+=`import { ${i.filter((e=>p.some((t=>t.method==e)))).map((e=>a[e])).join(", ")} } from '../../shared/api-client';\n`,d+=`import type { ${p.filter((e=>!!e.bodyType)).map((e=>e.bodyType)).filter(((e,t,o)=>o.indexOf(e)==t)).join(",")} } from '../api';\n`,d+="\n";for(const t of p){const{apiName:o,method:s,apiPath:r,bodyType:n,bodyName:i,returnType:m}=t;d+=`export const ${o} = (`;for(const{parameterName:e,parameterType:t}of r.filter((e=>"parameter"==e.type)))d.endsWith("(")||(d+=", "),d+=`${e}: ${c[t].tsType}`;n&&(d.endsWith("(")||(d+=", "),d+=`${i}: ${n}`),d+=`): Promise<${m}> => ${a[s]}(\`/${e}/v${l}`;for(const e of r)"normal"==e.type?d+=e.value:"date"==e.parameterType?d+=`\${${e.parameterName}.format('YYYYMMDD')}`:"time"==e.parameterType?d+=`\${${e.parameterName}.format('YYYYMMDDHHmmdd')}`:d+=`\${${e.parameterName}}`;d+="`",n&&(d+=`, ${i}`),d+=");\n"}return await o.writeFile(t,d),n.logInfo("fcg","generate completed"),!0}(e)}},"targets/app-server":(e,t)=>{const o=require("fs"),s=require("chalk"),r=t("common"),n=t("tools/admin"),i=t("tools/codegen"),a=t("tools/typescript"),l=t("tools/mypack"),c=(e,t)=>({entry:`src/${e}/server/index.ts`,sourceMap:!0,watch:t}),m=(e,t,o)=>({type:"lib",entry:`/vbuild/${e}/server/index.js`,files:t,sourceMap:!0,output:`dist/${e}/server.js`,printModules:!0,minify:!0,lastResult:o});e.build=async function(e,t){t?function(e){r.logInfo("mka",s`watch {yellow ${e}-server}`),o.mkdirSync(`dist/${e}`,{recursive:!0}),o.watchFile(`src/${e}/api.xml`,{persistent:!1},((t,o)=>{t.mtime!=o.mtime&&i.generate(e,"server")})),process.on("SIGINT",(()=>{o.unwatchFile(`src/${e}/api.xml`),process.exit(0)}));let t=null;a.transpile(c(e,!0),{afterEmit:async({files:s})=>{const r=await l.pack(m(e,s,t));r.success&&(await Promise.all([o.promises.writeFile(`dist/${e}/server.js`,r.jsContent),o.promises.writeFile(`dist/${e}/server.js.map`,r.mapContent)]),r.hash!=t?.hash&&await n.admin({type:"reload-server",app:e}),t=r)}}),i.generate(e,"server")}(e):await async function(e){r.logInfo("mka",s`{yellow ${e}-server}`),await o.promises.mkdir(`dist/${e}`,{recursive:!0}),await i.generate(e,"server")||(r.logError("mka",s`{yellow ${e}-server} failed at code generation`),process.exit(1)),a.transpile(c(e,!1),{afterEmit:async({success:t,files:i})=>{t||(r.logError("mka",s`{yellow ${e}-server} failed at transpile typescript`),process.exit(1));const a=await l.pack(m(e,i));a.success||(r.logError("mka",s`{yellow ${e}-server} failed at pack`),process.exit(1)),await Promise.all([o.promises.writeFile(`dist/${e}/server.js`,a.jsContent),o.promises.writeFile(`dist/${e}/server.js.map`,a.mapContent)]),await n.admin({type:"reload-server",app:e}),r.logInfo("mka",`${e}-server completed successfully`)}})}(e)}},"tools/webpack":(e,t)=>{const o=require("chalk"),s=require("filesize"),r=require("webpack"),n=t("common");function i(e,t){n.logInfo("wpb",o`{yellow ${e.assets.length}} asset in {yellow ${e.time}ms}, hash {yellow ${e.hash}}`);for(const t of e.errors)console.log(t);for(const t of e.warnings)console.log(t.message??t);const r=e.chunks.reduce(((e,t)=>(e.push(...t.modules),e)),[]);if(null==t){for(let t=0;t<e.assets.length;++t){const r=e.assets[t];console.log(o`  {gray asset#}${t} {yellow ${r.name}}`+o` {gray size} {yellow ${s(r.size)}} {gray chunks} [${r.chunks.join(", ")}]`)}for(const t of e.chunks){console.log(o`  {gray chunk#}${t.id} {yellow ${t.names.join(",")}} {gray size} {yellow ${s(t.size)}}`);const e=[];for(let r=0;r<t.modules.length;++r){const n=t.modules[r];n.name.startsWith("external")?e.push(n.name.slice(10,-1)):console.log(o`    {gray #${r}} ${n.name} {gray size ${s(n.size)}}`)}for(let t=0;t<Math.ceil(e.length/5);++t)0==t?console.log(o`    {gray +} ${e.length} {gray external modules} ${e.filter(((e,t)=>0==Math.floor(t/5))).join(", ")}`):console.log(o`                        + ${e.filter(((e,o)=>Math.floor(o/5)==t)).join(", ")}`)}}else{const n=t.chunks.reduce(((e,t)=>(e.push(...t.modules),e)),[]),i=r.filter((e=>!n.some((t=>t.name===e.name)))),a=n.filter((e=>!r.some((t=>t.name===e.name))));for(let t=0;t<e.assets.length;++t){const r=e.assets[t];console.log(o`  {gray asset#}${t} {yellow ${r.name}}`+o` {gray size} {yellow ${s(r.size)}} {gray chunks} [${r.chunks.join(", ")}]`+(t==e.assets.length-1&&0==i.length&&0==a.length?o`{gray [no module list change]}`:""))}for(const e of i)console.log(o`  + ${e.name} {gray size ${s(e.size)}}`);for(const e of a)console.log(o`  - {gray removed ${e.name}}`)}return r}e.bundleOnce=async function(e,t,s){n.logInfo("wpb",o`once {yellow ${e.entry}}`);const a=!("printStat"in e)||e.printStat;delete e.printStat,r(e).run(((e,o)=>{if(e)return n.logError("wpb","critical error: "+e.message),void t(null);const r=o?.toJson();a?i(r,null):n.logInfo("wpb","completed with no error"),s(r)}))},e.bundleWatch=async function(e,t){n.logInfo("wpb",o`watch {yellow ${e.entry}}`);let s=null;r({...e,watch:!0},((e,o)=>{if(e)return void n.logError("wpb","critical error: "+e.message);const r=o?.toJson();if(r.hash==s.hash)return s=r,void n.logInfo("wpb","completed with no change");i(r,s),s=r,t(r)}))}},"targets/app-client":(e,t)=>{const o=require("fs"),s=require("path"),r=require("chalk"),n=t("tools/admin"),i=t("common"),a=t("tools/typescript"),l=t("tools/webpack"),c=require("webpack-bundle-analyzer"),m=require("antd-dayjs-webpack-plugin"),p=require("terser-webpack-plugin");async function d(e){i.logInfo("mka",r`{yellow ${e}-client}`),await o.promises.mkdir(`dist/${e}`,{recursive:!0}),i.logInfo("htm",r`copy {yellow src/${e}/index.html}`),await o.promises.copyFile(`src/${e}/index.html`,`dist/${e}/index.html`),i.logInfo("htm","copy completed"),a.transpile((e=>({entry:`src/${e}/client/index.tsx`,sourceMap:!0,additionalLib:["dom"],jsx:!0,importDefault:!0}))(e),{afterEmit:async({success:t,files:a})=>{t||(i.logError("mka",r`{yellow ${e}-client} failed at transpile typescript`),process.exit(1)),await o.promises.writeFile(`build/${e}-client/index.js`,a.find((e=>"/vbuild/index.js"==e.name)).content),await o.promises.writeFile(`build/${e}-client/index.js.map`,a.find((e=>"/vbuild/index.js.map"==e.name)).content),l.bundleOnce((e=>({mode:"production",entry:s.join(i.projectDirectory,`build/${e}-client/index.js`),output:{filename:"client.js",path:s.join(i.projectDirectory,`dist/${e}`)},devtool:"source-map",optimization:{splitChunks:{cacheGroups:{antd:{test:/node_modules\/(antd|rc)/,priority:20,chunks:"all",filename:"client-ant.js"},antdIcon:{test:/node_modules\/\@ant-design/,priority:20,chunks:"all",filename:"client-anticon.js"},reactDom:{test:/node_modules\/react-dom/,priority:20,chunks:"all",filename:"client-react-dom.js"},vender:{test:/node_modules/,priority:10,chunks:"all",filename:"client-other.js"}}},minimizer:[new p({terserOptions:{format:{comments:!1}},extractComments:!1})]},plugins:[new c.BundleAnalyzerPlugin({analyzerMode:"static",openAnalyzer:!1,reportFilename:"stat.html"}),new m]}))(e),(()=>{i.logError("mka",r`{yellow ${e}-client} failed at bundle`),process.exit(1)}),(async()=>{await n.admin({type:"reload-static",key:e}),i.logInfo("mka",`${e}-client completed successfully`)}))}})}e.build=async function(e,t){t||await d(e)}},".":(e,t)=>{const o=t("tools/admin"),s=t("targets/self"),r=t("targets/public"),n=t("targets/server-core"),i=t("targets/web-page"),a=t("targets/app-server"),l=t("targets/app-client");function c(e){if(["home","user","404","418"].includes(e))return e;console.log("unknown page name"),process.exit(1)}function m(e){if(["cost","collect","ak"].includes(e))return e;console.log("unknown app name"),process.exit(1)}const[p,d]=[process.argv[2],process.argv[3]];"self"==p?s.build():"clean"==p?r.cleanAll():"public"==p?r.build():"server-core"==p?n.build(!1):"watch"==p&&"server-core"==d?n.build(!0):p.endsWith("-page")?i.build(c(p.slice(0,-5)),!1):"watch"==p&&d.endsWith("-page")?i.build(c(d.slice(0,-5)),!0):p.endsWith("-client")?l.build(m(p.slice(0,-7)),!1):"watch"==p&&d.endsWith("-client")?l.build(m(d.slice(0,-7)),!0):p.endsWith("-server")?a.build(m(p.slice(0,-7)),!1):"watch"==p&&d.endsWith("-server")?a.build(m(d.slice(0,-7)),!0):"watch"==p&&d.endsWith("-both")?(l.build(m(d.slice(0,-5)),!0),a.build(m(d.slice(0,-5)),!0)):"all"==p?(r.build(),n.build(!1),i.build("www",!1),i.build("user",!1),i.build("404",!1),i.build("418",!1),a.build("cost",!1),l.build("ak",!1)):"shutdown"==p?o.admin({type:"shutdown"}).then((()=>process.exit(1))):"reload-static"==p?o.admin({type:"reload-static",key:"www"==d||"login"==d?d:m(d)}).then((()=>process.exit(1))):"reload-server"==p?o.admin({type:"reload-server",app:m(d)}).then((()=>process.exit(1))):"expire-device"==p?o.admin({type:"expire-device",deviceId:parseInt(d)}).then((()=>process.exit(1))):(console.log("unknown command"),process.exit(1))}});